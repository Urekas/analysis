<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Tactical Board - v123 Click Bug Fixed</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        @font-face {
            font-family: 'S-CoreDream-6Bold';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-6Bold.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --accent: #e74c3c;
            --text: #eee;
            --sidebar-width: 280px;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: var(--text);
            font-family: 'S-CoreDream-6Bold', sans-serif;
            overflow: hidden;
            display: flex;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        input,
        textarea,
        [contenteditable] {
            user-select: auto;
            -webkit-user-select: auto;
        }

        /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 80px;
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 50;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar::-webkit-scrollbar {
            width: 0;
        }

        .tool-btn {
            width: 50px;
            height: 50px;
            margin-bottom: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: transparent;
            color: #aaa;
            font-size: 1.4rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .tool-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
        }

        .tool-btn::after {
            content: attr(data-shortcut);
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 0.6rem;
            opacity: 0.5;
            font-family: monospace;
        }

        .divider {
            width: 40px;
            height: 1px;
            background: #444;
            margin: 10px 0;
            flex-shrink: 0;
        }

        /* ì¤‘ì•™ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: hidden;
            position: relative;
        }

        .media-container {
            flex: 1;
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #000;
        }

        #youtube-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1;
            pointer-events: none;
        }

        #local-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1;
            object-fit: contain;
        }

        .canvas-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }

        /* ìŠ¤í¬ëŸ¬ë²„ */
        .scrubber-area {
            height: 50px;
            width: 100%;
            background: #111;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            box-sizing: border-box;
            border-top: 1px solid #333;
            z-index: 10;
            flex-shrink: 0;
        }

        .scrubber-input {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            background: #444;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 15px;
        }

        .scrubber-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #e67e22;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.1s;
        }

        .scrubber-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 0 5px;
            padding: 5px;
            transition: 0.2s;
        }

        .scrubber-btn:hover {
            color: var(--accent);
        }

        .version-display {
            position: absolute;
            bottom: 5px;
            right: 15px;
            color: #777;
            font-size: 0.8rem;
            z-index: 100;
        }

        .time-display {
            font-family: monospace;
            color: #ccc;
            font-size: 0.9rem;
            min-width: 100px;
            text-align: center;
        }

        /* í•˜ë‹¨ íŒ¨ë„ */
        .bottom-panel {
            height: 70px;
            width: 100%;
            background: var(--panel-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #444;
            z-index: 20;
            flex-shrink: 0;
        }

        .control-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
            position: relative;
        }

        .color-dot.selected {
            border-color: white;
            box-shadow: 0 0 0 2px var(--bg-color);
            transform: scale(1.1);
        }

        .c-white {
            background: #ffffff;
        }

        .c-red {
            background: #e63946;
        }

        .c-yellow {
            background: #ffbe0b;
        }

        .c-blue {
            background: #3a86ff;
        }

        .c-green {
            background: #2ecc71;
        }

        .c-black {
            background: #000000;
            border: 1px solid #555;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 80px;
            height: 5px;
            background: #555;
            border-radius: 5px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .toggle-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #333;
            color: #aaa;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .toggle-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        #status-msg {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 1rem;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            pointer-events: none;
            display: none;
        }

        #guide-msg {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        /* ìš°ì¸¡ ì‚¬ì´ë“œë°” */
        .scene-sidebar {
            width: var(--sidebar-width);
            background: #222;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
            padding: 0;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 30;
            transition: width 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
        }

        .scene-sidebar.closed {
            width: 0;
        }

        .sidebar-toggle-area {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 40;
        }

        .scene-toggle-btn {
            width: 25px;
            height: 50px;
            background: #222;
            border: 1px solid #444;
            border-right: none;
            border-radius: 10px 0 0 10px;
            color: #aaa;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #444;
            background: #2d2d2d;
            min-width: 100%;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 0;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'S-CoreDream-6Bold';
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
            background: #333;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding: 15px;
            flex-direction: column;
            gap: 10px;
            box-sizing: border-box;
        }

        .tab-content.active {
            display: flex;
        }

        /* ë°ì´í„° ëª©ë¡ */
        .data-group {
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
        }

        .data-group-header {
            background: #3a3a3a;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            font-weight: bold;
            color: #fff;
            border: 1px solid #444;
        }

        .group-count {
            background: var(--accent);
            color: #fff;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: auto;
        }

        .data-group-content {
            display: none;
            flex-direction: column;
            gap: 5px;
            padding-top: 5px;
            overflow: hidden;
        }

        .data-item {
            background: #2a2a2a;
            padding: 10px 12px;
            border-radius: 0 6px 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #555;
            cursor: pointer;
        }

        .data-item:hover {
            border-left-color: var(--accent);
            background: #333;
        }

        .scene-item {
            background: #333;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            border: 1px solid transparent;
        }

        .scene-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
            flex: 1;
            cursor: pointer;
            padding: 0 5px;
        }

        .scene-time {
            color: var(--accent);
            font-size: 0.8rem;
            font-family: monospace;
        }

        .scene-del-btn {
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
        }

        /* ë§¤ì¹˜ ì„¼í„° ê³„ì¸µ UI */
        .comp-card {
            background: #333;
            padding: 18px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
            transition: 0.2s;
        }

        .comp-card:hover {
            border-color: var(--accent);
            background: #3d3d3d;
            transform: translateX(5px);
        }

        .match-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border-left: 4px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            transition: 0.2s;
        }

        .match-card:hover {
            background: #333;
        }

        .top-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .top-btn {
            background: rgba(0, 0, 0, 0.6);
            color: #ccc;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'S-CoreDream-6Bold';
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            /* ëª¨ë‹¬ ë‚´ìš©ì´ ë„˜ì¹  ë•Œ ì˜¤ë²„ë ˆì´ ìì²´ë„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-box {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            border: 1px solid #444;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.8rem;
            cursor: pointer;
        }

        .modal-header {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--accent);
            font-weight: bold;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #444;
            margin-bottom: 15px;
            gap: 10px;
        }

        .m-tab {
            padding: 8px 15px;
            cursor: pointer;
            color: #888;
            border-bottom: 2px solid transparent;
        }

        .m-tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        .m-content {
            display: none;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #ddd;
        }

        .m-content.active {
            display: block;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .shortcut-input {
            background: #111;
            color: var(--accent);
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 5px;
            width: 120px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .finish-btn {
            color: #2ecc71;
            border-color: #2ecc71;
            display: none;
        }

        .finish-btn.show {
            display: flex;
        }

        .admin-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-input {
            background: #111;
            color: #fff;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 8px;
        }

        .btn-submit {
            background: var(--accent);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-submit:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* ëª©ë¡ ê´€ë¦¬ íƒ­ ë²„íŠ¼ CSS */
        .manage-group {
            margin-bottom: 10px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #444;
            overflow: hidden;
        }

        .manage-group-header {
            background: #3a3a3a;
            padding: 10px 15px;
            font-weight: bold;
            color: var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manage-match-item {
            padding: 10px 15px;
            border-top: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
        }

        .manage-match-item:hover {
            background: #3d3d3d;
        }

        .manage-btn {
            background: #444;
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 4px;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .manage-btn:hover {
            background: #555;
        }

        .manage-btn.edit {
            background: #3498db;
        }

        .manage-btn.del {
            background: #e74c3c;
        }

        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .mobile-only {
                display: inline-block;
            }

            .sidebar,
            .bottom-panel {
                display: none !important;
            }

            .workspace {
                flex: none;
                height: 45vh;
            }

            .scene-sidebar {
                width: 100%;
                flex: none;
                height: 55vh;
                border-left: none;
                border-top: 2px solid #333;
                transition: height 0.3s ease;
                z-index: 1000;
                overflow-y: auto;
            }

            .scene-sidebar.closed {
                display: none !important;
            }

            .sidebar-toggle-area {
                position: absolute;
                right: 0px;
                bottom: -25px;
                /* Adjusting for portrait mode bottom toggle */
                top: auto;
                transform: none;
                z-index: 101;
                width: 50px;
                height: 25px;
                background: #2a2a2a;
                border: 1px solid #444;
                border-top: none;
                display: flex !important;
                align-items: center;
                justify-content: center;
                border-radius: 0 0 5px 5px;
            }

            .scene-toggle-btn i {
                transform: rotate(90deg);
            }

            body:has(.scene-sidebar.closed) .sidebar-toggle-area .scene-toggle-btn i {
                transform: rotate(-90deg);
            }

            .top-menu {
                top: 10px;
                right: 10px;
                gap: 5px;
            }

            /* ëª¨ë°”ì¼ ì„¸ë¡œ: ìŠ¤í¬ëŸ¬ë²„ë¥¼ í™”ë©´ í•˜ë‹¨ ê³ ì • ì˜¤ë²„ë ˆì´ë¡œ ì „í™˜ */
            #videoScrubber {
                position: fixed !important;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 56px;
                z-index: 500;
                background: rgba(10, 10, 10, 0.88) !important;
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
                border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
                /* ê¸°ë³¸ì€ ìˆ¨ê¹€: ì•„ë˜ë¡œ ë‚´ë ¤ê°€ ìˆìŒ */
                transform: translateY(100%);
                opacity: 0;
                transition: transform 0.25s ease, opacity 0.25s ease;
                display: flex !important;
                /* í•­ìƒ flexë¡œ ìœ ì§€, visibilityë¡œ ì œì–´ */
                visibility: hidden;
            }

            /* í„°ì¹˜ ì‹œ í† ê¸€ë˜ëŠ” í´ë˜ìŠ¤ */
            #videoScrubber.scrubber-visible {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }
        }

        @media (max-width: 950px) and (orientation: landscape) {
            body {
                flex-direction: row;
                overflow: hidden;
            }

            .mobile-only {
                display: inline-block;
            }

            .sidebar,
            .bottom-panel {
                display: none !important;
            }

            .workspace {
                flex: 1;
                height: 100vh;
                position: relative;
            }

            /* ê°€ë¡œ ëª¨ë“œì—ì„œ ë°ì´í„° íŒ¨ë„ ì ‘ì—ˆë‹¤ íˆë‹¤ í•  ìˆ˜ ìˆê²Œ ì²˜ë¦¬ */
            .scene-sidebar {
                width: 320px;
                height: 100vh;
                position: absolute;
                right: 0;
                top: 0;
                transition: transform 0.3s ease;
                z-index: 1000;
                border-left: 1px solid #333;
            }

            .scene-sidebar.closed {
                width: 320px !important;
                transform: translateX(100%);
            }

            /* íŒ¨ë„ ì—´ê³  ë‹«ëŠ” í† ê¸€ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
            .sidebar-toggle-area {
                position: absolute;
                right: 320px;
                top: 50%;
                transform: translateY(-50%);
                z-index: 101;
                width: 25px;
                height: 50px;
                background: #2a2a2a;
                border: 1px solid #444;
                border-right: none;
                display: flex !important;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                border-radius: 5px 0 0 5px;
                transition: right 0.3s ease;
            }

            body:has(.scene-sidebar.closed) .sidebar-toggle-area {
                right: 0px;
            }

            /* ê°€ë¡œëª¨ë“œ: ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ë¥¼ ìƒë‹¨ ì •ë ¬ + ìŠ¤í¬ë¡¤ í—ˆìš© */
            .modal-overlay {
                align-items: flex-start;
                padding: 10px 0;
            }

            /* ê°€ë¡œëª¨ë“œ: ëª¨ë‹¬ ë°•ìŠ¤ ë†’ì´ë¥¼ í™”ë©´ì— ë§ê²Œ ì¤„ì´ê³  ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
            .modal-box {
                max-height: none;
                width: 94%;
                margin: auto;
            }

            /* ê°€ë¡œëª¨ë“œ: ë§¤ì¹˜ ì„¼í„° ë‚´ ëª©ë¡ ì˜ì—­ ë†’ì´ ì œí•œ ì¡°ì • */
            #manage-list-container {
                max-height: 200px !important;
            }

            /* ê°€ë¡œëª¨ë“œ: m-content(íƒ­ ë³¸ë¬¸) ì˜ì—­ë„ ìŠ¤í¬ë¡¤ í—ˆìš© */
            .m-content.active {
                max-height: 55vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>

<body>
    <!-- ğŸš€ ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ë¶€ -->
    <script>
        let canvas, ytPlayer, broadcastShadow;
        let isYtReady = false, currentMediaType = 'none', eventList = [], timeOffset = 0.0;
        let isDrawing = false, startPoint = null, activeObj = null, pointArray = [], activePoints = [], activeLines = [], componentArray = [];
        let currentMode = 'select', currentColor = '#ffffff', currentSize = 40, currentOpacity = 0.2, isSpotMode = false, isPalmRejection = false, isDashed = false;
        let isDraggingSlider = false, githubMatchesData = [], isVideoInteractive = false;

        window.addEventListener('DOMContentLoaded', () => {
            if (typeof fabric !== 'undefined') {
                broadcastShadow = new fabric.Shadow({ color: 'rgba(0,0,0,0.8)', blur: 8, offsetX: 2, offsetY: 2 });
                fabric.Object.prototype.set({
                    transparentCorners: false,
                    cornerColor: '#fff',
                    cornerStrokeColor: '#000',
                    cornerStyle: 'circle',
                    shadow: broadcastShadow
                });
            }
        });
    </script>

    <div class="sidebar">
        <!-- ê¹ƒí—ˆë¸Œ ë§¤ì¹˜ ì„¼í„° ë²„íŠ¼ -->
        <button class="tool-btn" id="btn-github-center" style="background:#333; color:white; border:none;"
            onclick="openMatchCenter()" title="Match Center"><i class="fa-brands fa-github"></i></button>
        <div class="divider"></div>
        <label for="imgInput" class="tool-btn" style="background:#2ecc71; color:white; border:none;" title="ì‚¬ì§„ ì—´ê¸°"><i
                class="fa-solid fa-image"></i></label>
        <input type="file" id="imgInput" style="display:none;" accept="image/*">
        <label for="videoInput" class="tool-btn" style="background:#3498db; color:white; border:none;"
            title="íŒŒì¼ ì˜ìƒ ì—´ê¸°"><i class="fa-solid fa-file-video"></i></label>
        <input type="file" id="videoInput" style="display:none;" accept="video/*">
        <label for="dataInput" class="tool-btn" style="background:#9b59b6; color:white; border:none;" title="ë°ì´í„° ì—´ê¸°"><i
                class="fa-solid fa-file-lines"></i></label>
        <input type="file" id="dataInput" style="display:none;" accept=".xml,.csv">
        <button class="tool-btn" style="background:#e63946; color:white; border:none;" onclick="loadYoutubePrompt()"
            title="ìœ íŠœë¸Œ ì£¼ì†Œ"><i class="fa-brands fa-youtube"></i></button>
        <div class="divider"></div>
        <!-- ì˜ìƒ ì¡°ì‘ ëª¨ë“œ ë²„íŠ¼ -->
        <button class="tool-btn" id="btn-video-touch" onclick="toggleVideoInteraction()"
            title="ì˜ìƒ ì¡°ì‘ ëª¨ë“œ (ìœ íŠœë¸Œ ì¶”ì²œì˜ìƒ ë„ê¸°)"><i class="fa-solid fa-hand-pointer"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" onclick="togglePalm()" id="btn-palm" title="í„°ì¹˜ ë°©ì§€"><i
                class="fa-solid fa-hand-pointer"></i></button>
        <div class="divider"></div>
        <button class="tool-btn active" id="btn-select" onclick="setMode('select')" title="ì„ íƒ"><i
                class="fa-solid fa-arrow-pointer"></i></button>
        <button class="tool-btn" id="btn-drawPlayerTag" onclick="setMode('drawPlayerTag')" title="ì„ ìˆ˜ íƒœê·¸"><i
                class="fa-solid fa-tag"></i></button>
        <button class="tool-btn" id="btn-drawPen" onclick="setMode('drawPen')" title="íœ"><i
                class="fa-solid fa-pen"></i></button>
        <button class="tool-btn" id="btn-addText" onclick="addText()" title="í…ìŠ¤íŠ¸"><i
                class="fa-solid fa-font"></i></button>
        <button class="tool-btn" id="btn-drawSpot" onclick="setMode('drawSpot')" title="ìŠ¤íŒŸ"><i
                class="fa-regular fa-circle"></i></button>
        <button class="tool-btn" id="btn-drawPolyline" onclick="setMode('drawPolyline')" title="ë‹¤ì¤‘ ì„ "><i
                class="fa-solid fa-share-nodes"></i></button>
        <button class="tool-btn" id="btn-drawArrow" onclick="setMode('drawArrow')" title="í™”ì‚´í‘œ"><i
                class="fa-solid fa-arrow-right-long"></i></button>
        <button class="tool-btn" id="btn-drawCurve" onclick="setMode('drawCurve')" title="ê³¡ì„ "><i
                class="fa-solid fa-arrow-turn-up"></i></button>
        <button class="tool-btn" id="btn-drawPolygon" onclick="setMode('drawPolygon')" title="ë‹¤ê°í˜•"><i
                class="fa-solid fa-draw-polygon"></i></button>
        <button class="tool-btn finish-btn" id="btn-finish" onclick="completeDrawing()"><i
                class="fa-solid fa-check"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" style="color:#f1c40f;" onclick="saveScene()" title="ì¥ë©´ ì €ì¥"><i
                class="fa-solid fa-floppy-disk"></i></button>
        <button class="tool-btn" id="btn-record" style="color:#e67e22;" onclick="startCleanRecording()" title="ì¶”ì¶œ"><i
                class="fa-solid fa-clapperboard"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" id="btn-deleteObj" style="color:#e74c3c;" onclick="deleteObject()"
            title="ì‚¬ìš©ì ì„ íƒ ì§€ìš°ê¸°"><i class="fa-solid fa-trash"></i></button>
        <button class="tool-btn" id="btn-clearAll" style="color:#ff6b6b;" onclick="clearAll()" title="ì „ì²´ ì§€ìš°ê¸°"><i
                class="fa-solid fa-eraser"></i></button>
    </div>

    <div class="workspace">
        <div class="sidebar-toggle-area" onclick="toggleSceneSidebar()">
            <div class="scene-toggle-btn"><i class="fa-solid fa-chevron-right" id="sceneToggleIcon"></i></div>
        </div>
        <div class="top-menu">
            <button class="top-btn mobile-only" onclick="openMatchCenter()" style="color:var(--accent);"
                title="GitHub ë§¤ì¹˜ ì„¼í„°"><i class="fa-brands fa-github"></i></button>
            <label for="videoInputMobile" class="top-btn mobile-only" style="color:#3498db; cursor:pointer;"
                title="ë¡œì»¬ ì˜ìƒ ì—´ê¸°"><i class="fa-solid fa-file-video"></i></label>
            <input type="file" id="videoInputMobile" style="display:none;" accept="video/*">
            <label for="dataInputMobile" class="top-btn mobile-only" style="color:#9b59b6; cursor:pointer;"
                title="ë°ì´í„°(XML) ì—´ê¸°"><i class="fa-solid fa-file-lines"></i></label>
            <input type="file" id="dataInputMobile" style="display:none;" accept=".xml,.csv">
            <button class="top-btn" onclick="toggleLang()">KR | EN</button>
            <button class="top-btn" onclick="toggleHelp()"><i class="fa-solid fa-gear"></i> ì„¤ì •</button>
        </div>
        <div id="status-msg">ë¯¸ë””ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</div>
        <div id="guide-msg">ë”ë¸”í´ë¦­í•˜ì—¬ ë„í˜• ì™„ì„±</div>
        <div class="media-container" id="mediaContainer">
            <div id="youtube-player"></div>
            <video id="local-video" playsinline crossOrigin="anonymous"></video>
            <div class="canvas-wrapper" id="canvasWrapper"><canvas id="c"></canvas></div>
            <div class="version-display">v124</div>
        </div>
        <div class="scrubber-area" id="videoScrubber">
            <button class="scrubber-btn" onclick="videoControl('rewind')" title="-5ì´ˆ (â†)"><i
                    class="fa-solid fa-backward-step"></i></button>
            <button class="scrubber-btn" onclick="videoControl('toggle')" id="btn-play-scrubber"
                title="ì¬ìƒ/ì •ì§€ (Space)"><i class="fa-solid fa-play"></i></button>
            <button class="scrubber-btn" onclick="videoControl('forward')" title="+5ì´ˆ (â†’)"><i
                    class="fa-solid fa-forward-step"></i></button>
            <div class="time-display" id="timeDisplay" style="margin-left: 10px; min-width: 80px; text-align: center;">
                0:00 / 0:00</div>
            <input type="range" class="scrubber-input" id="timeSlider" min="0" max="100" value="0" step="0.1">
        </div>
        <div class="bottom-panel">
            <div class="control-bar">
                <div style="display:flex; gap:8px;">
                    <div class="color-dot c-white selected" onclick="setColor('#ffffff', this)"></div>
                    <div class="color-dot c-red" onclick="setColor('#e63946', this)"></div>
                    <div class="color-dot c-yellow" onclick="setColor('#ffbe0b', this)"></div>
                    <div class="color-dot c-blue" onclick="setColor('#3a86ff', this)"></div>
                    <div class="color-dot c-green" onclick="setColor('#2ecc71', this)"></div>
                    <div class="color-dot c-black" onclick="setColor('#000000', this)"></div>
                </div>
                <div style="width:1px; height:30px; background:#555;"></div>
                <div class="slider-group" title="ì„  ë‘ê»˜"><i class="fa-solid fa-lines-leaning"></i><input type="range"
                        id="sizeSlider" min="10" max="100" value="40"></div>
                <div class="slider-group" title="íˆ¬ëª…ë„"><i class="fa-solid fa-circle-half-stroke"></i><input type="range"
                        id="opacitySlider" min="10" max="100" value="20"></div>
                <div style="width:1px; height:30px; background:#555;"></div>
                <div class="slider-group" title="ì¬ìƒ ì†ë„"><i class="fa-solid fa-gauge-high"></i><input type="range"
                        id="speedSlider" min="0.25" max="2" step="0.25" value="1"><span id="speedVal"
                        style="font-size:0.8rem; width:35px;">1.0x</span></div>
            </div>
        </div>
    </div>

    <div class="scene-sidebar" id="sceneSidebar">
        <div class="sidebar-tabs">
            <button class="tab-btn active" id="tab-btn-scenes" onclick="openTab('tab-scenes')">ì¥ë©´</button>
            <button class="tab-btn" id="tab-btn-data" onclick="openTab('tab-data')">ë°ì´í„°</button>
        </div>
        <div id="tab-scenes" class="tab-content active">
            <div class="scene-list" id="sceneList"></div>
        </div>
        <div id="tab-data" class="tab-content">
            <div class="control-box">
                <select id="timeUnit" class="unit-select" onchange="renderDataList()">
                    <option value="sec" selected>ë‹¨ìœ„: 1ì´ˆ</option>
                    <option value="ms">ë°€ë¦¬ì´ˆ</option>
                    <option value="cs">1/100ì´ˆ</option>
                </select>
                <div class="sync-control">
                    <button class="sync-btn" onclick="adjustSync(-0.1)">-0.1s</button>
                    <span class="sync-display" id="syncDisplay">Sync: 0.0s</span>
                    <button class="sync-btn" onclick="adjustSync(0.1)">+0.1s</button>
                </div>
            </div>
            <div id="dataList"></div>
        </div>
    </div>

    <!-- GitHub ë§¤ì¹˜ ì„¼í„° ëª¨ë‹¬ -->
    <div class="modal-overlay" id="matchCenterModal">
        <div class="modal-box" style="max-width: 650px;">
            <button class="close-btn" onclick="closeMatchCenter()">&times;</button>
            <div class="modal-header">GitHub Match Center</div>
            <div class="modal-tabs">
                <div class="m-tab active" id="m-tab-list" onclick="switchMatchTab('list')">ëŒ€íšŒ ëª©ë¡</div>
                <div class="m-tab" id="m-tab-admin" onclick="switchMatchTab('admin')">ë§¤ì¹˜ ë“±ë¡</div>
                <div class="m-tab" id="m-tab-manage" onclick="switchMatchTab('manage')">ëª©ë¡ ê´€ë¦¬ (ìˆ˜ì •/ì‚­ì œ)</div>
            </div>

            <!-- ë¦¬ìŠ¤íŠ¸ ë³´ê¸° íƒ­ -->
            <div id="match-view-list" class="m-content active">
                <div id="list-nav" style="margin-bottom:15px; display:none;">
                    <button onclick="renderCompList()"
                        style="background:#444; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;"><i
                            class="fa-solid fa-chevron-left"></i> ëŒ€íšŒ ëª©ë¡ìœ¼ë¡œ</button>
                </div>
                <div id="match-loading" style="text-align:center; padding:20px; color:#aaa;">ë¡œë”© ì¤‘...</div>
                <div class="match-list" id="match-list-container"></div>
                <div style="margin-top:20px; border-top:1px solid #444; padding-top:15px;">
                    <input type="text" id="manifest-url"
                        style="width:100%; background:#111; color:#fff; border:1px solid #555; padding:10px; border-radius:8px;"
                        value="matches.json">
                    <button onclick="loadGitHubManifest()"
                        style="margin-top:10px; width:100%; padding:10px; background:var(--accent); color:white; border:none; cursor:pointer; font-weight:bold; border-radius:8px;">ëª©ë¡
                        ë™ê¸°í™”</button>
                </div>
            </div>

            <!-- ë§¤ì¹˜ ì¶”ê°€(Admin) íƒ­ -->
            <div id="match-view-admin" class="m-content">
                <div class="admin-form">
                    <div class="form-group"><label>GitHub PAT (ìƒˆë¡œ ë°œê¸‰ë°›ì•„ ì…ë ¥í•˜ì„¸ìš”)</label><input type="password"
                            id="gh-token" class="form-input" placeholder="ghp_..."></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="form-group"><label>ID</label><input type="text" id="gh-owner" class="form-input"
                                value="Urekas"></div>
                        <div class="form-group"><label>Repo</label><input type="text" id="gh-repo" class="form-input"
                                value="analysis"></div>
                    </div>
                    <div class="form-group">
                        <label>ëŒ€íšŒ ì´ë¦„</label>
                        <select id="match-competition-select" class="form-input"
                            onchange="toggleNewCompInput()"></select>
                        <input type="text" id="match-competition-new" class="form-input" placeholder="ìƒˆ ëŒ€íšŒ ì´ë¦„ (ì§ì ‘ ì…ë ¥)"
                            style="display:none; margin-top:5px;">
                    </div>
                    <div class="form-group"><label>ê²½ê¸° ì œëª©</label><input type="text" id="match-title" class="form-input"
                            placeholder="ì¸ë„ vs ì¼ë³¸"></div>
                    <div class="form-group"><label>ìœ íŠœë¸Œ URL</label><input type="text" id="match-video" class="form-input"
                            placeholder="URL ì…ë ¥"></div>
                    <div class="form-group"><label>XML ë°ì´í„° íŒŒì¼</label><input type="file" id="match-xml-file"
                            accept=".xml" class="form-input"></div>
                    <button onclick="uploadMatchToGitHub()" id="btn-gh-upload" class="btn-submit">ìƒˆ ê²½ê¸° ë“±ë¡í•˜ê¸°</button>
                    <div id="upload-status"
                        style="font-size:0.85rem; text-align:center; min-height:20px; margin-top:10px;"></div>
                </div>
            </div>

            <!-- ëª©ë¡ ê´€ë¦¬(Manage) íƒ­ -->
            <div id="match-view-manage" class="m-content">
                <div style="margin-bottom:10px; color:#aaa; font-size:0.85rem;">
                    * ìˆœì„œ ë³€ê²½(â–²/â–¼), ìˆ˜ì •(âœï¸), ì‚­ì œ(ğŸ—‘ï¸) í›„ ë°˜ë“œì‹œ í•˜ë‹¨ì˜ <b>'ë³€ê²½ì‚¬í•­ ê¹ƒí—ˆë¸Œì— ìµœì¢… ì €ì¥'</b> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
                </div>
                <div id="manage-list-container" style="max-height: 350px; overflow-y: auto; padding-right:5px;"></div>
                <button onclick="saveManifestToGitHub()" class="btn-submit"
                    style="width: 100%; margin-top: 15px; background: #e67e22;"><i
                        class="fa-solid fa-cloud-arrow-up"></i> ë³€ê²½ì‚¬í•­ ê¹ƒí—ˆë¸Œì— ìµœì¢… ì €ì¥</button>
                <div id="manage-status" style="font-size:0.85rem; text-align:center; min-height:20px; margin-top:10px;">
                </div>

                <!-- ìˆ˜ì • í¼ -->
                <div id="edit-match-form"
                    style="display:none; margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
                    <h4 style="color:var(--accent); margin-top:0;"><i class="fa-solid fa-pen"></i> ê²½ê¸° ì •ë³´ ìˆ˜ì •</h4>
                    <input type="hidden" id="edit-match-index">
                    <div class="admin-form">
                        <input type="text" id="edit-match-competition" class="form-input" placeholder="ëŒ€íšŒ ì´ë¦„">
                        <input type="text" id="edit-match-title" class="form-input" placeholder="ê²½ê¸° ì œëª©">
                        <input type="text" id="edit-match-video" class="form-input" placeholder="ìœ íŠœë¸Œ URL">
                        <label style="font-size:0.8rem; color:#aaa;">ìƒˆ XML íŒŒì¼ (ë³€ê²½í•  ë•Œë§Œ ì„ íƒ)</label>
                        <input type="file" id="edit-match-xml-file" accept=".xml" class="form-input">
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button onclick="applyEditMatch()" class="btn-submit" style="flex:1; background:#3498db;">ìˆ˜ì •
                                ë‚´ìš© ì„ì‹œ ì ìš©</button>
                            <button onclick="cancelEditMatch()" class="btn-submit"
                                style="flex:1; background:#555;">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-box">
            <button class="close-btn" onclick="toggleHelp()">&times;</button>
            <div class="modal-header">ì‹œìŠ¤í…œ ì„¤ì •</div>
            <div class="modal-tabs">
                <div class="m-tab active" id="tab-btn-guide" onclick="switchModalTab('guide')">ê°€ì´ë“œ</div>
                <div class="m-tab" id="tab-btn-shortcuts" onclick="switchModalTab('shortcuts')">ë‹¨ì¶•í‚¤</div>
            </div>
            <div id="m-guide" class="m-content active"
                style="line-height:1.6; font-size:0.95rem; overflow-y:auto; max-height:400px; padding-right:10px;">
                <h4 style="color:var(--accent); margin-top:0;">1. ğŸŒ GitHub ë§¤ì¹˜ ì„¼í„° ì—°ë™</h4>
                <p style="margin-top:5px;">ìƒë‹¨ <b><i class="fa-brands fa-github"></i> ì•„ì´ì½˜</b>ì„ ëˆŒëŸ¬ ê¹ƒí—ˆë¸Œì—ì„œ í˜¸ìŠ¤íŒ…ë˜ëŠ” ê²½ê¸° ëª©ë¡ê³¼ ë°ì´í„°ë¥¼
                    ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <ul style="padding-left:20px; color:#ccc;">
                    <li><b>Admin íƒ­</b>ì— GitHub ê³„ì •ì˜ <b>Personal Access Token (PAT)</b>ê³¼ <b>ì €ì¥ì†Œ ì •ë³´(ID, Repo)</b>ë¥¼ ì…ë ¥í•˜ë©´ ë°”ë¡œ
                        ê²½ê¸° ì˜ìƒ(URL)ê³¼ XML ë°ì´í„°ë¥¼ ì €ì¥ì†Œì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    <li>ì´í›„ ì–¸ì œë“ ì§€ <b>ëŒ€íšŒ ëª©ë¡</b>ì—ì„œ í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ì˜ìƒê³¼ ë°ì´í„° íƒ€ì´ë°ì„ ì¼ì¹˜ì‹œì¼œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                </ul>
                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                <h4 style="color:#3498db; margin-top:0;">2. ğŸ’» ë¡œì»¬ íŒŒì¼(ì˜ìƒ/XML) ì—´ê¸°</h4>
                <p style="margin-top:5px;">ë¡œì»¬ ì»´í“¨í„°ì— ìˆëŠ” ì˜ìƒì„ ë°”ë¡œ ì›¹ì—ì„œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <ul style="padding-left:20px; color:#ccc;">
                    <li><b><i class="fa-solid fa-file-video"></i> ì˜ìƒ ì—´ê¸°</b> ì•„ì´ì½˜ì„ ëˆŒëŸ¬ PCì˜ mp4, webm ë“±ì˜ ì˜ìƒì„ ê°€ì ¸ì˜µë‹ˆë‹¤.</li>
                    <li><b><i class="fa-solid fa-file-lines"></i> ë°ì´í„° ì—´ê¸°</b> ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ê²½ê¸° ë¶„ì„ XML íŒŒì¼ì„ ê°€ì ¸ì˜¤ë©´, í™”ë©´ ìš°ì¸¡ íŒ¨ë„ì— ì‹œê°„ë³„
                        ì´ë²¤íŠ¸ ëª©ë¡ì´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</li>
                </ul>
                <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
                <h4 style="color:#2ecc71; margin-top:0;">3. âœï¸ ìº”ë²„ìŠ¤ ë“œë¡œì‰ & ë¶„ì„ ë„êµ¬</h4>
                <p style="margin-top:5px;">ì˜ìƒ ìœ„ì— ì „ìˆ  ê·¸ë˜í”½ì„ ë°”ë¡œ ê·¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <ul style="padding-left:20px; color:#ccc;">
                    <li>í•˜ë‹¨ ë©”ë‰´ë°”ì—ì„œ <b>ìƒ‰ìƒ, ì„  êµµê¸°, íˆ¬ëª…ë„</b>ë¥¼ ì§ê´€ì ìœ¼ë¡œ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    <li>ë‹¤ì¤‘ì„ (Polyline)ì´ë‚˜ ë‹¤ê°í˜•(Polygon)ì„ ê·¸ë¦´ ë•ŒëŠ” í™”ë©´ì„ í´ë¦­í•˜ì—¬ ì ì„ ì°ê³ , <b>ë”ë¸”í´ë¦­</b>í•˜ë©´ ë„í˜•ì´ ì™„ì„±ë©ë‹ˆë‹¤.</li>
                    <li>ê·¸ë ¤ë†“ì€ ë“œë¡œì‰ì„ ì €ì¥í•˜ë ¤ë©´ ì¢Œì¸¡ íŒ¨ë„ ë°‘ìª½ì˜ <b>ì¥ë©´ ì €ì¥ <i class="fa-solid fa-floppy-disk"></i></b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìš°ì¸¡ 'ì¥ë©´' íƒ­
                        ë©”ë‰´ì— ì‹œê°„ì´ ê¸°ë¡ë©ë‹ˆë‹¤.</li>
                </ul>
            </div>
            <div id="m-shortcuts" class="m-content" style="max-height:400px; overflow-y:auto; padding-right:10px;">
                <p style="font-size:0.85rem; color:#aaa; margin-top:0;">* ê° ë‹¨ì¶•í‚¤ ì…ë ¥ì¹¸ì„ ëˆ„ë¥¸ í›„, ì›í•˜ì‹œëŠ” ìƒˆë¡œìš´ í‚¤ë³´ë“œ í‚¤ë¥¼ ëˆŒëŸ¬ ì†ì‰½ê²Œ ë§¤í•‘ì„ ë°”ê¿€
                    ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div id="shortcut-list"></div>
                <div
                    style="font-size:0.85rem; color:#aaa; margin-top:15px; padding:10px; background:#222; border-radius:8px;">
                    <div>ğŸ’¡ <b>ê³ ì • ë‹¨ì¶•í‚¤ (ë³€ê²½ ë¶ˆê°€):</b></div>
                    <ul style="margin:5px 0; padding-left:20px;">
                        <li><kbd>â†</kbd> <kbd>â†’</kbd> : ì˜ìƒ 5ì´ˆ ë’¤ë¡œ/ì•ìœ¼ë¡œ</li>
                        <li><kbd>ESC</kbd> : ê·¸ë¦¬ê¸° ê°•ì œ ì·¨ì†Œ</li>
                    </ul>
                </div>
                <button onclick="saveShortcuts()"
                    style="margin-top:15px; padding:10px; background:var(--accent); color:white; border:none; width:100%; border-radius:5px; cursor:pointer; font-weight:bold;">ë‹¨ì¶•í‚¤
                    ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- ğŸš€ ì•± ì´ˆê¸°í™” ë° í†µí•© ë¡œì§ ---
        window.addEventListener('DOMContentLoaded', () => {
            // Fabric ì´ˆê¸°í™”
            if (typeof fabric !== 'undefined') {
                canvas = new fabric.Canvas('c', { preserveObjectStacking: true });
                if (typeof initCanvasEvents === 'function') initCanvasEvents();
            }

            // íŒŒì¼ ì…ë ¥ í•¸ë“¤ëŸ¬ ì¶”ê°€
            const handleVideoInput = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                switchMode('local');
                const localVideo = document.getElementById('local-video');
                localVideo.src = URL.createObjectURL(file);
                localVideo.load();
                localVideo.onloadedmetadata = () => {
                    const dur = localVideo.duration || 0;
                    if (isFinite(dur)) { document.getElementById('timeDisplay').innerText = `0:00 / ${formatTime(dur)}`; }
                };
                localVideo.play();
                e.target.value = null;
            };

            const handleDataInput = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    parseSportsCodeXML(evt.target.result);
                    openTab('tab-data');
                    document.getElementById('sceneSidebar').classList.remove('closed'); // Ensure it opens on mobile
                };
                r.readAsText(file);
                e.target.value = null; // ì¬ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
            };

            const vIn = document.getElementById('videoInput');
            if (vIn) vIn.addEventListener('change', handleVideoInput);
            const vInM = document.getElementById('videoInputMobile');
            if (vInM) vInM.addEventListener('change', handleVideoInput);

            const dIn = document.getElementById('dataInput');
            if (dIn) dIn.addEventListener('change', handleDataInput);
            const dInM = document.getElementById('dataInputMobile');
            if (dInM) dInM.addEventListener('change', handleDataInput);

            setTimeout(resizeCanvas, 500);
            initShortcuts();
            updateTimelineUI();
            loadAdminConfig();

            // --- ğŸ“± ëª¨ë°”ì¼ í„°ì¹˜ â†’ íƒ€ì„ë¼ì¸ ìŠ¤í¬ëŸ¬ë²„ í‘œì‹œ/ìˆ¨ê¹€ ---
            (function initMobileScrubber() {
                let scrubberHideTimer = null;

                function isMobile() {
                    return window.matchMedia('(max-width: 768px)').matches ||
                        (window.matchMedia('(max-width: 950px)').matches && window.matchMedia('(orientation: landscape)').matches);
                }

                function showScrubberMobile() {
                    if (!isMobile()) return;
                    const s = document.getElementById('videoScrubber');
                    if (!s || s.style.display === 'none') return; // ì˜ìƒ ì—†ìœ¼ë©´ ë¬´ì‹œ
                    s.classList.add('scrubber-visible');
                    clearTimeout(scrubberHideTimer);
                    scrubberHideTimer = setTimeout(() => {
                        s.classList.remove('scrubber-visible');
                    }, 3000);
                }

                // ì˜ìƒ/ìº”ë²„ìŠ¤ ì˜ì—­ í„°ì¹˜ ì‹œ ìŠ¤í¬ëŸ¬ë²„ í‘œì‹œ
                const mc = document.getElementById('mediaContainer');
                if (mc) {
                    mc.addEventListener('touchstart', (e) => {
                        showScrubberMobile();
                    }, { passive: true });
                }

                // ìŠ¤í¬ëŸ¬ë²„ ìì²´ í„°ì¹˜ ì‹œ íƒ€ì´ë¨¸ ì—°ì¥
                const scrubber = document.getElementById('videoScrubber');
                if (scrubber) {
                    scrubber.addEventListener('touchstart', () => {
                        clearTimeout(scrubberHideTimer);
                        scrubberHideTimer = setTimeout(() => {
                            scrubber.classList.remove('scrubber-visible');
                        }, 4000);
                    }, { passive: true });
                    scrubber.addEventListener('touchend', () => {
                        clearTimeout(scrubberHideTimer);
                        scrubberHideTimer = setTimeout(() => {
                            scrubber.classList.remove('scrubber-visible');
                        }, 3000);
                    }, { passive: true });
                }

                // í™”ë©´ íšŒì „ ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬
                window.addEventListener('orientationchange', () => {
                    if (scrubber) scrubber.classList.remove('scrubber-visible');
                });

                // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ ì „ì—­ ë…¸ì¶œ
                window._showScrubberMobile = showScrubberMobile;
            })();
        });

        // --- ğŸ¥ ìœ íŠœë¸Œ ë° ë¯¸ë””ì–´ ì œì–´ í•¨ìˆ˜ ---
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '100%', width: '100%',
                playerVars: { 'rel': 0, 'controls': 0, 'disablekb': 1, 'iv_load_policy': 3 },
                events: { 'onReady': () => { isYtReady = true; } }
            });
        }

        function switchMode(m) {
            currentMediaType = m;
            const ytDiv = document.getElementById('youtube-player');
            const localVid = document.getElementById('local-video');
            const scrubber = document.getElementById('videoScrubber');

            if (ytDiv) ytDiv.style.display = (m === 'youtube' ? 'block' : 'none');
            if (localVid) localVid.style.display = (m === 'local' ? 'block' : 'none');

            // ëª¨ë°”ì¼ì—ì„œëŠ” CSS + scrubber-visible í´ë˜ìŠ¤ë¡œ ì œì–´; PCì—ì„œëŠ” display flex/none ì§ì ‘ ì œì–´
            const isMobileView = window.matchMedia('(max-width: 768px)').matches ||
                (window.matchMedia('(max-width: 950px)').matches && window.matchMedia('(orientation: landscape)').matches);
            if (scrubber) {
                if (isMobileView) {
                    // ëª¨ë°”ì¼: displayëŠ” flex ê³ ì • (CSSì—ì„œ visibility/transformìœ¼ë¡œ ì œì–´)
                    // ì˜ìƒ ì—†ì„ ë•Œë§Œ display:none
                    scrubber.style.display = (m !== 'none' && m !== 'image') ? 'flex' : 'none';
                    scrubber.classList.remove('scrubber-visible');
                } else {
                    scrubber.style.display = (m !== 'none' && m !== 'image') ? 'flex' : 'none';
                }
            }

            if (m !== 'local' && localVid) localVid.pause();
            if (m !== 'youtube' && isYtReady && ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();

            setTimeout(resizeCanvas, 200);
        }

        function loadYoutubePrompt() {
            let url = prompt("YouTube URL:", "");
            if (url) {
                const ytIdMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/i);
                if (ytIdMatch && ytIdMatch[1]) {
                    switchMode('youtube');
                    // ğŸ”¥ ì˜ìƒ í´ë¦­ ì˜¤ì‘ë™ ë°©ì§€: ì¬ì‹œë„ ë¡œì§ ë³´ê°•
                    if (isYtReady && ytPlayer && ytPlayer.loadVideoById) {
                        ytPlayer.loadVideoById(ytIdMatch[1]);
                    } else {
                        showStatus("í”Œë ˆì´ì–´ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...");
                        let checkCount = 0;
                        const check = setInterval(() => {
                            checkCount++;
                            if (isYtReady && ytPlayer && ytPlayer.loadVideoById) {
                                clearInterval(check);
                                ytPlayer.loadVideoById(ytIdMatch[1]);
                            }
                            if (checkCount > 20) { clearInterval(check); showStatus("ìœ íŠœë¸Œ ë¡œë”© ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”."); }
                        }, 500);
                    }
                } else {
                    alert("ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ ë§í¬ê°€ ì•„ë‹™ë‹ˆë‹¤.");
                }
            }
        }

        function toggleVideoInteraction() {
            isVideoInteractive = !isVideoInteractive;
            const yt = document.getElementById('youtube-player');
            const cw = document.getElementById('canvasWrapper');
            const btn = document.getElementById('btn-video-touch');

            if (isVideoInteractive) {
                if (yt) yt.style.pointerEvents = 'auto';
                if (cw) cw.style.pointerEvents = 'none';
                if (btn) btn.classList.add('active');
                showStatus("ì˜ìƒ ì¡°ì‘ ëª¨ë“œ (ì¶”ì²œì˜ìƒ ë„ê¸° ê°€ëŠ¥)");
            } else {
                if (yt) yt.style.pointerEvents = 'none';
                if (cw) cw.style.pointerEvents = 'auto';
                if (btn) btn.classList.remove('active');
                showStatus("ë“œë¡œì‰ ëª¨ë“œ");
            }
        }

        function videoControl(act) {
            const localVid = document.getElementById('local-video');
            if (currentMediaType === 'local' && localVid) {
                if (act === 'toggle') localVid.paused ? localVid.play() : localVid.pause();
                else if (act === 'rewind') localVid.currentTime -= 5;
                else if (act === 'forward') localVid.currentTime += 5;
            } else if (currentMediaType === 'youtube' && isYtReady && ytPlayer) {
                if (act === 'toggle') {
                    const state = ytPlayer.getPlayerState();
                    state === 1 ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
                }
                else if (act === 'rewind') ytPlayer.seekTo(ytPlayer.getCurrentTime() - 5, true);
                else if (act === 'forward') ytPlayer.seekTo(ytPlayer.getCurrentTime() + 5, true);
            }
        }

        function updateTimelineUI() {
            try {
                if (!isDraggingSlider) {
                    let cur = 0, dur = 0;
                    const localVid = document.getElementById('local-video');
                    const timeSliderElem = document.getElementById('timeSlider');
                    const timeDisplayElem = document.getElementById('timeDisplay');

                    if (currentMediaType === 'local' && localVid) {
                        cur = localVid.currentTime || 0;
                        dur = localVid.duration || 0;
                    }
                    else if (currentMediaType === 'youtube' && isYtReady && ytPlayer && typeof ytPlayer.getDuration === 'function') {
                        cur = ytPlayer.getCurrentTime() || 0;
                        dur = ytPlayer.getDuration() || 0;
                    }

                    if (timeSliderElem && timeDisplayElem) {
                        if (dur > 0 && isFinite(dur)) {
                            timeSliderElem.value = (cur / dur) * 100;
                            timeDisplayElem.innerText = `${formatTime(cur)} / ${formatTime(dur)}`;
                        } else {
                            timeSliderElem.value = 0;
                            timeDisplayElem.innerText = "0:00 / 0:00";
                        }
                    }
                }

                // Update Play/Pause Button Icon to reflect state
                const playBtn = document.getElementById('btn-play-scrubber');
                if (playBtn) {
                    const localVid = document.getElementById('local-video');
                    if (currentMediaType === 'local' && localVid) {
                        playBtn.innerHTML = localVid.paused ? '<i class="fa-solid fa-play"></i>' : '<i class="fa-solid fa-pause"></i>';
                    } else if (currentMediaType === 'youtube' && isYtReady && ytPlayer && typeof ytPlayer.getPlayerState === 'function') {
                        playBtn.innerHTML = (ytPlayer.getPlayerState() === 1) ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
                    }
                }

            } catch (e) {
                // Ignore API not ready errors, just keep looping
            }
            requestAnimationFrame(updateTimelineUI);
        }

        const timeSliderGlobal = document.getElementById('timeSlider');
        if (timeSliderGlobal) {
            timeSliderGlobal.addEventListener('input', () => { isDraggingSlider = true; });
            timeSliderGlobal.addEventListener('change', () => {
                isDraggingSlider = false;
                const localVid = document.getElementById('local-video');
                const val = timeSliderGlobal.value / 100;
                if (currentMediaType === 'local' && localVid && localVid.duration) localVid.currentTime = val * localVid.duration;
                else if (currentMediaType === 'youtube' && isYtReady && ytPlayer && typeof ytPlayer.getDuration === 'function') ytPlayer.seekTo(val * ytPlayer.getDuration(), true);
            });
            timeSliderGlobal.addEventListener('pointerup', () => { isDraggingSlider = false; });
            timeSliderGlobal.addEventListener('touchend', () => { isDraggingSlider = false; });
        }

        const speedSlider = document.getElementById('speedSlider');
        if (speedSlider) {
            speedSlider.oninput = () => {
                const rate = parseFloat(speedSlider.value);
                document.getElementById('speedVal').innerText = rate.toFixed(1) + 'x';
                const localVid = document.getElementById('local-video');
                if (currentMediaType === 'local' && localVid) localVid.playbackRate = rate;
                else if (currentMediaType === 'youtube' && isYtReady && ytPlayer && typeof ytPlayer.setPlaybackRate === 'function') ytPlayer.setPlaybackRate(rate);
            };
        }

        function resizeCanvas() {
            const cont = document.getElementById('mediaContainer');
            if (cont && cont.offsetWidth > 0 && canvas) {
                canvas.setDimensions({ width: cont.offsetWidth, height: cont.offsetHeight });
                canvas.renderAll();
            }
        }
        window.onresize = resizeCanvas;

        // --- ğŸ”— GitHub & Match Center Logic ---
        function openMatchCenter() {
            const modal = document.getElementById('matchCenterModal');
            if (modal) modal.style.display = 'flex';
            loadAdminConfig();
            loadGitHubManifest();
        }

        function closeMatchCenter() {
            const modal = document.getElementById('matchCenterModal');
            if (modal) modal.style.display = 'none';
        }

        function switchMatchTab(t) {
            document.getElementById('m-tab-list').className = 'm-tab' + (t === 'list' ? ' active' : '');
            document.getElementById('m-tab-admin').className = 'm-tab' + (t === 'admin' ? ' active' : '');
            document.getElementById('m-tab-manage').className = 'm-tab' + (t === 'manage' ? ' active' : '');

            document.getElementById('match-view-list').className = 'm-content' + (t === 'list' ? ' active' : '');
            document.getElementById('match-view-admin').className = 'm-content' + (t === 'admin' ? ' active' : '');
            document.getElementById('match-view-manage').className = 'm-content' + (t === 'manage' ? ' active' : '');

            if (t === 'manage') renderManageList();
            if (t === 'admin') updateCompSelect();
        }

        function updateCompSelect() {
            const select = document.getElementById('match-competition-select');
            if (!select) return;
            select.innerHTML = '<option value="">-- ê¸°ì¡´ ëŒ€íšŒ ì„ íƒ --</option>';
            const comps = [...new Set(githubMatchesData.map(m => m.competition || "ê¸°íƒ€"))].filter(c => c !== "ê¸°íƒ€");
            comps.forEach(c => {
                select.innerHTML += `<option value="${c}">${c}</option>`;
            });
            select.innerHTML += '<option value="NEW">â• ìƒˆ ëŒ€íšŒ ì§ì ‘ ì…ë ¥...</option>';
            toggleNewCompInput();
        }

        function toggleNewCompInput() {
            const select = document.getElementById('match-competition-select');
            const input = document.getElementById('match-competition-new');
            if (select.value === 'NEW' || select.options.length <= 2) {
                input.style.display = 'block';
                if (select.options.length <= 2) select.value = 'NEW';
            } else {
                input.style.display = 'none';
            }
        }

        async function loadGitHubManifest() {
            const urlInput = document.getElementById('manifest-url');
            if (!urlInput) return;
            const url = urlInput.value.trim();
            const container = document.getElementById('match-list-container');
            const loading = document.getElementById('match-loading');
            if (loading) loading.style.display = 'block';
            if (container) container.innerHTML = '';

            try {
                const token = document.getElementById('gh-token').value;
                const owner = document.getElementById('gh-owner').value;
                const repo = document.getElementById('gh-repo').value;

                let data = null;

                if (token && owner && repo) {
                    let path = url.trim();
                    if (path.startsWith('./')) path = path.substring(2);
                    if (path === 'matches.json' || !path.includes('http')) {
                        path = 'matches.json';
                    } else if (path.includes('github.com') || path.includes('raw.githubusercontent.com')) {
                        const m = path.match(/.*?(?:github\.com|raw\.githubusercontent\.com)\/[^\/]+\/[^\/]+\/(?:blob\/[^\/]+\/|refs\/heads\/[^\/]+\/)?(.*)/);
                        if (m) path = m[1];
                    }

                    try {
                        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`, {
                            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3.raw' }
                        });
                        if (res.ok) data = await res.json();
                    } catch (e) { console.log(e); }
                }

                if (!data) {
                    const headers = {};
                    if (token) headers['Authorization'] = `token ${token}`;
                    let finalUrl = getDirectLink(url);
                    const response = await fetch(finalUrl + (finalUrl.includes('?') ? '&' : '?') + "t=" + Date.now(), { headers });
                    if (!response.ok) throw new Error("HTTP " + response.status);
                    data = await response.json();
                }

                githubMatchesData = data.matches || [];
                renderCompList();
                if (loading) loading.style.display = 'none';
            } catch (e) {
                if (loading) loading.innerText = "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (" + e.message + ")";
            }
        }

        function renderCompList() {
            const container = document.getElementById('match-list-container');
            if (!container) return;
            container.innerHTML = '';
            const nav = document.getElementById('list-nav'); if (nav) nav.style.display = 'none';
            const comps = [...new Set(githubMatchesData.map(m => m.competition || "ê¸°íƒ€"))];
            comps.forEach(comp => {
                const card = document.createElement('div'); card.className = 'comp-card';
                card.innerHTML = `<i class="fa-solid fa-folder-open" style="color:var(--accent);"></i> <span>${comp}</span>`;
                card.onclick = () => renderMatchList(comp); container.appendChild(card);
            });
        }

        function renderMatchList(comp) {
            const container = document.getElementById('match-list-container');
            if (!container) return;
            container.innerHTML = '';
            const nav = document.getElementById('list-nav'); if (nav) nav.style.display = 'block';
            githubMatchesData.filter(m => (m.competition || "ê¸°íƒ€") === comp).forEach(match => {
                const card = document.createElement('div'); card.className = 'match-card';
                card.innerHTML = `<span>${match.title}</span> <i class="fa-solid fa-play" style="color:var(--accent);"></i>`;
                card.onclick = () => selectMatch(match); container.appendChild(card);
            });
        }

        function getDirectLink(url) {
            if (!url) return ""; let l = url.trim();
            if (l.startsWith('./')) {
                const manifestInput = document.getElementById('manifest-url');
                if (manifestInput) {
                    const manifestUrl = manifestInput.value.trim();
                    const baseUrl = manifestUrl.substring(0, manifestUrl.lastIndexOf('/'));
                    l = baseUrl + l.substring(1);
                }
            }
            if (l.includes("github.com") && !l.includes("raw.githubusercontent.com")) {
                l = l.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
            }
            return encodeURI(l);
        }

        // --- ğŸ”¥ ì‹ ê·œ: ë§¤ì¹˜ ëª©ë¡ ê´€ë¦¬ ê¸°ëŠ¥ (Manage) - ê·¸ë£¹í™” ë° ì •ë ¬ ---
        function getGroupedMatches() {
            const groups = [];
            const compMap = new Map();
            githubMatchesData.forEach((m, origIndex) => {
                const cName = m.competition || "ê¸°íƒ€";
                if (!compMap.has(cName)) {
                    compMap.set(cName, { comp: cName, matches: [] });
                    groups.push(compMap.get(cName));
                }
                compMap.get(cName).matches.push({ ...m, origIndex });
            });
            return groups;
        }

        function flattenGroups(groups) {
            const newArr = [];
            groups.forEach(g => {
                g.matches.forEach(m => {
                    const { origIndex, ...rest } = m;
                    newArr.push(rest);
                });
            });
            githubMatchesData = newArr;
            renderManageList();
            document.getElementById('manage-status').innerText = "ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (í•˜ë‹¨ 'ìµœì¢… ì €ì¥'ì„ ëˆŒëŸ¬ì•¼ ê¹ƒí—ˆë¸Œì— ë°˜ì˜ë©ë‹ˆë‹¤)";
        }

        function renderManageList() {
            const container = document.getElementById('manage-list-container');
            if (!container) return;
            container.innerHTML = '';

            const groups = getGroupedMatches();

            groups.forEach((g, cIdx) => {
                const groupEl = document.createElement('div');
                groupEl.className = 'manage-group';

                let matchesHTML = '';
                g.matches.forEach((m, mIdx) => {
                    matchesHTML += `
                        <div class="manage-match-item">
                            <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:0.9rem; color:#eee;">${m.title}</span>
                            <div style="flex-shrink:0;">
                                <button class="manage-btn" onclick="moveMatchInGroup(${cIdx}, ${mIdx}, -1)" ${mIdx === 0 ? 'disabled style="opacity:0.3"' : ''} title="ê²½ê¸° ìœ„ë¡œ">â–²</button>
                                <button class="manage-btn" onclick="moveMatchInGroup(${cIdx}, ${mIdx}, 1)" ${mIdx === g.matches.length - 1 ? 'disabled style="opacity:0.3"' : ''} title="ê²½ê¸° ì•„ë˜ë¡œ">â–¼</button>
                                <button class="manage-btn edit" onclick="openEditMatchByOrigIndex(${m.origIndex})" title="ìˆ˜ì •"><i class="fa-solid fa-pen"></i></button>
                                <button class="manage-btn del" onclick="deleteMatchByOrigIndex(${m.origIndex})" title="ì‚­ì œ"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });

                groupEl.innerHTML = `
                    <div class="manage-group-header">
                        <span><i class="fa-solid fa-folder-open"></i> ${g.comp}</span>
                        <div>
                            <button class="manage-btn" onclick="moveCompetition(${cIdx}, -1)" ${cIdx === 0 ? 'disabled style="opacity:0.3"' : ''} title="ëŒ€íšŒ ìœ„ë¡œ ì˜¬ë¦¬ê¸°">ëŒ€íšŒ â–²</button>
                            <button class="manage-btn" onclick="moveCompetition(${cIdx}, 1)" ${cIdx === groups.length - 1 ? 'disabled style="opacity:0.3"' : ''} title="ëŒ€íšŒ ì•„ë˜ë¡œ ë‚´ë¦¬ê¸°">ëŒ€íšŒ â–¼</button>
                        </div>
                    </div>
                    ${matchesHTML}
                `;
                container.appendChild(groupEl);
            });
        }

        function moveCompetition(compIndex, direction) {
            const groups = getGroupedMatches();
            if (compIndex + direction < 0 || compIndex + direction >= groups.length) return;
            const temp = groups[compIndex];
            groups[compIndex] = groups[compIndex + direction];
            groups[compIndex + direction] = temp;
            flattenGroups(groups);
        }

        function moveMatchInGroup(compIndex, matchIndex, direction) {
            const groups = getGroupedMatches();
            const matches = groups[compIndex].matches;
            if (matchIndex + direction < 0 || matchIndex + direction >= matches.length) return;
            const temp = matches[matchIndex];
            matches[matchIndex] = matches[matchIndex + direction];
            matches[matchIndex + direction] = temp;
            flattenGroups(groups);
        }

        async function deleteMatchByOrigIndex(origIndex) {
            if (confirm("ì´ ê²½ê¸°ë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í™•ì¸ ì‹œ ê¹ƒí—ˆë¸Œì˜ XML íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ìµœì¢… ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª©ë¡ ê°±ì‹ ë„ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.)")) {
                const match = githubMatchesData[origIndex];
                if (match && match.data) {
                    const token = document.getElementById('gh-token').value;
                    const owner = document.getElementById('gh-owner').value;
                    const repo = document.getElementById('gh-repo').value;
                    if (token && owner && repo) {
                        try {
                            let path = match.data;
                            if (path.startsWith('./')) path = path.substring(2);
                            const checkRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`, { headers: { 'Authorization': `token ${token}` } });
                            if (checkRes.ok) {
                                const data = await checkRes.json();
                                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(path)}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ message: `Delete match XML: ${match.title}`, sha: data.sha })
                                });
                            }
                        } catch (e) {
                            console.error("XML ì‚­ì œ ì‹¤íŒ¨", e);
                        }
                    }
                }
                githubMatchesData.splice(origIndex, 1);
                renderManageList();
                cancelEditMatch();
                document.getElementById('manage-status').innerText = "í•´ë‹¹ ê²½ê¸°ì™€ XML íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ 'ìµœì¢… ì €ì¥'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            }
        }

        function openEditMatchByOrigIndex(origIndex) {
            const match = githubMatchesData[origIndex];
            document.getElementById('edit-match-index').value = origIndex;
            document.getElementById('edit-match-competition').value = match.competition || "";
            document.getElementById('edit-match-title').value = match.title || "";
            document.getElementById('edit-match-video').value = match.video || "";
            document.getElementById('edit-match-xml-file').value = "";
            document.getElementById('edit-match-form').style.display = 'block';
            document.getElementById('edit-match-form').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditMatch() {
            document.getElementById('edit-match-form').style.display = 'none';
        }

        async function applyEditMatch() {
            const index = document.getElementById('edit-match-index').value;
            const comp = document.getElementById('edit-match-competition').value.trim();
            const title = document.getElementById('edit-match-title').value.trim();
            const video = document.getElementById('edit-match-video').value.trim();
            const xmlFile = document.getElementById('edit-match-xml-file').files[0];
            const status = document.getElementById('manage-status');

            if (!comp || !title || !video) { alert("ëŒ€íšŒëª…, ì œëª©, ì˜ìƒ URLì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

            saveAdminConfig();
            const token = document.getElementById('gh-token').value;
            const owner = document.getElementById('gh-owner').value;
            const repo = document.getElementById('gh-repo').value;

            let dataPath = githubMatchesData[index].data;

            // ìƒˆ XMLì„ ì—…ë¡œë“œ í•œ ê²½ìš° ì¦‰ì‹œ ê¹ƒí—ˆë¸Œì— ë°˜ì˜ (ë°ì´í„° ë®ì–´ì“°ê¸°)
            if (xmlFile) {
                if (!token || !owner || !repo) { alert("XMLì„ ì—…ë¡œë“œí•˜ë ¤ë©´ Admin íƒ­ì— PAT ì •ë³´ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
                status.innerHTML = `<span style="color:#3498db;">ìƒˆë¡œìš´ XML íŒŒì¼ ê¹ƒí—ˆë¸Œì— ì—…ë¡œë“œ ì¤‘...</span>`;
                try {
                    // ê¸°ì¡´ XML ì‚­ì œ ì‹œë„
                    if (dataPath) {
                        let oldPath = dataPath;
                        if (oldPath.startsWith('./')) oldPath = oldPath.substring(2);
                        try {
                            const checkOldres = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(oldPath)}`, { headers: { 'Authorization': `token ${token}` } });
                            if (checkOldres.ok) {
                                const oldData = await checkOldres.json();
                                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(oldPath)}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ message: `Delete old XML: ${title}`, sha: oldData.sha })
                                });
                            }
                        } catch (e) { }
                    }

                    const xmlBase64 = await new Promise((res, rej) => {
                        const r = new FileReader(); r.onload = () => res(r.result.split(',')[1]); r.onerror = rej; r.readAsDataURL(xmlFile);
                    });

                    const xmlPath = `data/${comp}/${title}_${Date.now()}.xml`;
                    const upRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(xmlPath)}`, {
                        method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `Update match XML: ${title}`, content: xmlBase64 })
                    });

                    if (!upRes.ok) throw new Error("ìƒˆ XML ì—…ë¡œë“œ ì‹¤íŒ¨");
                    dataPath = `${xmlPath}`;
                } catch (e) {
                    status.innerHTML = `<span style="color:#e74c3c;">XML ë³€ê²½ ì˜¤ë¥˜: ${e.message}</span>`;
                    return;
                }
            }

            githubMatchesData[index] = {
                title: title, competition: comp, video: video, data: dataPath,
                date: githubMatchesData[index].date || new Date().toISOString().split('T')[0]
            };

            renderManageList();
            cancelEditMatch();
            status.innerHTML = `<span style="color:#f1c40f;">ìˆ˜ì • ë‚´ìš©ì´ ëª©ë¡ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ë‹¨ì˜ 'ìµœì¢… ì €ì¥'ì„ ë°˜ë“œì‹œ ëˆ„ë¥´ì„¸ìš”!</span>`;
        }

        async function saveManifestToGitHub() {
            const token = document.getElementById('gh-token').value;
            const owner = document.getElementById('gh-owner').value;
            const repo = document.getElementById('gh-repo').value;
            const status = document.getElementById('manage-status');

            if (!token || !owner || !repo) { alert("GitHub PAT, ID, Repo ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. (Admin íƒ­ í™•ì¸)"); return; }
            status.innerHTML = `ë³€ê²½ì‚¬í•­ì„ ê¹ƒí—ˆë¸Œì— ì €ì¥ ì¤‘...`;

            try {
                // ì €ì¥ ì „ í•­ìƒ matches.jsonì˜ ìµœì‹  SHA í•­ëª©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const manifestRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/matches.json?t=${Date.now()}`, { headers: { 'Authorization': `token ${token}` } });
                if (!manifestRes.ok) throw new Error("matches.json ìµœì‹  ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                const manifestData = await manifestRes.json();

                const manifestObj = { matches: githubMatchesData };
                const jsonString = JSON.stringify(manifestObj, null, 2);

                const encodedBytes = new TextEncoder().encode(jsonString);
                let binStr = ""; for (let i = 0; i < encodedBytes.length; i++) binStr += String.fromCharCode(encodedBytes[i]);
                const updatedJsonB64 = window.btoa(binStr);

                const finalUpRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/matches.json`, {
                    method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Update matches list (Manage)`, content: updatedJsonB64, sha: manifestData.sha })
                });

                if (!finalUpRes.ok) throw new Error(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (HTTP ${finalUpRes.status})`);

                status.innerHTML = `<span style="color:#2ecc71;">ì„±ê³µì ìœ¼ë¡œ ê¹ƒí—ˆë¸Œì— ì™„ë²½íˆ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>`;
                setTimeout(() => { loadGitHubManifest(); }, 1500);
            } catch (e) {
                status.innerHTML = `<span style="color:#e74c3c;">ì €ì¥ ì˜¤ë¥˜: ${e.message}</span>`;
            }
        }

        // --- ğŸ¥ ê²½ê¸° í´ë¦­ì‹œ ë§¤ì¹˜ ë¡œë“œ ë™ì‘ ë¡œì§ (Silent Error ë°©ì§€) ---
        async function selectMatch(match) {
            closeMatchCenter(); showStatus(`${match.title} ë¡œë“œ ì¤‘...`, true);

            // ë¹„ë””ì˜¤ URL ëˆ„ë½ ë“± ì˜¤ë¥˜ ëŒ€ì‘ ì•ˆì „ì¥ì¹˜ ì¶”ê°€
            const videoUrl = match.video || "";
            const ytMatch = videoUrl.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/i);

            if (ytMatch) {
                switchMode('youtube');
                if (isYtReady && ytPlayer && ytPlayer.loadVideoById) {
                    ytPlayer.loadVideoById(ytMatch[1]);
                } else {
                    let checkCount = 0;
                    const check = setInterval(() => {
                        checkCount++;
                        if (isYtReady && ytPlayer && ytPlayer.loadVideoById) {
                            clearInterval(check);
                            ytPlayer.loadVideoById(ytMatch[1]);
                        }
                        if (checkCount > 20) clearInterval(check);
                    }, 500);
                }
            } else if (videoUrl) {
                switchMode('local');
                const localVideo = document.getElementById('local-video');
                localVideo.src = videoUrl;
                localVideo.load();
                localVideo.onloadedmetadata = () => {
                    const dur = localVideo.duration || 0;
                    if (isFinite(dur)) {
                        document.getElementById('timeDisplay').innerText = `0:00 / ${formatTime(dur)}`;
                    }
                };
            } else {
                switchMode('none');
                showStatus(`ì˜ìƒ ë§í¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
            }

            try {
                if (match.data) {
                    // ë°ì´í„° íŒ¨ë„ ë¨¼ì € ì—´ê¸° (ë¡œë”© í‘œì‹œ)
                    openTab('tab-data');
                    document.getElementById('sceneSidebar').classList.remove('closed');
                    const listEl = document.getElementById('dataList');
                    if (listEl) listEl.innerHTML = '<div style="color:#aaa; padding:15px; font-size:0.85rem;">â³ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                    const text = await fetchExternalData(match.data);
                    parseSportsCodeXML(text);
                    showStatus(`${match.title} ë¡œë“œ ì™„ë£Œ!`);
                } else {
                    showStatus(`${match.title} (XML ë°ì´í„° ì—†ìŒ)`);
                    openTab('tab-data');
                    document.getElementById('sceneSidebar').classList.remove('closed');
                    const listEl = document.getElementById('dataList');
                    if (listEl) listEl.innerHTML = '<div style="color:#aaa; padding:15px; font-size:0.85rem;">ì´ ê²½ê¸°ì—ëŠ” XML ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (err) {
                // ì—ëŸ¬ë¥¼ ëª¨ë°”ì¼ì—ì„œë„ ë³¼ ìˆ˜ ìˆë„ë¡ íŒ¨ë„ì— í‘œì‹œ
                openTab('tab-data');
                document.getElementById('sceneSidebar').classList.remove('closed');
                const listEl = document.getElementById('dataList');
                if (listEl) listEl.innerHTML = `<div style="color:#e74c3c; padding:15px; font-size:0.85rem;">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:<br>${err.message}</div>`;
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
            }
        }

        // ğŸ”§ arrayBufferë¥¼ UTF-8ë¡œ ëª…ì‹œ ë””ì½”ë”© (BOM ìë™ ì œê±° í¬í•¨)
        async function safeDecodeResponse(response) {
            const buf = await response.arrayBuffer();
            const bytes = new Uint8Array(buf);
            // UTF-8 BOM (EF BB BF) ì œê±°
            let start = 0;
            if (bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) start = 3;
            // UTF-16 LE BOM (FF FE) ì œê±° â†’ UTF-16 LE ë””ì½”ë”©
            else if (bytes.length >= 2 && bytes[0] === 0xFF && bytes[1] === 0xFE) {
                try { return new TextDecoder('utf-16le').decode(bytes.slice(2)); } catch (e) { }
            }
            // UTF-16 BE BOM (FE FF) ì œê±° â†’ UTF-16 BE ë””ì½”ë”©
            else if (bytes.length >= 2 && bytes[0] === 0xFE && bytes[1] === 0xFF) {
                try { return new TextDecoder('utf-16be').decode(bytes.slice(2)); } catch (e) { }
            }
            return new TextDecoder('utf-8').decode(bytes.slice(start));
        }

        async function fetchExternalData(url) {
            const token = document.getElementById('gh-token').value;
            const owner = document.getElementById('gh-owner').value;
            const repo = document.getElementById('gh-repo').value;

            let path = url.trim();
            if (path.startsWith('./')) path = path.substring(2);

            if (path.includes('.xml') || path.includes('.json') || path.includes('.csv')) {
                // Check if running on local file system (index.html opened locally) without GitHub API configured setup
                if (!token || !owner || !repo) {
                    try {
                        const localRes = await fetch(path);
                        if (localRes.ok) return await safeDecodeResponse(localRes);
                    } catch (e) { console.log("Local fetch failed", e); }
                    throw new Error("Local File API or GitHub Token required for " + path);
                }

                try {
                    let apiPath = path;
                    if (apiPath.includes('github.com') || apiPath.includes('raw.githubusercontent.com')) {
                        const m = apiPath.match(/.*?(?:github\.com|raw\.githubusercontent\.com)\/[^\/]+\/[^\/]+\/(?:blob\/[^\/]+\/|refs\/heads\/[^\/]+\/)?(.*)/);
                        if (m) apiPath = m[1];
                    }

                    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(apiPath)}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3.raw'
                        }
                    });
                    if (response.ok) return await safeDecodeResponse(response);
                } catch (e) {
                    console.log("GitHub API fetch fallback", e);
                }
            }

            const finalUrl = getDirectLink(url);
            const headers = {}; if (token && finalUrl.includes("raw.githubusercontent.com")) headers['Authorization'] = `token ${token}`;
            try {
                const response = await fetch(finalUrl, { headers });
                if (response.ok) {
                    const text = await safeDecodeResponse(response);
                    const lower = text.trimStart().toLowerCase();
                    // HTML ì—ëŸ¬ í˜ì´ì§€(ëŒ€ì†Œë¬¸ì ë¬´ê´€) ê±¸ëŸ¬ë‚´ê¸°
                    if (!lower.startsWith("<!doctype") && !lower.startsWith("<html")) return text;
                }
                const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(finalUrl);
                const proxyRes = await fetch(proxyUrl);
                return await safeDecodeResponse(proxyRes);
            } catch (e) { throw new Error("ë¡œë“œ ì‹¤íŒ¨: " + e.message); }
        }

        async function uploadMatchToGitHub() {
            saveAdminConfig();
            const token = document.getElementById('gh-token').value;
            const owner = document.getElementById('gh-owner').value;
            const repo = document.getElementById('gh-repo').value;

            const compSelect = document.getElementById('match-competition-select').value;
            const compNew = document.getElementById('match-competition-new').value.trim();
            const comp = (compSelect === 'NEW' || !compSelect) ? compNew : compSelect;

            const title = document.getElementById('match-title').value.trim();
            const video = document.getElementById('match-video').value.trim();
            const xmlFile = document.getElementById('match-xml-file').files[0];
            const status = document.getElementById('upload-status');
            const btn = document.getElementById('btn-gh-upload');

            if (!token || !owner || !repo || !comp || !title || !video || !xmlFile) { alert("í•­ëª©ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”."); return; }
            btn.disabled = true; status.innerHTML = `ì—…ë¡œë“œ ì¤‘...`;

            try {
                const xmlPath = `data/${comp}/${title}.xml`;
                let xmlSha = null;
                const checkRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(xmlPath)}`, { headers: { 'Authorization': `token ${token}` } });
                if (checkRes.ok) { const data = await checkRes.json(); xmlSha = data.sha; }

                const xmlBase64 = await new Promise((res, rej) => {
                    const r = new FileReader(); r.onload = () => res(r.result.split(',')[1]); r.onerror = rej; r.readAsDataURL(xmlFile);
                });

                const upBody = { message: `Add/Update data: ${title}`, content: xmlBase64 };
                if (xmlSha) upBody.sha = xmlSha;

                const upRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURI(xmlPath)}`, {
                    method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(upBody)
                });
                if (!upRes.ok) { const errData = await upRes.json(); throw new Error(`XML ì—…ë¡œë“œ ì‹¤íŒ¨: ${errData.message}`); }

                const manifestRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/matches.json?t=${Date.now()}`, { headers: { 'Authorization': `token ${token}` } });
                let manifestObj = { matches: [] }; let manifestSha = null;

                if (manifestRes.ok) {
                    const manifestData = await manifestRes.json();
                    manifestSha = manifestData.sha;
                    try {
                        if (manifestData.content) {
                            const contentClean = manifestData.content.replace(/\s/g, "");
                            const bytes = new Uint8Array(window.atob(contentClean).split('').map(c => c.charCodeAt(0)));
                            manifestObj = JSON.parse(new TextDecoder("utf-8").decode(bytes));
                        } else {
                            manifestObj.matches = [...githubMatchesData];
                        }
                    } catch (e) {
                        manifestObj.matches = [...githubMatchesData];
                    }
                } else {
                    manifestObj.matches = [...githubMatchesData];
                }

                const existingIndex = manifestObj.matches.findIndex(m => m.title === title && m.competition === comp);
                const newMatchData = { title, competition: comp, video, data: `${xmlPath}`, date: new Date().toISOString().split('T')[0] };
                if (existingIndex !== -1) manifestObj.matches[existingIndex] = newMatchData; else manifestObj.matches.push(newMatchData);

                const jsonString = JSON.stringify(manifestObj, null, 2);
                const encodedBytes = new TextEncoder().encode(jsonString);
                let binStr = ""; for (let i = 0; i < encodedBytes.length; i++) binStr += String.fromCharCode(encodedBytes[i]);
                const updatedJsonB64 = window.btoa(binStr);

                const manifestUpBody = { message: `Update manifest: ${title}`, content: updatedJsonB64 };
                if (manifestSha) manifestUpBody.sha = manifestSha;

                const finalUpRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/matches.json`, {
                    method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(manifestUpBody)
                });

                if (!finalUpRes.ok) { const errData = await finalUpRes.json(); throw new Error(`ëª©ë¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${errData.message}`); }

                status.innerHTML = `<span style="color:#2ecc71;">ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!</span>`;
                setTimeout(() => { switchMatchTab('list'); loadGitHubManifest(); }, 1500);
            } catch (e) { status.innerHTML = `<span style="color:#e74c3c;">ì˜¤ë¥˜: ${e.message}</span>`; } finally { btn.disabled = false; }
        }

        // --- ğŸ¨ ë“œë¡œì‰ ëª¨ë“œ ë° ë§ˆìš°ìŠ¤ í•¸ë“¤ëŸ¬ ì „ì—­ ì„ ì–¸ ---
        function hexToMutedRgba(h, a) { const r = parseInt(h.slice(1, 3), 16), g = parseInt(h.slice(3, 5), 16), b = parseInt(h.slice(5, 7), 16); return `rgba(${r},${g},${b},${a})`; }
        function getStrokeGradient(color) { return new fabric.Gradient({ type: 'linear', gradientUnits: 'percentage', coords: { x1: 0, y1: 0, x2: 0, y2: 1 }, colorStops: [{ offset: 0, color: hexToMutedRgba(color, 0) }, { offset: 0.5, color: hexToMutedRgba(color, 0.5) }, { offset: 1, color: color }] }); }
        function getEllipseOffset(point, targetX, targetY, rx, ry) { const dx = targetX - point.left; const dy = targetY - point.top; const angle = Math.atan2(dy, dx); const radiusAtAngle = (rx * ry) / Math.sqrt(Math.pow(ry * Math.cos(angle), 2) + Math.pow(rx * Math.sin(angle), 2)); const offset = radiusAtAngle + 2; return { x: point.left + Math.cos(angle) * offset, y: point.top + Math.sin(angle) * offset }; }

        function setMode(mode) {
            if (typeof isVideoInteractive !== 'undefined' && isVideoInteractive) toggleVideoInteraction();
            currentMode = mode;
            document.querySelectorAll('.sidebar .tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + mode)?.classList.add('active');

            const guide = document.getElementById('guide-msg');
            if (guide) guide.style.display = (mode === 'drawPolyline' || mode === 'drawPolygon') ? 'block' : 'none';
            if (mode === 'drawPolyline' || mode === 'drawPolygon') { guide.innerText = "ë”ë¸”í´ë¦­í•˜ì—¬ ë„í˜• ì™„ì„±"; }

            if (canvas) {
                if (mode === 'drawPen') {
                    canvas.isDrawingMode = true;
                    canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                    canvas.freeDrawingBrush.color = currentColor;
                    canvas.freeDrawingBrush.width = currentSize / 4;
                    canvas.freeDrawingBrush.shadow = broadcastShadow;
                    canvas.selection = false;
                } else {
                    canvas.isDrawingMode = false;
                    canvas.selection = (mode === 'select');
                    canvas.defaultCursor = (mode === 'select') ? 'default' : 'crosshair';
                    const s = (mode === 'select');
                    canvas.forEachObject(o => { o.selectable = s; o.evented = s; });
                }
            }
            if (canvas) canvas.requestRenderAll();
            resetDrawing();
        }

        function initCanvasEvents() {
            canvas.on('mouse:down', function (o) {
                if (isPalmRejection && o.e && (o.e.pointerType === 'touch' || o.e.touches)) return;
                if (currentMode === 'select' || currentMode === 'drawPen' || !o.e) return;
                const p = canvas.getPointer(o.e);

                if (currentMode === 'drawPlayerTag') {
                    const fs = Math.max(16, currentSize * 0.7); const isR = (p.x > canvas.width / 2); const dir = isR ? -1 : 1;
                    const text = new fabric.IText('(NR) PLAYER', { fontSize: fs, fill: currentColor, fontFamily: 'S-CoreDream-6Bold', originX: isR ? 'right' : 'left', originY: 'bottom', top: 4, shadow: broadcastShadow });
                    const line = new fabric.Path([['M', -dir * 18, 28], ['L', 0, 0], ['L', dir * (text.width + 5), 0]], { fill: '', stroke: currentColor, strokeWidth: 3, selectable: false });
                    const tagGroup = new fabric.Group([line, text], { left: p.x, top: p.y, originX: isR ? 'right' : 'left', originY: 'top', selectable: true, shadow: broadcastShadow, isPlayerTag: true, side: isR ? 'R' : 'L' });
                    canvas.add(tagGroup); canvas.setActiveObject(tagGroup); setMode('select'); return;
                }
                if ((currentMode === 'drawPolyline' || currentMode === 'drawPolygon') && activePoints.length > 0) { const lastPt = activePoints[activePoints.length - 1]; const dist = Math.sqrt(Math.pow(p.x - lastPt.left, 2) + Math.pow(p.y - lastPt.top, 2)); if (dist < 20) return; }

                if (currentMode === 'drawSpot') {
                    DrawingHandler.createSpot(canvas, p, currentColor, currentSize, currentOpacity);
                }
                else if (currentMode === 'drawArrow' || currentMode === 'drawCurve') {
                    isDrawing = true; startPoint = p;
                    activeObj = new fabric.Line([p.x, p.y, p.x, p.y], { stroke: currentColor, strokeWidth: 2, strokeDashArray: [5, 5], opacity: 0.5, selectable: false });
                    canvas.add(activeObj);
                }
                else if (currentMode === 'drawPolyline') {
                    let n;
                    if (isSpotMode) n = new fabric.Ellipse({ left: p.x, top: p.y, rx: currentSize, ry: currentSize * 0.4, fill: hexToMutedRgba(currentColor, currentOpacity), stroke: getStrokeGradient(currentColor), strokeWidth: 3, originX: 'center', originY: 'center', selectable: false, shadow: new fabric.Shadow({ color: currentColor, blur: 15 }) }); else n = new fabric.Circle({ radius: 4, fill: currentColor, left: p.x, top: p.y, originX: 'center', originY: 'center', selectable: false });
                    activePoints.push(n); pointArray.push({ x: p.x, y: p.y }); componentArray.push(n); canvas.add(n);
                    if (pointArray.length > 1) {
                        const prevNode = activePoints[activePoints.length - 2]; const currNode = activePoints[activePoints.length - 1]; let startX = prevNode.left, startY = prevNode.top; let endX = currNode.left, endY = currNode.top;
                        if (isSpotMode) { const startOff = getEllipseOffset(prevNode, endX, endY, currentSize, currentSize * 0.4); const endOff = getEllipseOffset(currNode, startX, startY, currentSize, currentSize * 0.4); startX = startOff.x; startY = startOff.y; endX = endOff.x; endY = endOff.y; }
                        const line = new fabric.Line([startX, startY, endX, endY], { stroke: currentColor, strokeWidth: 3, strokeLineCap: 'round', shadow: broadcastShadow, selectable: false, evented: false, strokeDashArray: typeof isDashed !== 'undefined' && isDashed ? [10, 5] : false }); activeLines.push(line); componentArray.push(line); canvas.add(line); canvas.sendToBack(line);
                    }
                    const finishBtn = document.getElementById('btn-finish');
                    if (finishBtn) finishBtn.classList.add('show');
                }
                else if (currentMode === 'drawPolygon') {
                    const c = new fabric.Circle({ radius: 4, fill: currentColor, left: p.x, top: p.y, originX: 'center', originY: 'center', selectable: false }); activePoints.push(c); pointArray.push({ x: p.x, y: p.y }); canvas.add(c);
                    if (pointArray.length > 1) { const l = new fabric.Line([pointArray[pointArray.length - 2].x, pointArray[pointArray.length - 2].y, pointArray[pointArray.length - 1].x, pointArray[pointArray.length - 1].y], { stroke: currentColor, strokeWidth: 2, strokeDashArray: [5, 5], selectable: false }); activeLines.push(l); canvas.add(l); }
                    const finishBtn = document.getElementById('btn-finish'); if (finishBtn) finishBtn.classList.add('show');
                }
            });

            canvas.on('mouse:move', o => { if (isDrawing && (currentMode === 'drawArrow' || currentMode === 'drawCurve')) { activeObj.set({ x2: canvas.getPointer(o.e).x, y2: canvas.getPointer(o.e).y }); canvas.renderAll(); } });

            canvas.on('mouse:up', o => {
                if ((currentMode === 'drawArrow' || currentMode === 'drawCurve') && isDrawing) {
                    isDrawing = false; const end = canvas.getPointer(o.e); canvas.remove(activeObj);
                    if (currentMode === 'drawArrow') {
                        DrawingHandler.createArrow(canvas, startPoint, end, currentColor, currentSize, typeof isDashed !== 'undefined' ? isDashed : false);
                    } else {
                        DrawingHandler.startCurve(canvas, startPoint, end, currentColor, currentSize, typeof isDashed !== 'undefined' ? isDashed : false);
                    }
                    setMode('select');
                }
            });

            canvas.on('mouse:dblclick', e => {
                if (e.target && e.target.isPlayerTag) {
                    const textObj = e.target.getObjects().find(o => o.type === 'i-text');
                    const lineObj = e.target.getObjects().find(o => o.type === 'path');
                    const newName = prompt("ì„ ìˆ˜ ì´ë¦„ ì…ë ¥:", textObj.text);
                    if (newName) {
                        textObj.set('text', newName);
                        const dir = (e.target.side === 'R') ? -1 : 1;
                        lineObj.set('path', [['M', -dir * 18, 28], ['L', 0, 0], ['L', dir * (textObj.width + 5), 0]]);
                        canvas.renderAll();
                    }
                    return;
                }
                if (!e.target) { if (pointArray.length > 0) { const removeCount = (activePoints.length >= 2) ? 2 : activePoints.length; for (let i = 0; i < removeCount; i++) { const pt = activePoints.pop(); if (pt) canvas.remove(pt); componentArray.pop(); pointArray.pop(); } if (activeLines.length > 0) { const ln1 = activeLines.pop(); canvas.remove(ln1); componentArray.pop(); } if (activeLines.length > 0) { const ln2 = activeLines.pop(); canvas.remove(ln2); componentArray.pop(); } completeDrawing(); } return; }
                if (e.target.type === 'i-text') { e.target.enterEditing(); e.target.selectAll(); }
                else if (currentMode === 'drawPolyline' || currentMode === 'drawPolygon') completeDrawing();
            });
        } // End of initCanvasEvents

        // --- ğŸ“Š ë°ì´í„° ë¶„ì„ íŒŒì‹± ---
        function parseSportsCodeXML(rawText) {
            let text = rawText || '';

            // 1ë‹¨ê³„: null bytes ë° ë¹„ì •ìƒ ì œì–´ë¬¸ì ì œê±° (ëª¨ë°”ì¼ì—ì„œ ê°„í˜¹ ë°œìƒ)
            text = text.replace(/\x00/g, '');

            // 2ë‹¨ê³„: ì²« '<' ì´ì „ì˜ ëª¨ë“  garbage ì œê±°
            // (UTF-8 BOM, UTF-16 BOM ì˜ëª» ë””ì½”ë”©ëœ ë¬¸ì, ê³µë°± ë“± ëª¨ë‘ ì²˜ë¦¬)
            const xmlStart = text.indexOf('<');
            if (xmlStart < 0) {
                // '<'ê°€ ì „í˜€ ì—†ìœ¼ë©´ XMLì´ ì•„ë‹Œ ë‹¤ë¥¸ í¬ë§· (JSON ë“±) ê°€ëŠ¥ì„±
                const listEl = document.getElementById('dataList');
                if (listEl) listEl.innerHTML = `<div style="color:#e74c3c; padding:15px; font-size:0.8rem;">âš ï¸ XML íŒŒì‹± ì˜¤ë¥˜: XML íƒœê·¸(&lt;)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><code style="font-size:0.75rem; word-break:break-all;">${(text.substring(0, 80) || '(ë¹„ì–´ìˆìŒ)').replace(/</g, '&lt;')}</code></div>`;
                return;
            }
            if (xmlStart > 0) text = text.substring(xmlStart);
            text = text.trim();

            // 3ë‹¨ê³„: XML ì„ ì–¸ë¶€ì˜ ì¸ì½”ë”© ì†ì„±ì„ 'UTF-8'ë¡œ ê°•ì œ ì •ê·œí™”
            // (ëª¨ë°”ì¼ DOMParserëŠ” ì„ ì–¸ë¶€ ì¸ì½”ë”©ì´ ë§ì§€ ì•Šìœ¼ë©´ íŒŒì‹± ì‹¤íŒ¨)
            text = text.replace(/(<\?xml[^>]*?)encoding=["'][^"']*["']/i, '$1encoding="UTF-8"');

            const parser = new DOMParser();
            let xmlDoc = parser.parseFromString(text, "text/xml");

            // text/xml ì‹¤íŒ¨ ì‹œ application/xml í´ë°± (iOS Safari í˜¸í™˜)
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                xmlDoc = parser.parseFromString(text, "application/xml");
            }

            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                const preview = text.substring(0, 150).replace(/</g, '&lt;');
                const listEl = document.getElementById('dataList');
                if (listEl) listEl.innerHTML = `<div style="color:#e74c3c; padding:15px; font-size:0.8rem;">âš ï¸ XML íŒŒì‹± ì˜¤ë¥˜<br><span style="color:#aaa;">ìˆ˜ì‹ ëœ ë‚´ìš© ì•ë¶€ë¶„:</span><br><code style="font-size:0.75rem; word-break:break-all;">${preview || '(ë¹„ì–´ìˆìŒ)'}</code></div>`;
                return;
            }
            const instances = xmlDoc.getElementsByTagName("instance");
            eventList = [];
            for (let i = 0; i < instances.length; i++) {
                const inst = instances[i];
                const start = parseFloat(inst.getElementsByTagName("start")[0]?.textContent || 0);
                const code = inst.getElementsByTagName("code")[0]?.textContent || "Event";
                const labels = inst.getElementsByTagName("label");
                let labelText = labels.length > 0 ? labels[0].getElementsByTagName("text")[0]?.textContent || "" : "";
                eventList.push({ start, code, label: labelText });
            }
            if (eventList.length === 0) {
                const listEl = document.getElementById('dataList');
                if (listEl) listEl.innerHTML = '<div style="color:#aaa; padding:15px; font-size:0.85rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (instance íƒœê·¸ 0ê°œ).</div>';
                return;
            }
            renderDataList();
        }

        function renderDataList() {
            const unit = document.getElementById('timeUnit').value;
            const listEl = document.getElementById('dataList'); if (!listEl) return; listEl.innerHTML = '';
            if (!eventList.length) return;
            const grouped = {};
            eventList.forEach(ev => { if (!grouped[ev.code]) grouped[ev.code] = []; grouped[ev.code].push(ev); });

            // ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ(ABC) ì •ë ¬
            const sortedKeys = Object.keys(grouped).sort((a, b) => a.localeCompare(b));

            for (const code of sortedKeys) {
                const items = grouped[code];
                const group = document.createElement('div'); group.className = 'data-group';
                const header = document.createElement('div'); header.className = 'data-group-header';
                header.innerHTML = `<i class="fa-solid fa-chevron-right group-toggle-icon"></i><span>${code}</span><span class="group-count">${items.length}</span>`;
                const content = document.createElement('div'); content.className = 'data-group-content';
                header.addEventListener('click', () => {
                    const isHidden = content.style.display === 'none' || content.style.display === '';
                    content.style.display = isHidden ? 'flex' : 'none';
                    header.querySelector('.group-toggle-icon').className = isHidden ? 'fa-solid fa-chevron-down group-toggle-icon' : 'fa-solid fa-chevron-right group-toggle-icon';
                });
                items.forEach(it => {
                    const item = document.createElement('div'); item.className = 'data-item';
                    let t = it.start; if (unit === 'ms') t /= 1000;
                    item.innerHTML = `<span>${it.label || '-'}</span><span class="scene-time">${formatTime(t)}</span>`;
                    item.addEventListener('click', () => jumpToTime(t));
                    item.addEventListener('touchstart', (e) => { e.preventDefault(); jumpToTime(t); }, { passive: false });
                    content.appendChild(item);
                });
                group.appendChild(header); group.appendChild(content); listEl.appendChild(group);
            }
        }

        // --- ğŸ› ï¸ ë‹¨ì¶•í‚¤ ì‹œìŠ¤í…œ ---
        let shortcutConfig = {
            'select': { label: 'ì„ íƒ ëª¨ë“œ', key: 's', btnId: 'btn-select' },
            'drawPen': { label: 'íœ/ì—°í•„', key: 'p', btnId: 'btn-drawPen' },
            'drawArrow': { label: 'ì§ì„  í™”ì‚´í‘œ', key: 'a', btnId: 'btn-drawArrow' },
            'drawCurve': { label: 'ê³¡ì„  í™”ì‚´í‘œ', key: 'c', btnId: 'btn-drawCurve' },
            'drawPolyline': { label: 'ë‹¤ì¤‘ ì„ ', key: 'l', btnId: 'btn-drawPolyline' },
            'drawPolygon': { label: 'ë‹¤ê°í˜•', key: 'g', btnId: 'btn-drawPolygon' },
            'drawSpot': { label: 'ìŠ¤íŒŸ (í•˜ì´ë¼ì´íŠ¸)', key: 'h', btnId: 'btn-drawSpot' },
            'drawPlayerTag': { label: 'ì„ ìˆ˜ íƒœê·¸', key: 't', btnId: 'btn-drawPlayerTag' },
            'addText': { label: 'í…ìŠ¤íŠ¸ ì‚½ì…', key: 'x', btnId: 'btn-addText' },
            'deleteObj': { label: 'ì„ íƒí•œ ìš”ì†Œ ì‚­ì œ', key: 'Delete', btnId: 'btn-deleteObj' },
            'clearAll': { label: 'ì „ì²´ ë“œë¡œì‰ ì§€ìš°ê¸°', key: 'Escape', btnId: 'btn-clearAll' },
            'videoToggle': { label: 'ì˜ìƒ ì¬ìƒ/ì •ì§€', key: ' ', btnId: 'btn-play-scrubber' }
        };

        function initShortcuts() {
            const list = document.getElementById('shortcut-list'); if (list) list.innerHTML = '';
            for (const [id, cfg] of Object.entries(shortcutConfig)) {
                if (list) {
                    const row = document.createElement('div'); row.className = 'shortcut-row';
                    row.innerHTML = `<span>${cfg.label}</span><input type="text" class="shortcut-input" value="${cfg.key === ' ' ? 'Space' : cfg.key}" readonly onclick="this.value='...'">`;
                    const input = row.querySelector('input');
                    input.onkeydown = (e) => { e.preventDefault(); cfg.key = e.key; input.value = e.key === ' ' ? 'Space' : e.key; updateShortcutUI(); };
                    list.appendChild(row);
                }
            }
            updateShortcutUI();
        }

        function updateShortcutUI() {
            document.querySelectorAll('.shortcut-badge').forEach(b => b.remove());
            for (const [id, cfg] of Object.entries(shortcutConfig)) {
                const btn = document.getElementById(cfg.btnId);
                if (btn) {
                    const badge = document.createElement('div');
                    badge.className = 'shortcut-badge';
                    let disp = cfg.key.toUpperCase();
                    if (disp === ' ') disp = 'SPC';
                    if (disp === 'ESCAPE') disp = 'ESC';
                    if (disp === 'DELETE') disp = 'DEL';
                    if (disp === 'ARROWLEFT' || disp === 'ARROWRIGHT' || disp === 'ARROWUP' || disp === 'ARROWDOWN') disp = 'KEY';
                    badge.innerText = disp;
                    btn.appendChild(badge);
                }
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' && e.target.type !== 'range') return;
            if (e.target.tagName === 'TEXTAREA' || (e.target.isContentEditable && e.target.tagName !== 'BODY')) return;
            const key = e.key;
            if (key === shortcutConfig.select.key) setMode('select');
            else if (key === shortcutConfig.drawPen.key) setMode('drawPen');
            else if (key === shortcutConfig.drawArrow.key) setMode('drawArrow');
            else if (key === shortcutConfig.drawCurve.key) setMode('drawCurve');
            else if (key === shortcutConfig.drawPolyline.key) setMode('drawPolyline');
            else if (key === shortcutConfig.drawPolygon.key) setMode('drawPolygon');
            else if (key === shortcutConfig.drawSpot.key) setMode('drawSpot');
            else if (key === shortcutConfig.drawPlayerTag.key) setMode('drawPlayerTag');
            else if (key === shortcutConfig.addText.key) addText();
            else if (key === shortcutConfig.deleteObj.key) deleteObject();
            else if (key === shortcutConfig.clearAll.key) clearAll();
            else if (key === ' ' || key === shortcutConfig.videoToggle.key) { e.preventDefault(); videoControl('toggle'); }
            else if (key === 'ArrowLeft') { e.preventDefault(); videoControl('rewind'); }
            else if (key === 'ArrowRight') { e.preventDefault(); videoControl('forward'); }
        });

        function completeDrawing() {
            DrawingHandler.completeComplexShape(canvas, currentMode, pointArray, activePoints, activeLines, currentColor, currentOpacity, typeof isDashed !== 'undefined' ? isDashed : false);
            resetDrawing(); setMode('select');
        }

        // --- ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° ---
        function startCleanRecording() { alert("ì¶”ì¶œ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ìº¡ì²˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”."); }
        function saveShortcuts() { alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); toggleHelp(); }
        function deleteObject() { if (!canvas) return; const active = canvas.getActiveObjects(); if (active.length) { canvas.discardActiveObject(); active.forEach(o => canvas.remove(o)); } }
        function clearAll() { if (!canvas) return; if (confirm("ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) canvas.clear(); }
        function resetDrawing() { pointArray = []; activePoints = []; activeLines = []; componentArray = []; isDrawing = false; document.getElementById('btn-finish').classList.remove('show'); }
        function formatTime(s) { if (isNaN(s) || !isFinite(s)) return "0:00"; const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec < 10 ? '0' + sec : sec}`; }
        function jumpToTime(s) { const t = s + timeOffset; if (currentMediaType === 'youtube' && isYtReady) ytPlayer.seekTo(t, true); else if (currentMediaType === 'local') { const v = document.getElementById('local-video'); if (v) v.currentTime = t; } }
        function adjustSync(v) { timeOffset += v; document.getElementById('syncDisplay').innerText = `Sync: ${timeOffset.toFixed(1)}s`; }
        function toggleHelp() { const m = document.getElementById('helpModal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }

        // --- ğŸ¨ Drawing Handler Core (Provided by User) ---
        const DrawingHandler = {
            createSpot: function (canvas, p, color, size, opacity) {
                const spot = new fabric.Ellipse({
                    left: p.x, top: p.y, rx: size, ry: size * 0.4,
                    fill: hexToMutedRgba(color, opacity), stroke: getStrokeGradient(color), strokeWidth: 4,
                    originX: 'center', originY: 'center', shadow: new fabric.Shadow({ color: color, blur: 20 })
                });
                canvas.add(spot);
            },
            createArrow: function (canvas, s, e, color, size, isDashed) {
                const headSize = size; const angle = Math.atan2(e.y - s.y, e.x - s.x) * 180 / Math.PI; const lineLen = Math.sqrt(Math.pow(e.x - s.x, 2) + Math.pow(e.y - s.y, 2)); const midX = (s.x + e.x) / 2; const midY = (s.y + e.y) / 2;
                const linePath = `M ${-lineLen / 2} 0 L ${lineLen / 2 - headSize + 5} 0`;
                const line = new fabric.Path(linePath, { stroke: color, strokeWidth: 4, strokeDashArray: isDashed ? [10, 5] : false, fill: '', originX: 'center', originY: 'center' });
                const head = new fabric.Triangle({ width: headSize, height: headSize, fill: color, angle: 90, left: lineLen / 2, top: 0, originX: 'center', originY: 'center' });
                const arrowGroup = new fabric.Group([line, head], { left: midX, top: midY, angle: angle, originX: 'center', originY: 'center', shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.8)', blur: 8, offsetX: 2, offsetY: 2 }) });
                canvas.add(arrowGroup);
            },
            startCurve: function (canvas, s, e, color, size, isDashed) {
                const mid = { x: (s.x + e.x) / 2, y: (s.y + e.y) / 2 }; const cp = { x: mid.x, y: mid.y - 50 };
                const curve = new fabric.CurvedArrow(s, cp, e, { stroke: color, strokeWidth: 4, headSize: size, strokeDashArray: isDashed ? [10, 5] : false, objectCaching: false });
                canvas.add(curve); canvas.setActiveObject(curve);
            },
            completeComplexShape: function (canvas, mode, pointArray, activePoints, activeLines, color, opacity, isDashed) {
                if (pointArray.length < 2) return;
                if (mode === 'drawPolyline') {
                    const objects = canvas.getObjects().filter(obj => activePoints.includes(obj) || activeLines.includes(obj));
                    const group = new fabric.Group(objects, { selectable: true });
                    objects.forEach(o => canvas.remove(o)); canvas.add(group);
                } else if (mode === 'drawPolygon') {
                    const poly = new fabric.Polygon(pointArray, { fill: hexToMutedRgba(color, opacity), stroke: color, strokeWidth: 2, strokeDashArray: isDashed ? [10, 5] : false, objectCaching: false });
                    activePoints.concat(activeLines).forEach(o => canvas.remove(o)); canvas.add(poly); canvas.setActiveObject(poly);
                }
            }
        };

        fabric.CurvedArrow = fabric.util.createClass(fabric.Object, {
            type: 'curvedArrow',
            initialize: function (p0, p1, p2, options) {
                this.p0 = p0; this.p1 = p1; this.p2 = p2; options = options || {}; this.callSuper('initialize', options);
                this.headSize = options.headSize || 30; this.strokeWidth = options.strokeWidth || 5; this.stroke = options.stroke || '#fff'; this.strokeDashArray = options.strokeDashArray || false;
                this._updateBoundingBox(); this.prevLeft = this.left; this.prevTop = this.top;
                this.on('moving', () => { const dx = this.left - this.prevLeft; const dy = this.top - this.prevTop;[this.p0, this.p1, this.p2].forEach(p => { p.x += dx; p.y += dy; }); this.prevLeft = this.left; this.prevTop = this.top; });
                this.on('selected', () => { this.prevLeft = this.left; this.prevTop = this.top; });
            },
            _updateBoundingBox: function () { const minX = Math.min(this.p0.x, this.p1.x, this.p2.x); const maxX = Math.max(this.p0.x, this.p1.x, this.p2.x); const minY = Math.min(this.p0.y, this.p1.y, this.p2.y); const maxY = Math.max(this.p0.y, this.p1.y, this.p2.y); this.left = minX; this.top = minY; this.width = maxX - minX; this.height = maxY - minY; },
            _render: function (ctx) {
                ctx.save(); ctx.beginPath(); ctx.lineWidth = this.strokeWidth; ctx.strokeStyle = this.stroke; ctx.lineCap = 'round'; if (this.strokeDashArray) ctx.setLineDash(this.strokeDashArray);
                const p0 = this.toLocalPoint(new fabric.Point(this.p0.x, this.p0.y), 'center', 'center'); const p1 = this.toLocalPoint(new fabric.Point(this.p1.x, this.p1.y), 'center', 'center'); const p2 = this.toLocalPoint(new fabric.Point(this.p2.x, this.p2.y), 'center', 'center');
                ctx.moveTo(p0.x, p0.y); ctx.quadraticCurveTo(p1.x, p1.y, p2.x, p2.y); ctx.stroke(); ctx.setLineDash([]);
                let dx = p2.x - p1.x; let dy = p2.y - p1.y; if (dx === 0 && dy === 0) { dx = p1.x - p0.x; dy = p1.y - p0.y; }
                const angle = Math.atan2(dy, dx); ctx.translate(p2.x, p2.y); ctx.rotate(angle); ctx.beginPath(); const s = this.headSize; ctx.moveTo(0, 0); ctx.lineTo(-s, s / 2); ctx.lineTo(-s, -s / 2); ctx.closePath(); ctx.fillStyle = this.stroke; ctx.fill(); ctx.restore();
            }
        });

        fabric.CurvedArrow.prototype.controls = {};
        function createControl(key, color) { return new fabric.Control({ position: { x: 0, y: 0 }, actionName: key, cursorStyle: 'pointer', actionHandler: function (eventData, transform, x, y) { const target = transform.target; target[key] = { x: x, y: y }; target._updateBoundingBox(); target.prevLeft = target.left; target.prevTop = target.top; return true; }, positionHandler: function (dim, finalMatrix, fabricObject) { const point = fabricObject[key]; return fabric.util.transformPoint(new fabric.Point(point.x, point.y), canvas.viewportTransform); }, render: function (ctx, left, top, styleOverride, fabricObject) { ctx.save(); ctx.translate(left, top); ctx.beginPath(); ctx.arc(0, 0, 6, 0, 2 * Math.PI); ctx.fillStyle = color; ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.fill(); ctx.stroke(); ctx.restore(); } }); }
        fabric.CurvedArrow.prototype.controls.p0 = createControl('p0', '#ffffff'); fabric.CurvedArrow.prototype.controls.p1 = createControl('p1', '#3498db'); fabric.CurvedArrow.prototype.controls.p2 = createControl('p2', '#ffffff');

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const content = document.getElementById(id);
            if (content) content.classList.add('active');
            // ëŒ€ì‘í•˜ëŠ” íƒ­ ë²„íŠ¼ë„ active ì²˜ë¦¬
            const btnId = 'tab-btn-' + id.replace('tab-', '');
            const btn = document.getElementById(btnId);
            if (btn) btn.classList.add('active');
        }
        function toggleSceneSidebar() { document.getElementById('sceneSidebar').classList.toggle('closed'); document.getElementById('sceneToggleIcon').className = document.getElementById('sceneSidebar').classList.contains('closed') ? 'fa-solid fa-chevron-left' : 'fa-solid fa-chevron-right'; setTimeout(resizeCanvas, 350); }
        function setColor(hex, el) { currentColor = hex; document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); if (canvas && canvas.isDrawingMode) canvas.freeDrawingBrush.color = hex; }

        function togglePalm() { isPalmRejection = !isPalmRejection; document.getElementById('btn-palm').classList.toggle('active'); }
        function switchModalTab(t) { document.getElementById('m-guide').classList.toggle('active', t === 'guide'); document.getElementById('m-shortcuts').classList.toggle('active', t === 'shortcuts'); if (t === 'shortcuts') initShortcuts(); }
        function showStatus(m, rec = false) { const el = document.getElementById('status-msg'); el.innerText = m; el.style.display = 'block'; if (!rec) setTimeout(() => el.style.display = 'none', 3000); }
        function saveScene() {
            if (!canvas) return;
            const art = JSON.stringify(canvas.toJSON());
            let t = 0; if (currentMediaType === 'local') t = document.getElementById('local-video').currentTime; else if (isYtReady) t = ytPlayer.getCurrentTime();
            const item = document.createElement('div'); item.className = 'scene-item';
            item.innerHTML = `<div class="scene-info"><span>Scene ${document.getElementById('sceneList').children.length + 1}</span><span class="scene-time">${formatTime(t)}</span></div><button class="scene-del-btn">Ã—</button>`;

            item.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    canvas.loadFromJSON(art, canvas.renderAll.bind(canvas));
                    jumpToTime(t);
                }
            });
            item.addEventListener('touchstart', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    e.preventDefault();
                    canvas.loadFromJSON(art, canvas.renderAll.bind(canvas));
                    jumpToTime(t);
                }
            }, { passive: false });

            item.querySelector('.scene-del-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                item.remove();
            });
            document.getElementById('sceneList').appendChild(item);
        }
        function loadAdminConfig() { const saved = localStorage.getItem('gh_admin_config'); if (saved) { const cfg = JSON.parse(saved); if (cfg.token) document.getElementById('gh-token').value = cfg.token; if (cfg.owner) document.getElementById('gh-owner').value = cfg.owner; if (cfg.repo) document.getElementById('gh-repo').value = cfg.repo; } }
        function saveAdminConfig() { const cfg = { token: document.getElementById('gh-token').value, owner: document.getElementById('gh-owner').value, repo: document.getElementById('gh-repo').value }; localStorage.setItem('gh_admin_config', JSON.stringify(cfg)); }
        function toggleLang() { }
        function addText() { if (!canvas) return; const t = new fabric.IText('í…ìŠ¤íŠ¸', { left: canvas.width / 2, top: canvas.height / 2, fill: currentColor, fontFamily: 'S-CoreDream-6Bold', fontSize: 30 }); canvas.add(t); canvas.setActiveObject(t); }
    </script>
</body>

</html>
