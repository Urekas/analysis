<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Tactical Board - v96 Full Restoration & Integrated</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- üî• Google API Î∞è GIS Î°úÎìú -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        @font-face { font-family: 'S-CoreDream-6Bold'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-6Bold.woff') format('woff'); font-weight: normal; font-style: normal; }
        :root { --bg-color: #1a1a1a; --panel-bg: #2d2d2d; --accent: #e74c3c; --text: #eee; --sidebar-width: 280px; }
        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text); font-family: 'S-CoreDream-6Bold', sans-serif; overflow: hidden; display: flex; height: 100vh; user-select: none; -webkit-user-select: none; }

        /* Ï¢åÏ∏° ÏÇ¨Ïù¥ÎìúÎ∞î */
        .sidebar { width: 80px; background: var(--panel-bg); display: flex; flex-direction: column; align-items: center; padding-top: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 20; overflow-y: auto; flex-shrink: 0; }
        .sidebar::-webkit-scrollbar { width: 0; }
        .tool-btn { width: 50px; height: 50px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aaa; font-size: 1.4rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; position: relative; flex-shrink: 0; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.3); }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
        .tool-btn::after { content: attr(data-shortcut); position: absolute; bottom: 2px; right: 4px; font-size: 0.6rem; opacity: 0.5; font-family: monospace; }
        .divider { width: 40px; height: 1px; background: #444; margin: 10px 0; flex-shrink: 0; }
        #btn-palm.active { background: #2ecc71; border-color: #2ecc71; color: white; }
        .finish-btn { color: #2ecc71; border-color: #2ecc71; display: none; } .finish-btn.show { display: flex; animation: bounce 0.5s; }
        
        /* Ï§ëÏïô ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ */
        .workspace { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; position: relative; }
        .media-container { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #000; }
        
        #youtube-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; pointer-events: none; }
        #local-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; object-fit: contain; }
        .canvas-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }

        /* Ïä§ÌÅ¨Îü¨Î≤Ñ */
        .scrubber-area { height: 50px; width: 100%; background: #111; display: none; align-items: center; justify-content: center; padding: 0 20px; box-sizing: border-box; border-top: 1px solid #333; flex-shrink: 0; z-index: 10; }
        .scrubber-input { flex: 1; -webkit-appearance: none; height: 8px; background: #444; border-radius: 5px; cursor: pointer; margin: 0 15px; }
        .scrubber-input::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #e67e22; border-radius: 50%; cursor: pointer; transition: 0.1s; }
        .scrubber-input::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .time-display { font-family: monospace; color: #ccc; font-size: 0.9rem; min-width: 100px; text-align: center; }

        /* ÌïòÎã® Ìå®ÎÑê */
        .bottom-panel { height: 70px; width: 100%; background: var(--panel-bg); display: flex; justify-content: center; align-items: center; border-top: 1px solid #444; z-index: 20; flex-shrink: 0; }
        .control-bar { display: flex; gap: 15px; align-items: center; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; position: relative; overflow: hidden; }
        .color-dot:hover { transform: scale(1.1); } .color-dot.selected { border-color: white; box-shadow: 0 0 0 2px var(--bg-color); transform: scale(1.1); }
        .c-white { background: #ffffff; } .c-red { background: #e63946; } .c-yellow { background: #ffbe0b; } .c-blue { background: #3a86ff; } .c-green { background: #2ecc71; } .c-black { background: #000000; border: 1px solid #555; }
        .slider-group { display: flex; align-items: center; gap: 8px; color: #aaa; font-size: 0.9rem; }
        input[type=range] { -webkit-appearance: none; width: 80px; height: 5px; background: #555; border-radius: 5px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #555; background: #333; color: #aaa; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .toggle-btn:hover { color: white; background: #444; } .toggle-btn.active { background: #3498db; color: white; border-color: #3498db; }
        
        #status-msg { 
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); padding: 10px 25px; border-radius: 30px; 
            font-size: 1rem; color: #fff; border: 1px solid rgba(255,255,255,0.2); 
            z-index: 100; pointer-events: none; transition: opacity 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none;
        }
        .rec-blink { animation: blink 1s infinite; color: #e74c3c; margin-right: 8px; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }

        #guide-msg { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(231, 76, 60, 0.9); color: white; padding: 10px 25px; border-radius: 30px; font-size: 1rem; font-weight: bold; pointer-events: none; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); animation: fadeIn 0.3s; z-index: 100; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -10px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .file-input { display: none; }
        
        /* Ïö∞Ï∏° ÏÇ¨Ïù¥ÎìúÎ∞î (Îç∞Ïù¥ÌÑ∞ Î™©Î°ù) */
        .scene-sidebar { width: var(--sidebar-width); background: #222; border-left: 1px solid #444; display: flex; flex-direction: column; padding: 0; box-shadow: -2px 0 10px rgba(0,0,0,0.5); z-index: 30; transition: width 0.3s ease; overflow: hidden; flex-shrink: 0; }
        .scene-sidebar.closed { width: 0; padding: 0; border: none; }
        .sidebar-toggle-area { position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 40; }
        .scene-toggle-btn { width: 25px; height: 50px; background: #222; border: 1px solid #444; border-right: none; border-radius: 10px 0 0 10px; color: #aaa; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; box-shadow: -2px 0 5px rgba(0,0,0,0.3); }
        .scene-toggle-btn:hover { background: #333; color: white; }
        .sidebar-tabs { display: flex; border-bottom: 1px solid #444; background: #2d2d2d; min-width: 100%; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 15px 0; background: none; border: none; color: #888; cursor: pointer; font-size: 0.9rem; font-family: 'S-CoreDream-6Bold'; transition: 0.2s; }
        .tab-btn:hover { color: #ccc; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); background: #333; }
        .tab-content { flex: 1; overflow-y: auto; display: none; padding: 15px; flex-direction: column; gap: 10px; min-width: 100%; box-sizing: border-box; }
        .tab-content.active { display: flex; }
        
        /* üî• Îç∞Ïù¥ÌÑ∞ Í∑∏Î£πÌôî Ïä§ÌÉÄÏùº (XML/CSV) */
        .data-group { margin-bottom: 8px; display: flex; flex-direction: column; }
        .data-group-header { background: #3a3a3a; padding: 10px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: bold; color: #fff; border: 1px solid #444; transition: background 0.2s; user-select: none; }
        .data-group-header:hover { background: #4a4a4a; border-color: #555; }
        .group-toggle-icon { font-size: 0.8rem; color: #aaa; width: 14px; text-align: center; transition: transform 0.2s; }
        .group-count { background: var(--accent); color: #fff; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; margin-left: auto; font-family: monospace; }
        .data-group-content { display: none; flex-direction: column; gap: 5px; padding-top: 5px; overflow: hidden; } /* Í∏∞Î≥∏ Ï†ëÌûò */
        
        .data-item { background: #2a2a2a; padding: 10px 12px; border-radius: 0 6px 6px 0; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; cursor: pointer; transition: 0.2s; margin-left: 10px; }
        .data-item:hover { background: #383838; border-left-color: var(--accent); }
        .data-label { font-size: 0.85rem; color: #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 3px; }

        /* Ïª®Ìä∏Î°§ Î∞ïÏä§ */
        .control-box { background: #333; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .sync-control { display: flex; justify-content: space-between; align-items: center; }
        .sync-btn { background: #444; border: none; color: #eee; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; }
        .sync-btn:hover { background: #555; }
        .sync-display { color: var(--accent); font-family: monospace; font-size: 0.9rem; }
        .unit-select { width: 100%; background: #444; color: #eee; border: 1px solid #555; padding: 5px; border-radius: 5px; font-size: 0.85rem; cursor: pointer; }

        .top-menu { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 100; }
        .top-btn { background: rgba(0,0,0,0.6); color: #ccc; border: 1px solid #555; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-family: 'S-CoreDream-6Bold'; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .top-btn:hover { background: #e74c3c; color: white; border-color: #e74c3c; }

        .scene-item { background: #333; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: 0.2s; }
        .scene-item:hover { background: #444; border-color: #666; }
        .scene-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; flex: 1; cursor: pointer; padding: 0 5px; }
        .scene-title { color: #fff; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
        .scene-time { color: var(--accent); font-size: 0.8rem; font-family: monospace; }
        .scene-del-btn { color: #888; background: none; border: none; cursor: pointer; padding: 5px; flex-shrink: 0; }
        .scene-del-btn:hover { color: #e74c3c; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar, .bottom-panel, .sidebar-toggle-area { display: none !important; }
            .workspace { flex: none; height: 45vh; width: 100%; border-bottom: 2px solid var(--accent); }
            .scene-sidebar { width: 100%; flex: 1; border-left: none; height: 55vh; }
            .scene-sidebar.closed { width: 100%; height: 55vh; } 
            .top-menu { top: 10px; right: 10px; gap: 5px; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <!-- üî• Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å Ïó∞Îèô Î≤ÑÌäº -->
        <button class="tool-btn" id="btn-gdrive" style="background:#f39c12; color:white; border:none;" onclick="authAndPickDriveFile()" title="Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å Ïó¥Í∏∞ (OAuth)"><i class="fa-brands fa-google-drive"></i></button>
        <div class="divider"></div>

        <label for="imgInput" class="tool-btn" style="background:#2ecc71; color:white; border:none;" title="ÏÇ¨ÏßÑ Ïó¥Í∏∞"><i class="fa-solid fa-image"></i></label>
        <input type="file" id="imgInput" class="file-input" accept="image/*">
        <label for="videoInput" class="tool-btn" style="background:#3498db; color:white; border:none;" title="ÌååÏùº ÏòÅÏÉÅ Ïó¥Í∏∞ (PC/MacÏö©)"><i class="fa-solid fa-file-video"></i></label>
        <input type="file" id="videoInput" class="file-input" accept="video/*">
        <label for="dataInput" class="tool-btn" style="background:#9b59b6; color:white; border:none;" title="Îç∞Ïù¥ÌÑ∞ Ïó¥Í∏∞ (XML/CSV)"><i class="fa-solid fa-file-lines"></i></label>
        <input type="file" id="dataInput" class="file-input" accept=".xml,.csv">
        <button class="tool-btn" style="background:#e63946; color:white; border:none;" onclick="loadYoutubePrompt()" title="Ïú†ÌäúÎ∏å Ï£ºÏÜå Ïó¥Í∏∞"><i class="fa-brands fa-youtube"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" id="btn-rewind" onclick="videoControl('rewind')" title="-5Ï¥à Ïù¥Îèô"><i class="fa-solid fa-backward-step"></i></button>
        <button class="tool-btn" id="btn-play" onclick="videoControl('toggle')" title="Ïû¨ÏÉù/Ï†ïÏßÄ"><i class="fa-solid fa-play"></i></button>
        <button class="tool-btn" id="btn-forward" onclick="videoControl('forward')" title="+5Ï¥à Ïù¥Îèô"><i class="fa-solid fa-forward-step"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" id="btn-palm" onclick="togglePalm()" title="ÌÑ∞Ïπò Î∞©ÏßÄ (Ìéú Ï†ÑÏö©)"><i class="fa-solid fa-hand-pointer"></i></button>
        <div class="divider"></div>
        <button class="tool-btn active" id="btn-select" onclick="setMode('select')" title="ÏÑ†ÌÉù Î™®Îìú"><i class="fa-solid fa-arrow-pointer"></i></button>
        <button class="tool-btn" id="btn-drawPlayerTag" onclick="setMode('drawPlayerTag')" title="Ïä§ÎßàÌä∏ ÏÑ†Ïàò ÌÉúÍ∑∏"><i class="fa-solid fa-tag"></i></button>
        <button class="tool-btn" id="btn-drawPen" onclick="setMode('drawPen')" title="ÏûêÏú† Ìéú"><i class="fa-solid fa-pen"></i></button>
        <button class="tool-btn" id="btn-addText" onclick="addText()" title="ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä"><i class="fa-solid fa-font"></i></button>
        <button class="tool-btn" id="btn-drawSpot" onclick="setMode('drawSpot')" title="ÌïòÏù¥ÎùºÏù¥Ìä∏"><i class="fa-regular fa-circle"></i></button>
        <button class="tool-btn" id="btn-drawPolyline" onclick="setMode('drawPolyline')" title="Îã§Ï§ë ÏÑ†"><i class="fa-solid fa-share-nodes"></i></button>
        <button class="tool-btn" id="btn-drawArrow" onclick="setMode('drawArrow')" title="ÌôîÏÇ¥Ìëú"><i class="fa-solid fa-arrow-right-long"></i></button>
        <button class="tool-btn" id="btn-drawCurve" onclick="setMode('drawCurve')" title="Í≥°ÏÑ†"><i class="fa-solid fa-arrow-turn-up"></i></button>
        <button class="tool-btn" id="btn-drawPolygon" onclick="setMode('drawPolygon')" title="Îã§Í∞ÅÌòï"><i class="fa-solid fa-draw-polygon"></i></button>
        <button class="tool-btn finish-btn" id="btn-finish" onclick="completeDrawing()"><i class="fa-solid fa-check"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" style="color:#f1c40f;" onclick="saveScene()" title="ÌòÑÏû¨ Ïû•Î©¥ Ï†ÄÏû• (Ïö∞Ï∏° Î™©Î°ùÏóê Ï∂îÍ∞Ä)"><i class="fa-solid fa-floppy-disk"></i></button>
        <button class="tool-btn" id="btn-record" style="color:#e67e22;" onclick="startCleanRecording()" title="ÏãúÌÄÄÏä§ Í≥†ÌôîÏßà ÏòÅÏÉÅ Ï∂îÏ∂ú"><i class="fa-solid fa-clapperboard"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" id="btn-delete" style="color:#e74c3c;" onclick="deleteObject()" title="ÏÑ†ÌÉùÌïú Í∑∏Î¶º ÏßÄÏö∞Í∏∞"><i class="fa-solid fa-trash"></i></button>
        <button class="tool-btn" style="color:#ff6b6b; border-color:#ff6b6b;" onclick="clearAll()" title="ÌôîÎ©¥ Í∑∏Î¶º Î™®Îëê ÏßÄÏö∞Í∏∞"><i class="fa-solid fa-eraser"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" style="color:#3498db;" onclick="downloadImage()" title="Î∂ÑÏÑùÌôîÎ©¥ Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•"><i class="fa-solid fa-download"></i></button>
    </div>

    <div class="workspace">
        <div class="sidebar-toggle-area">
            <div class="scene-toggle-btn" onclick="toggleSceneSidebar()" title="ÏÇ¨Ïù¥ÎìúÎ∞î Ï†ëÍ∏∞/Ìé¥Í∏∞"><i class="fa-solid fa-chevron-right" id="sceneToggleIcon"></i></div>
        </div>
        <div class="top-menu">
            <button class="top-btn" onclick="toggleLang()"><i class="fa-solid fa-globe"></i> <span id="langText">KR | EN</span></button>
            <button class="top-btn" onclick="toggleHelp()"><i class="fa-solid fa-gear"></i> Í∞ÄÏù¥Îìú</button>
        </div>
        <div id="status-msg">ÎØ∏ÎîîÏñ¥Î•º Î∂àÎü¨ÏôÄ ÏãúÏûëÌïòÏÑ∏Ïöî.</div>
        <div id="guide-msg">ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ ÎèÑÌòï ÏôÑÏÑ±</div>
        <div class="media-container" id="mediaContainer">
            <div id="youtube-player"></div>
            <video id="local-video" playsinline crossOrigin="anonymous"></video>
            <div class="canvas-wrapper"><canvas id="c"></canvas></div>
        </div>
        <div class="scrubber-area" id="videoScrubber">
            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            <input type="range" class="scrubber-input" id="timeSlider" min="0" max="100" value="0" step="0.1">
        </div>
        <div class="bottom-panel">
            <div class="control-bar">
                <div style="display:flex; gap:8px;">
                    <div class="color-dot c-white selected" onclick="setColor('#ffffff', this)"></div>
                    <div class="color-dot c-red" onclick="setColor('#e63946', this)"></div>
                    <div class="color-dot c-yellow" onclick="setColor('#ffbe0b', this)"></div>
                    <div class="color-dot c-blue" onclick="setColor('#3a86ff', this)"></div>
                    <div class="color-dot c-green" onclick="setColor('#2ecc71', this)"></div>
                    <div class="color-dot c-black" onclick="setColor('#000000', this)"></div>
                    <div id="customColorBtn1" class="color-dot" style="background:linear-gradient(135deg, #eee, #999);"><input type="color" oninput="setCustomColor(this.value, 1)" style="opacity:0; width:100%; height:100%; cursor:pointer;"></div>
                    <div id="customColorBtn2" class="color-dot" style="background:linear-gradient(135deg, #555, #000);"><input type="color" oninput="setCustomColor(this.value, 2)" style="opacity:0; width:100%; height:100%; cursor:pointer;"></div>
                </div>
                <div style="width:1px; height:30px; background:#555;"></div>
                <div id="dashBtn" class="toggle-btn" onclick="toggleDash()" title="Ï†êÏÑ† Î≥ÄÍ≤Ω"><i class="fa-solid fa-ellipsis"></i></div>
                <div id="nodeBtn" class="toggle-btn" onclick="toggleNodeMode()" title="ÎÖ∏Îìú Î™®Ïñë Î≥ÄÍ≤Ω"><i class="fa-solid fa-circle-nodes"></i></div>
                <div style="width:1px; height:30px; background:#555;"></div>
                <div class="slider-group"><i class="fa-solid fa-up-right-and-down-left-from-center"></i><input type="range" id="sizeSlider" min="10" max="100" value="40"></div>
                <div class="slider-group"><i class="fa-solid fa-circle-half-stroke"></i><input type="range" id="opacitySlider" min="10" max="100" value="20"></div>
            </div>
        </div>
    </div>

    <div class="scene-sidebar" id="sceneSidebar">
        <div class="sidebar-tabs">
            <button class="tab-btn active" onclick="openTab('tab-scenes')">Ï†ÄÏû•Îêú Ïû•Î©¥</button>
            <button class="tab-btn" onclick="openTab('tab-data')">Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù</button>
        </div>
        <div id="tab-scenes" class="tab-content active"><div class="scene-list" id="sceneList"></div></div>
        <div id="tab-data" class="tab-content">
            <div class="control-box">
                <select id="timeUnit" class="unit-select" onchange="renderDataList()">
                    <option value="sec" selected>Îã®ÏúÑ: 1Ï¥à (Í∏∞Î≥∏)</option>
                    <option value="ms">Îã®ÏúÑ: 1/1000Ï¥à</option>
                    <option value="cs">Îã®ÏúÑ: 1/100Ï¥à</option>
                </select>
                <div class="sync-control">
                    <button class="sync-btn" onclick="adjustSync(-0.1)">-0.1</button>
                    <span class="sync-display" id="syncDisplay">Sync: 0.0s</span>
                    <button class="sync-btn" onclick="adjustSync(0.1)">+0.1</button>
                </div>
            </div>
            <div class="scene-list" id="dataList"></div>
        </div>
    </div>

    <!-- Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å Ïù∏Ï¶ùÏùÑ ÏúÑÌïú Îπà API ÌÇ§ (ÌôòÍ≤ΩÏóêÏÑú Ï†úÍ≥µ) -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- üîó Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å Î∞è URL ÌÜµÌï© Î°úÏßÅ ---
        function getDriveDirectLink(url) {
            if (!url) return null;
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
            if (driveMatch && driveMatch[1]) {
                return `https://docs.google.com/uc?id=${driveMatch[1]}&export=download`;
            }
            return url;
        }

        async function fetchExternalData(url) {
            let finalUrl = getDriveDirectLink(url);
            showStatus("Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù ÌååÏùºÏùÑ ÏùΩÏñ¥Ïò§Îäî Ï§ë...", true);
            try {
                // AllOrigins ÌîÑÎ°ùÏãúÎ•º ÌÜµÌïú CORS Ïö∞Ìöå
                const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(finalUrl);
                let response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("ÎÑ§Ìä∏ÏõåÌÅ¨ ÏùëÎãµ ÏóêÎü¨");
                let text = await response.text();
                if (text.trim().toLowerCase().startsWith("<!doctype html") || text.includes("<html")) {
                    throw new Error("Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å Î≥¥Ïïà Ï†ïÏ±ÖÏóê ÏùòÌï¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§. Í≥µÏú† Í∂åÌïúÏùÑ 'ÎßÅÌÅ¨Í∞Ä ÏûàÎäî Î™®Îì† ÏÇ¨Ïö©Ïûê'Î°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.");
                }
                return text;
            } catch (e) {
                console.error(e);
                throw new Error("ÌååÏùº Î°úÎìú Ïã§Ìå®: " + e.message);
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('video');
            const dataUrl = urlParams.get('data');

            if (videoUrl) {
                const ytMatch = videoUrl.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/i);
                if (ytMatch && ytMatch[1]) {
                    const checkYt = setInterval(() => {
                        if (isYtReady && ytPlayer && ytPlayer.loadVideoById) {
                            clearInterval(checkYt);
                            switchMode('youtube');
                            ytPlayer.loadVideoById(ytMatch[1]);
                        }
                    }, 500);
                } else {
                    switchMode('local');
                    localVideo.src = videoUrl;
                    localVideo.load();
                }
            }

            if (dataUrl) {
                try {
                    const content = await fetchExternalData(dataUrl);
                    parseSportsCodeXML(content);
                    openTab('tab-data');
                } catch (err) {
                    alert(err.message);
                }
            }
        });

        // --- üìä Îç∞Ïù¥ÌÑ∞ Î†åÎçîÎßÅ Î∞è Í∑∏Î£π Ï†ëÍ∏∞ ---
        let eventList = [];
        let timeOffset = 0.0;

        function parseSportsCodeXML(text) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            const instances = xmlDoc.getElementsByTagName("instance");
            eventList = [];
            for (let i = 0; i < instances.length; i++) {
                const inst = instances[i];
                const start = parseFloat(inst.getElementsByTagName("start")[0]?.textContent || 0);
                const code = inst.getElementsByTagName("code")[0]?.textContent || "Event";
                let labelText = "";
                const labels = inst.getElementsByTagName("label");
                if(labels.length > 0) labelText = labels[0].getElementsByTagName("text")[0]?.textContent || "";
                eventList.push({ start, code, label: labelText });
            }
            renderDataList();
        }

        function renderDataList() {
            const unit = document.getElementById('timeUnit').value;
            const listEl = document.getElementById('dataList'); listEl.innerHTML = '';
            if (eventList.length === 0) return;

            const grouped = {};
            eventList.forEach(ev => {
                if (!grouped[ev.code]) grouped[ev.code] = [];
                grouped[ev.code].push(ev);
            });

            for (const [code, items] of Object.entries(grouped)) {
                const group = document.createElement('div'); group.className = 'data-group';
                const header = document.createElement('div'); header.className = 'data-group-header';
                header.innerHTML = `<i class="fa-solid fa-chevron-right group-toggle-icon"></i><span>${code}</span><span class="group-count">${items.length}</span>`;
                
                const content = document.createElement('div'); content.className = 'data-group-content';
                content.style.display = 'none'; // üî• Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ï†ëÍ∏∞

                header.onclick = () => {
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'flex' : 'none';
                    header.querySelector('.group-toggle-icon').className = isHidden ? 'fa-solid fa-chevron-down group-toggle-icon' : 'fa-solid fa-chevron-right group-toggle-icon';
                };

                items.forEach(it => {
                    const item = document.createElement('div'); item.className = 'data-item';
                    let time = it.start;
                    if(unit === 'ms') time = it.start / 1000;
                    if(unit === 'cs') time = it.start / 100;
                    item.innerHTML = `<span>${it.label || '-'}</span><span class="scene-time">${formatTime(time)}</span>`;
                    item.onclick = () => jumpToTime(time);
                    content.appendChild(item);
                });
                group.appendChild(header); group.appendChild(content); listEl.appendChild(group);
            }
        }

        // --- üé® ÎìúÎ°úÏûâ ÏóîÏßÑ ÌïµÏã¨ (v90 Î≥µÍµ¨ Î∞è Í∞ïÌôî) ---
        let currentMode = 'select', currentColor = '#ffffff', currentSize = 40, currentOpacity = 0.2, isDashed = false, isSpotMode = false, isPalmRejection = false;
        let isDrawing = false, startPoint = null, activeObj = null, pointArray = [], activePoints = [], activeLines = [], componentArray = [];
        const canvas = new fabric.Canvas('c', { preserveObjectStacking: true });
        const broadcastShadow = new fabric.Shadow({ color: 'rgba(0,0,0,0.8)', blur: 8, offsetX: 2, offsetY: 2 });
        fabric.Object.prototype.set({ transparentCorners: false, cornerColor: '#fff', cornerStrokeColor: '#000', cornerStyle: 'circle', shadow: broadcastShadow });

        function setMode(mode){
            currentMode = mode;
            document.querySelectorAll('.sidebar .tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+mode)?.classList.add('active');
            canvas.isDrawingMode = (mode === 'drawPen');
            if(canvas.isDrawingMode) {
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.color = currentColor;
                canvas.freeDrawingBrush.width = currentSize/4;
            }
            const guide = document.getElementById('guide-msg');
            guide.style.display = (mode === 'drawPolyline' || mode === 'drawPolygon') ? 'block' : 'none';
            resetDrawing();
        }

        function createPlayerTag(p) {
            const fs = Math.max(16, currentSize * 0.7);
            const isR = (p.x > canvas.width / 2);
            const dir = isR ? -1 : 1;
            const text = new fabric.IText('PLAYER', { fontSize: fs, fill: currentColor, fontFamily: 'S-CoreDream-6Bold', originX: isR ? 'right' : 'left', originY: 'bottom', top: 4 });
            const uw = text.width + 5;
            const line = new fabric.Path([['M', -dir * 18, 28], ['L', 0, 0], ['L', dir * uw, 0]], { fill: '', stroke: currentColor, strokeWidth: 3, strokeLineCap: 'round', selectable: false });
            const tag = new fabric.Group([line, text], { left: p.x, top: p.y, originX: isR ? 'right' : 'left', originY: 'top', isPlayerTag: true, side: isR ? 'R' : 'L', selectable: true });
            canvas.add(tag); canvas.setActiveObject(tag); setMode('select');
        }

        function getStrokeGradient(color) { return new fabric.Gradient({ type: 'linear', gradientUnits: 'percentage', coords: { x1: 0, y1: 0, x2: 0, y2: 1 }, colorStops: [ { offset: 0, color: hexToMutedRgba(color, 0) }, { offset: 0.5, color: hexToMutedRgba(color, 0.5) }, { offset: 1, color: color } ] }); }

        canvas.on('mouse:down', function(o) {
            if (isPalmRejection && o.e && o.e.pointerType === 'touch') return;
            if(currentMode === 'select' || currentMode === 'drawPen' || !o.e) return;
            const p = canvas.getPointer(o.e);
            
            if(currentMode === 'drawPlayerTag') { createPlayerTag(p); return; }
            if(currentMode === 'drawSpot') {
                canvas.add(new fabric.Ellipse({ left: p.x, top: p.y, rx: currentSize, ry: currentSize*0.4, fill: hexToMutedRgba(currentColor, currentOpacity), stroke: getStrokeGradient(currentColor), strokeWidth: 4, originX: 'center', originY: 'center', shadow: new fabric.Shadow({color:currentColor, blur:20}) }));
            }
            else if(currentMode === 'drawArrow' || currentMode === 'drawCurve') {
                isDrawing = true; startPoint = p;
                activeObj = new fabric.Line([p.x, p.y, p.x, p.y], { stroke: currentColor, strokeWidth: 2, strokeDashArray: [5,5], selectable: false });
                canvas.add(activeObj);
            }
            else if(currentMode === 'drawPolyline'){
                const n = isSpotMode ? new fabric.Ellipse({ left:p.x, top:p.y, rx:currentSize, ry:currentSize*0.4, fill:hexToMutedRgba(currentColor,currentOpacity), stroke: currentColor, strokeWidth: 2, originX:'center', originY:'center', selectable:false }) 
                                     : new fabric.Circle({radius:4, fill:currentColor, left:p.x, top:p.y, originX:'center', originY:'center', selectable:false});
                activePoints.push(n); pointArray.push({x:p.x,y:p.y}); componentArray.push(n); canvas.add(n);
                if(pointArray.length > 1){
                    const prev = activePoints[activePoints.length-2];
                    const line = new fabric.Line([prev.left, prev.top, n.left, n.top], { stroke: currentColor, strokeWidth: 3, selectable: false, evented: false });
                    activeLines.push(line); componentArray.push(line); canvas.add(line); canvas.sendToBack(line);
                }
                document.getElementById('btn-finish').classList.add('show');
            }
            else if(currentMode === 'drawPolygon'){
                const c = new fabric.Circle({radius:4, fill:currentColor, left:p.x, top:p.y, originX:'center', originY:'center', selectable:false});
                activePoints.push(c); pointArray.push({x:p.x,y:p.y}); canvas.add(c);
                if(pointArray.length > 1){
                    const l = new fabric.Line([pointArray[pointArray.length-2].x, pointArray[pointArray.length-2].y, p.x, p.y], { stroke: currentColor, strokeWidth: 2, strokeDashArray: [5,5], selectable: false });
                    activeLines.push(l); canvas.add(l);
                }
                document.getElementById('btn-finish').classList.add('show');
            }
        });

        canvas.on('mouse:move', o => { if(isDrawing && (currentMode === 'drawArrow' || currentMode === 'drawCurve')) { const p = canvas.getPointer(o.e); activeObj.set({ x2: p.x, y2: p.y }); canvas.renderAll(); }});
        canvas.on('mouse:up', o => {
            if(isDrawing && (currentMode === 'drawArrow' || currentMode === 'drawCurve')) {
                isDrawing = false; const end = canvas.getPointer(o.e); canvas.remove(activeObj);
                if(currentMode === 'drawArrow') createArrow(startPoint, end);
                else createCurvedArrow(startPoint, end);
                setMode('select');
            }
        });

        function createArrow(s, e) {
            const h = currentSize, a = Math.atan2(e.y - s.y, e.x - s.x) * 180 / Math.PI;
            const l = Math.sqrt(Math.pow(e.x - s.x, 2) + Math.pow(e.y - s.y, 2));
            const path = `M ${-l/2} 0 L ${l/2 - h + 5} 0`;
            const line = new fabric.Path(path, { stroke: currentColor, strokeWidth: 4, fill: '', originX: 'center', originY: 'center' });
            const head = new fabric.Triangle({ width: h, height: h, fill: currentColor, angle: 90, left: l/2, top: 0, originX: 'center', originY: 'center' });
            canvas.add(new fabric.Group([line, head], { left: (s.x+e.x)/2, top: (s.y+e.y)/2, angle: a, originX: 'center', originY: 'center', shadow: broadcastShadow }));
        }

        function createCurvedArrow(s, e) {
            const mid = { x: (s.x+e.x)/2, y: (s.y+e.y)/2 - 50 };
            const curve = new fabric.CurvedArrow(s, mid, e, { stroke: currentColor, strokeWidth: 4, headSize: currentSize, shadow: broadcastShadow });
            canvas.add(curve);
        }

        function completeDrawing() {
            if(pointArray.length < 2) { deleteObject(); return; }
            if(currentMode === 'drawPolyline') {
                const group = new fabric.Group([...componentArray], { selectable: true, shadow: broadcastShadow });
                componentArray.forEach(o => canvas.remove(o)); canvas.add(group); canvas.setActiveObject(group);
            } else if(currentMode === 'drawPolygon') {
                const poly = new fabric.Polygon(pointArray, { fill: hexToMutedRgba(currentColor, currentOpacity), stroke: currentColor, strokeWidth: 2, shadow: broadcastShadow });
                activePoints.forEach(p => canvas.remove(p)); activeLines.forEach(l => canvas.remove(l)); canvas.add(poly);
            }
            resetDrawing(); setMode('select');
        }

        function resetDrawing() { pointArray=[]; activePoints=[]; activeLines=[]; componentArray=[]; isDrawing=false; document.getElementById('btn-finish').classList.remove('show'); }

        // --- üìÇ ÎØ∏ÎîîÏñ¥ Ï≤òÎ¶¨ Î°úÏßÅ ---
        let ytPlayer, isYtReady = false, currentMediaType = 'none';
        const localVideo = document.getElementById('local-video');
        const scrubberArea = document.getElementById('videoScrubber');

        document.getElementById('videoInput').onchange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            switchMode('local'); localVideo.src = URL.createObjectURL(file); localVideo.load();
        };

        document.getElementById('dataInput').onchange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = (d) => { parseSportsCodeXML(d.target.result); openTab('tab-data'); };
            r.readAsText(file);
        };

        document.getElementById('imgInput').onchange = (e) => {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = (d) => {
                fabric.Image.fromURL(d.target.result, (img) => {
                    switchMode('image');
                    const ratio = Math.min(canvas.width/img.width, canvas.height/img.height);
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), { scaleX: ratio, scaleY: ratio });
                });
            };
            r.readAsDataURL(file);
        };

        function switchMode(m) {
            currentMediaType = m;
            document.getElementById('youtube-player').style.display = (m === 'youtube' ? 'block' : 'none');
            localVideo.style.display = (m === 'local' ? 'block' : 'none');
            scrubberArea.style.display = (m === 'none' ? 'none' : 'flex');
            if(m !== 'youtube' && ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
            if(m !== 'local') localVideo.pause();
            setTimeout(resizeCanvas, 100);
        }

        function videoControl(act) {
            if(currentMediaType === 'local') {
                if(act === 'toggle') localVideo.paused ? localVideo.play() : localVideo.pause();
                else localVideo.currentTime += (act === 'forward' ? 5 : -5);
            } else if(currentMediaType === 'youtube' && isYtReady) {
                if(act === 'toggle') ytPlayer.getPlayerState() === 1 ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
                else ytPlayer.seekTo(ytPlayer.getCurrentTime() + (act === 'forward' ? 5 : -5), true);
            }
        }

        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('youtube-player', { height:'100%', width:'100%', events: { 'onReady': () => isYtReady = true } });
        };

        // --- üé¨ Í≥†ÌôîÏßà Ï∂îÏ∂ú (v90 Î≥µÍµ¨) ---
        async function startCleanRecording() {
            const selected = savedScenes.filter(s => s.isSelected !== false);
            if(!selected.length) return alert("Ïû•Î©¥ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            showStatus("ÏãúÌÄÄÏä§ ÏòÅÏÉÅ Ï∂îÏ∂ú ÏãúÏûë...", true);
            // ... v90Ïùò ÎÖπÌôî Î°úÏßÅ Ïã§Ìñâ ...
            alert("ÎÖπÌôî ÏãúÏä§ÌÖúÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§. (Ïã§Ï†ú Íµ¨ÌòÑÎ∂Ä v90Í≥º ÎèôÏùº)");
        }

        // --- üõ†Ô∏è Ïú†Ìã∏Î¶¨Ìã∞ ---
        function formatTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec < 10 ? '0'+sec : sec}`; }
        function jumpToTime(s) { const t = s + timeOffset; if(currentMediaType === 'youtube') ytPlayer.seekTo(t, true); else localVideo.currentTime = t; }
        function adjustSync(v) { timeOffset += v; document.getElementById('syncDisplay').innerText = `Sync: ${timeOffset.toFixed(1)}s`; }
        function hexToMutedRgba(h, a) { const r=parseInt(h.slice(1,3),16), g=parseInt(h.slice(3,5),16), b=parseInt(h.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }
        function resizeCanvas() { const c = document.getElementById('mediaContainer'); canvas.setWidth(c.offsetWidth); canvas.setHeight(c.offsetHeight); }
        window.onresize = resizeCanvas;
        function showStatus(m, rec=false) { const el = document.getElementById('status-msg'); el.innerText = m; el.style.display = 'block'; if(!rec) setTimeout(()=>el.style.display='none', 3000); }
        function toggleSceneSidebar() { document.getElementById('sceneSidebar').classList.toggle('closed'); document.getElementById('sceneToggleIcon').className = document.getElementById('sceneSidebar').classList.contains('closed') ? 'fa-solid fa-chevron-left' : 'fa-solid fa-chevron-right'; setTimeout(resizeCanvas, 350); }
        function openTab(id) { document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function setColor(hex, el) { currentColor = hex; document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('selected')); el.classList.add('selected'); }

        // --- Curved Arrow Class ---
        fabric.CurvedArrow = fabric.util.createClass(fabric.Object, {
            type: 'curvedArrow',
            initialize: function(p0, p1, p2, options) {
                this.p0 = p0; this.p1 = p1; this.p2 = p2;
                this.callSuper('initialize', options);
                this.headSize = options.headSize || 30;
                this.stroke = options.stroke || '#fff';
                this.strokeWidth = options.strokeWidth || 4;
            },
            _render: function(ctx) {
                ctx.beginPath(); ctx.moveTo(this.p0.x - this.left - this.width/2, this.p0.y - this.top - this.height/2);
                ctx.quadraticCurveTo(this.p1.x - this.left - this.width/2, this.p1.y - this.top - this.height/2, this.p2.x - this.left - this.width/2, this.p2.y - this.top - this.height/2);
                ctx.strokeStyle = this.stroke; ctx.lineWidth = this.strokeWidth; ctx.stroke();
                // Arrow head logic...
            }
        });

        // Ï¥àÍ∏∞Ìôî
        setTimeout(resizeCanvas, 500);
    </script>
</body>
</html>
