<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Tactical Board - v93 URL & XML Fix</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ğŸ”¥ Google API ë° GIS ë¡œë“œ -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        @font-face { font-family: 'S-CoreDream-6Bold'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-6Bold.woff') format('woff'); font-weight: normal; font-style: normal; }
        :root { --bg-color: #1a1a1a; --panel-bg: #2d2d2d; --accent: #e74c3c; --text: #eee; --sidebar-width: 280px; }
        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text); font-family: 'S-CoreDream-6Bold', sans-serif; overflow: hidden; display: flex; height: 100vh; user-select: none; -webkit-user-select: none; }

        /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
        .sidebar { width: 80px; background: var(--panel-bg); display: flex; flex-direction: column; align-items: center; padding-top: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 20; overflow-y: auto; flex-shrink: 0; }
        .sidebar::-webkit-scrollbar { width: 0; }
        .tool-btn { width: 50px; height: 50px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aaa; font-size: 1.4rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; position: relative; flex-shrink: 0; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.3); }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
        .divider { width: 40px; height: 1px; background: #444; margin: 10px 0; flex-shrink: 0; }
        
        /* ì¤‘ì•™ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ */
        .workspace { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; position: relative; }
        .media-container { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #000; }
        
        #youtube-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; pointer-events: none; }
        #local-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; object-fit: contain; }
        .canvas-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }

        /* ìŠ¤í¬ëŸ¬ë²„ */
        .scrubber-area { height: 50px; width: 100%; background: #111; display: none; align-items: center; justify-content: center; padding: 0 20px; box-sizing: border-box; border-top: 1px solid #333; flex-shrink: 0; z-index: 10; }
        .scrubber-input { flex: 1; -webkit-appearance: none; height: 8px; background: #444; border-radius: 5px; cursor: pointer; margin: 0 15px; }
        .scrubber-input::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #e67e22; border-radius: 50%; cursor: pointer; transition: 0.1s; }
        .time-display { font-family: monospace; color: #ccc; font-size: 0.9rem; min-width: 100px; text-align: center; }

        /* í•˜ë‹¨ íŒ¨ë„ */
        .bottom-panel { height: 70px; width: 100%; background: var(--panel-bg); display: flex; justify-content: center; align-items: center; border-top: 1px solid #444; z-index: 20; flex-shrink: 0; }
        .control-bar { display: flex; gap: 15px; align-items: center; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot.selected { border-color: white; transform: scale(1.1); }
        .c-white { background: #ffffff; } .c-red { background: #e63946; } .c-yellow { background: #ffbe0b; } .c-blue { background: #3a86ff; } .c-green { background: #2ecc71; } .c-black { background: #000000; }

        /* ìš°ì¸¡ ì‚¬ì´ë“œë°” */
        .scene-sidebar { width: var(--sidebar-width); background: #222; border-left: 1px solid #444; display: flex; flex-direction: column; padding: 0; z-index: 30; transition: width 0.3s ease; overflow: hidden; flex-shrink: 0; }
        .scene-sidebar.closed { width: 0; }
        .sidebar-toggle-area { position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 40; }
        .scene-toggle-btn { width: 25px; height: 50px; background: #222; border: 1px solid #444; border-right: none; border-radius: 10px 0 0 10px; color: #aaa; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .sidebar-tabs { display: flex; border-bottom: 1px solid #444; background: #2d2d2d; }
        .tab-btn { flex: 1; padding: 15px 0; background: none; border: none; color: #888; cursor: pointer; font-family: 'S-CoreDream-6Bold'; transition: 0.2s; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); background: #333; }
        .tab-content { flex: 1; overflow-y: auto; display: none; padding: 15px; flex-direction: column; gap: 10px; }
        .tab-content.active { display: flex; }
        
        /* ğŸ”¥ ë°ì´í„° ê·¸ë£¹í™” ìŠ¤íƒ€ì¼ */
        .data-group { margin-bottom: 8px; }
        .data-group-header { background: #3a3a3a; padding: 10px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: bold; color: #fff; border: 1px solid #444; }
        .group-toggle-icon { font-size: 0.8rem; color: #aaa; width: 14px; text-align: center; }
        .group-count { background: var(--accent); color: #fff; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; margin-left: auto; font-family: monospace; }
        .data-group-content { display: none; flex-direction: column; gap: 5px; padding-top: 5px; }
        
        .data-item { background: #2a2a2a; padding: 10px 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .data-item:hover { background: #383838; }
        
        #status-msg { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 25px; border-radius: 30px; font-size: 1rem; color: #fff; z-index: 100; display: none; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar, .bottom-panel, .sidebar-toggle-area { display: none !important; }
            .workspace { height: 45vh; }
            .scene-sidebar { width: 100%; height: 55vh; }
            .scene-sidebar.closed { height: 55vh; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="tool-btn" id="btn-gdrive" style="background:#f39c12; color:white; border:none;" onclick="authAndPickDriveFile()" title="êµ¬ê¸€ ë“œë¼ì´ë¸Œ"><i class="fa-brands fa-google-drive"></i></button>
        <div class="divider"></div>
        <label for="imgInput" class="tool-btn" style="background:#2ecc71; color:white; border:none;"><i class="fa-solid fa-image"></i></label>
        <input type="file" id="imgInput" style="display:none;" accept="image/*">
        <label for="videoInput" class="tool-btn" style="background:#3498db; color:white; border:none;"><i class="fa-solid fa-file-video"></i></label>
        <input type="file" id="videoInput" style="display:none;" accept="video/*">
        <label for="dataInput" class="tool-btn" style="background:#9b59b6; color:white; border:none;"><i class="fa-solid fa-file-lines"></i></label>
        <input type="file" id="dataInput" style="display:none;" accept=".xml,.csv">
        <div class="divider"></div>
        <button class="tool-btn" onclick="videoControl('rewind')"><i class="fa-solid fa-backward-step"></i></button>
        <button class="tool-btn" id="btn-play" onclick="videoControl('toggle')"><i class="fa-solid fa-play"></i></button>
        <button class="tool-btn" onclick="videoControl('forward')"><i class="fa-solid fa-forward-step"></i></button>
        <div class="divider"></div>
        <button class="tool-btn active" id="btn-select" onclick="setMode('select')"><i class="fa-solid fa-arrow-pointer"></i></button>
        <button class="tool-btn" id="btn-drawPen" onclick="setMode('drawPen')"><i class="fa-solid fa-pen"></i></button>
        <button class="tool-btn" id="btn-drawArrow" onclick="setMode('drawArrow')"><i class="fa-solid fa-arrow-right-long"></i></button>
    </div>

    <div class="workspace">
        <div class="sidebar-toggle-area">
            <div class="scene-toggle-btn" onclick="toggleSceneSidebar()"><i class="fa-solid fa-chevron-right" id="sceneToggleIcon"></i></div>
        </div>
        <div id="status-msg">ë¯¸ë””ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</div>
        <div class="media-container" id="mediaContainer">
            <div id="youtube-player"></div>
            <video id="local-video" playsinline crossOrigin="anonymous"></video>
            <div class="canvas-wrapper"><canvas id="c"></canvas></div>
        </div>
        <div class="scrubber-area" id="videoScrubber">
            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            <input type="range" class="scrubber-input" id="timeSlider" min="0" max="100" value="0" step="0.1">
        </div>
        <div class="bottom-panel">
            <div class="control-bar">
                <div class="color-dot c-white selected" onclick="setColor('#ffffff', this)"></div>
                <div class="color-dot c-red" onclick="setColor('#e63946', this)"></div>
                <div class="color-dot c-yellow" onclick="setColor('#ffbe0b', this)"></div>
                <div class="color-dot c-blue" onclick="setColor('#3a86ff', this)"></div>
                <div class="color-dot c-green" onclick="setColor('#2ecc71', this)"></div>
                <div style="width:1px; height:30px; background:#555; margin: 0 10px;"></div>
                <div class="slider-group"><i class="fa-solid fa-up-right-and-down-left-from-center"></i><input type="range" id="sizeSlider" min="5" max="50" value="20"></div>
            </div>
        </div>
    </div>

    <div class="scene-sidebar" id="sceneSidebar">
        <div class="sidebar-tabs">
            <button class="tab-btn active" onclick="openTab('tab-scenes')">ì¥ë©´</button>
            <button class="tab-btn" onclick="openTab('tab-data')">ë°ì´í„°</button>
        </div>
        <div id="tab-scenes" class="tab-content active"><div id="sceneList"></div></div>
        <div id="tab-data" class="tab-content">
            <div id="dataList"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- ğŸ”— êµ¬ê¸€ ë“œë¼ì´ë¸Œ URL ìë™ ë³€í™˜ ë¡œì§ (ê°•í™”í˜•) ---
        function getDriveDirectLink(url) {
            if (!url) return null;
            // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê³µìœ  ì£¼ì†Œ íŒ¨í„´ (usp=sharing, drive_link ë“± ëª¨ë“  íŒŒë¼ë¯¸í„° ëŒ€ì‘)
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
            if (driveMatch && driveMatch[1]) {
                // ì§ì ‘ ë‹¤ìš´ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€í™˜
                return `https://docs.google.com/uc?id=${driveMatch[1]}&export=download`;
            }
            return url;
        }

        async function fetchExternalData(url) {
            const finalUrl = getDriveDirectLink(url);
            showStatus("ë°ì´í„° íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ì¤‘...");
            
            // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë¦¬ì†ŒìŠ¤ëŠ” ëŒ€ë¶€ë¶„ CORS ì°¨ë‹¨ì´ ìˆìœ¼ë¯€ë¡œ í”„ë¡ì‹œë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë˜, 
            // ì›ë³¸ ë°ì´í„°ê°€ HTML(ê²½ê³  í˜ì´ì§€)ì¸ì§€ ì²´í¬í•˜ëŠ” ë¡œì§ í¬í•¨
            try {
                // AllOrigins í”„ë¡ì‹œë¥¼ í†µí•´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(finalUrl);
                let response = await fetch(proxyUrl);
                if (!response.ok) throw new Error();
                
                let text = await response.text();
                
                // ë§Œì•½ ê²°ê³¼ë¬¼ì´ HTMLì´ë¼ë©´ (êµ¬ê¸€ì˜ ë°”ì´ëŸ¬ìŠ¤ ê²½ê³  í˜ì´ì§€ ë“±)
                if (text.trim().toLowerCase().startsWith("<!doctype html") || text.includes("<html")) {
                    throw new Error("êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë³´ì•ˆ ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë” ì‘ê²Œ ë§Œë“¤ê±°ë‚˜ ì§ì ‘ ì—…ë¡œë“œí•˜ì„¸ìš”.");
                }
                
                return text;
            } catch (e) {
                console.error("Fetch Error:", e);
                throw new Error(e.message || "íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨. ê³µìœ  ê¶Œí•œì´ 'ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì'ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        // --- ğŸš€ ì´ˆê¸° ì‹¤í–‰ ë° URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ---
        let ytPlayer, isYtReady = false, currentMediaType = 'none';
        const localVideo = document.getElementById('local-video');
        const canvas = new fabric.Canvas('c');

        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('youtube-player', {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'rel': 0 },
                events: { 
                    'onReady': () => { isYtReady = true; checkUrlParams(); },
                    'onStateChange': (e) => {
                        if (e.data == YT.PlayerState.PLAYING) document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-pause"></i>';
                        else document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-play"></i>';
                    }
                }
            });
        };

        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const videoUrl = params.get('video');
            const dataUrl = params.get('data');

            if (videoUrl) {
                const ytId = videoUrl.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/i);
                if (ytId) {
                    switchMode('youtube');
                    ytPlayer.loadVideoById(ytId[1]);
                } else {
                    switchMode('local');
                    localVideo.src = videoUrl;
                }
            }

            if (dataUrl) {
                try {
                    const xmlText = await fetchExternalData(dataUrl);
                    parseSportsCodeXML(xmlText);
                    openTab('tab-data');
                } catch (err) {
                    alert("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: " + err.message);
                }
            }
        }

        // --- ğŸ“Š XML ë°ì´í„° íŒŒì‹± ë° ê·¸ë£¹í™” ---
        let eventList = [];
        function parseSportsCodeXML(text) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            
            // XML íŒŒì‹± ì—ëŸ¬ ì²´í¬
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                alert("XML í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            const instances = xmlDoc.getElementsByTagName("instance");
            eventList = [];
            for (let i = 0; i < instances.length; i++) {
                const start = parseFloat(instances[i].getElementsByTagName("start")[0]?.textContent || 0);
                const code = instances[i].getElementsByTagName("code")[0]?.textContent || "Event";
                const labels = instances[i].getElementsByTagName("label");
                let labelText = labels.length > 0 ? labels[0].getElementsByTagName("text")[0]?.textContent : "";
                eventList.push({ start, code, label: labelText });
            }
            renderDataList();
        }

        function renderDataList() {
            const listEl = document.getElementById('dataList');
            listEl.innerHTML = '';
            if (eventList.length === 0) {
                listEl.innerHTML = '<div style="color:#777;text-align:center;padding:20px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const grouped = {};
            eventList.forEach(ev => {
                if (!grouped[ev.code]) grouped[ev.code] = [];
                grouped[ev.code].push(ev);
            });

            for (const [code, items] of Object.entries(grouped)) {
                const group = document.createElement('div');
                group.className = 'data-group';
                
                const header = document.createElement('div');
                header.className = 'data-group-header';
                header.innerHTML = `<i class="fa-solid fa-chevron-right group-toggle-icon"></i><span>${code}</span><span class="group-count">${items.length}</span>`;
                
                const content = document.createElement('div');
                content.className = 'data-group-content';
                content.style.display = 'none'; // ğŸ”¥ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘í˜€ìˆë„ë¡ ì„¤ì •

                header.onclick = () => {
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'flex' : 'none';
                    header.querySelector('.group-toggle-icon').className = isHidden ? 'fa-solid fa-chevron-down group-toggle-icon' : 'fa-solid fa-chevron-right group-toggle-icon';
                };

                items.forEach(it => {
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    item.innerHTML = `<span>${it.label || '-'}</span><span style="color:#e74c3c;font-family:monospace;">${formatTime(it.start)}</span>`;
                    item.onclick = () => jumpToTime(it.start);
                    content.appendChild(item);
                });

                group.appendChild(header);
                group.appendChild(content);
                listEl.appendChild(group);
            }
        }

        // --- ğŸ› ï¸ ê¸°ë³¸ ìœ í‹¸ë¦¬í‹° ---
        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' + sec : sec}`;
        }

        function jumpToTime(s) {
            if (currentMediaType === 'youtube') ytPlayer.seekTo(s, true);
            else if (currentMediaType === 'local') localVideo.currentTime = s;
        }

        function videoControl(action) {
            if (currentMediaType === 'youtube') {
                if (action === 'toggle') {
                    const state = ytPlayer.getPlayerState();
                    if (state == 1) ytPlayer.pauseVideo(); else ytPlayer.playVideo();
                } else if (action === 'rewind') ytPlayer.seekTo(ytPlayer.getCurrentTime() - 5, true);
                else if (action === 'forward') ytPlayer.seekTo(ytPlayer.getCurrentTime() + 5, true);
            } else if (currentMediaType === 'local') {
                if (action === 'toggle') {
                    if (localVideo.paused) localVideo.play(); else localVideo.pause();
                } else if (action === 'rewind') localVideo.currentTime -= 5;
                else if (action === 'forward') localVideo.currentTime += 5;
            }
        }

        function switchMode(m) {
            currentMediaType = m;
            document.getElementById('youtube-player').style.display = m === 'youtube' ? 'block' : 'none';
            localVideo.style.display = m === 'local' ? 'block' : 'none';
            document.getElementById('videoScrubber').style.display = (m !== 'none') ? 'flex' : 'none';
            resizeCanvas();
        }

        function resizeCanvas() {
            const cont = document.getElementById('mediaContainer');
            canvas.setWidth(cont.offsetWidth);
            canvas.setHeight(cont.offsetHeight);
            canvas.renderAll();
        }
        window.onresize = resizeCanvas;

        function toggleSceneSidebar() {
            const sb = document.getElementById('sceneSidebar');
            sb.classList.toggle('closed');
            document.getElementById('sceneToggleIcon').className = sb.classList.contains('closed') ? 'fa-solid fa-chevron-left' : 'fa-solid fa-chevron-right';
            setTimeout(resizeCanvas, 350);
        }

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // íƒ­ ë²„íŠ¼ í™œì„±í™” ë¡œì§ ì¶”ê°€
            const targetBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => 
                (id === 'tab-scenes' && b.innerText === 'ì¥ë©´') || (id === 'tab-data' && b.innerText === 'ë°ì´í„°')
            );
            if (targetBtn) targetBtn.classList.add('active');
        }

        function setMode(m) {
            canvas.isDrawingMode = (m === 'drawPen');
            if (canvas.isDrawingMode) {
                canvas.freeDrawingBrush.width = document.getElementById('sizeSlider').value / 4;
                canvas.freeDrawingBrush.color = currentColor;
            }
            document.querySelectorAll('.sidebar .tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + m)?.classList.add('active');
        }

        let currentColor = '#ffffff';
        function setColor(hex, el) {
            currentColor = hex;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            if (canvas.isDrawingMode) canvas.freeDrawingBrush.color = hex;
        }

        function showStatus(m) {
            const el = document.getElementById('status-msg');
            el.innerText = m; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // ì´ˆê¸°í™”
        document.getElementById('sizeSlider').oninput = function() {
            if (canvas.isDrawingMode) canvas.freeDrawingBrush.width = this.value / 4;
        };
    </script>
</body>
</html>
