<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Tactical Board - v117 Stability & UI Fix</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google API & GIS -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        @font-face { font-family: 'S-CoreDream-6Bold'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-6Bold.woff') format('woff'); font-weight: normal; font-style: normal; }
        :root { --bg-color: #1a1a1a; --panel-bg: #2d2d2d; --accent: #e74c3c; --text: #eee; --sidebar-width: 280px; }
        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text); font-family: 'S-CoreDream-6Bold', sans-serif; overflow: hidden; display: flex; height: 100vh; user-select: none; -webkit-user-select: none; }

        /* Ï¢åÏ∏° ÏÇ¨Ïù¥ÎìúÎ∞î */
        .sidebar { width: 80px; background: var(--panel-bg); display: flex; flex-direction: column; align-items: center; padding-top: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 50; overflow-y: auto; flex-shrink: 0; }
        .sidebar::-webkit-scrollbar { width: 0; }
        .tool-btn { width: 50px; height: 50px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #aaa; font-size: 1.4rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; position: relative; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
        .tool-btn::after { content: attr(data-shortcut); position: absolute; bottom: 2px; right: 4px; font-size: 0.6rem; opacity: 0.5; font-family: monospace; }
        .divider { width: 40px; height: 1px; background: #444; margin: 10px 0; flex-shrink: 0; }
        
        /* Ï§ëÏïô ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ */
        .workspace { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; position: relative; }
        .media-container { flex: 1; position: relative; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #000; }
        
        #youtube-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; pointer-events: none; }
        #local-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; object-fit: contain; }
        .canvas-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }

        /* Ïä§ÌÅ¨Îü¨Î≤Ñ */
        .scrubber-area { height: 50px; width: 100%; background: #111; display: none; align-items: center; justify-content: center; padding: 0 20px; box-sizing: border-box; border-top: 1px solid #333; z-index: 10; flex-shrink: 0; }
        .scrubber-input { flex: 1; -webkit-appearance: none; height: 8px; background: #444; border-radius: 5px; cursor: pointer; margin: 0 15px; }
        .scrubber-input::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #e67e22; border-radius: 50%; cursor: pointer; transition: 0.1s; }
        .time-display { font-family: monospace; color: #ccc; font-size: 0.9rem; min-width: 100px; text-align: center; }

        /* ÌïòÎã® Ìå®ÎÑê */
        .bottom-panel { height: 70px; width: 100%; background: var(--panel-bg); display: flex; justify-content: center; align-items: center; border-top: 1px solid #444; z-index: 20; flex-shrink: 0; }
        .control-bar { display: flex; gap: 20px; align-items: center; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; position: relative; }
        .color-dot.selected { border-color: white; box-shadow: 0 0 0 2px var(--bg-color); transform: scale(1.1); }
        .c-white { background: #ffffff; } .c-red { background: #e63946; } .c-yellow { background: #ffbe0b; } .c-blue { background: #3a86ff; } .c-green { background: #2ecc71; } .c-black { background: #000000; border: 1px solid #555; }
        .slider-group { display: flex; align-items: center; gap: 8px; color: #aaa; font-size: 0.9rem; }
        input[type=range] { -webkit-appearance: none; width: 80px; height: 5px; background: #555; border-radius: 5px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #555; background: #333; color: #aaa; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; }
        .toggle-btn.active { background: #3498db; color: white; border-color: #3498db; }
        
        #status-msg { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 25px; border-radius: 30px; font-size: 1rem; color: #fff; border: 1px solid rgba(255,255,255,0.2); z-index: 100; pointer-events: none; display: none; }
        #guide-msg { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(231, 76, 60, 0.9); color: white; padding: 10px 25px; border-radius: 30px; font-size: 1rem; font-weight: bold; pointer-events: none; display: none; z-index: 100; }

        /* Ïö∞Ï∏° ÏÇ¨Ïù¥ÎìúÎ∞î */
        .scene-sidebar { width: var(--sidebar-width); background: #222; border-left: 1px solid #444; display: flex; flex-direction: column; padding: 0; box-shadow: -2px 0 10px rgba(0,0,0,0.5); z-index: 30; transition: width 0.3s ease; overflow: hidden; flex-shrink: 0; }
        .scene-sidebar.closed { width: 0; }
        .sidebar-toggle-area { position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 40; }
        .scene-toggle-btn { width: 25px; height: 50px; background: #222; border: 1px solid #444; border-right: none; border-radius: 10px 0 0 10px; color: #aaa; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .sidebar-tabs { display: flex; border-bottom: 1px solid #444; background: #2d2d2d; min-width: 100%; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 15px 0; background: none; border: none; color: #888; cursor: pointer; font-size: 0.9rem; font-family: 'S-CoreDream-6Bold'; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); background: #333; }
        .tab-content { flex: 1; overflow-y: auto; display: none; padding: 15px; flex-direction: column; gap: 10px; box-sizing: border-box; }
        .tab-content.active { display: flex; }
        
        /* Îç∞Ïù¥ÌÑ∞ Î™©Î°ù */
        .data-group { margin-bottom: 8px; display: flex; flex-direction: column; }
        .data-group-header { background: #3a3a3a; padding: 10px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: bold; color: #fff; border: 1px solid #444; }
        .group-count { background: var(--accent); color: #fff; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; margin-left: auto; }
        .data-group-content { display: none; flex-direction: column; gap: 5px; padding-top: 5px; overflow: hidden; }
        .data-item { background: #2a2a2a; padding: 10px 12px; border-radius: 0 6px 6px 0; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #555; cursor: pointer; }
        .data-item:hover { border-left-color: var(--accent); background: #333; }

        .scene-item { background: #333; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border: 1px solid transparent; }
        .scene-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; flex: 1; cursor: pointer; padding: 0 5px; }
        .scene-time { color: var(--accent); font-size: 0.8rem; font-family: monospace; }
        .scene-del-btn { color: #888; background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.2rem; }

        /* Îß§Ïπò ÏÑºÌÑ∞ Í≥ÑÏ∏µ UI */
        .comp-card { background: #333; padding: 18px; border-radius: 10px; cursor: pointer; border: 1px solid #555; display: flex; align-items: center; gap: 15px; margin-bottom: 8px; transition: 0.2s; }
        .comp-card:hover { border-color: var(--accent); background: #3d3d3d; transform: translateX(5px); }
        .match-card { background: #2a2a2a; padding: 15px; border-radius: 8px; cursor: pointer; border-left: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; transition: 0.2s; }

        .top-menu { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 100; }
        .top-btn { background: rgba(0,0,0,0.6); color: #ccc; border: 1px solid #555; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-family: 'S-CoreDream-6Bold'; display: flex; align-items: center; gap: 8px; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #2d2d2d; padding: 25px; border-radius: 15px; width: 90%; max-width: 600px; border: 1px solid #444; position: relative; max-height: 85vh; overflow-y: auto;}
        .close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #aaa; font-size: 1.8rem; cursor: pointer; }
        .modal-header { font-size: 1.5rem; margin-bottom: 15px; color: var(--accent); font-weight: bold; }
        
        .admin-form { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-input { background: #111; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 8px; }
        .btn-submit { background: var(--accent); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .finish-btn { color: #2ecc71; border-color: #2ecc71; display: none; } .finish-btn.show { display: flex; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar, .bottom-panel, .sidebar-toggle-area { display: none !important; }
            .workspace { flex: none; height: 45vh; }
            .scene-sidebar { width: 100%; flex: 1; border-left: none; }
            .top-menu { top: 10px; right: 10px; gap: 5px; }
        }
    </style>
</head>
<body>
    <!-- üöÄ Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ†Ïñ∏Î∂Ä (Ïä§ÏΩîÌîÑ Ïò§Î•ò Î∞©ÏßÄ Î∞è Ï¥àÍ∏∞Ìôî) -->
    <script>
        let canvas, ytPlayer, broadcastShadow;
        let isYtReady = false, currentMediaType = 'none', eventList = [], timeOffset = 0.0;
        let isDrawing = false, startPoint = null, activeObj = null, pointArray = [], activePoints = [], activeLines = [], componentArray = [];
        let currentMode = 'select', currentColor = '#ffffff', currentSize = 40, currentOpacity = 0.2, isSpotMode = false, isPalmRejection = false, isDashed = false;
        let isDraggingSlider = false, githubMatchesData = [], isVideoInteractive = false;

        // --- üé• Ïú†ÌäúÎ∏å Î∞è ÎØ∏ÎîîÏñ¥ Ï†úÏñ¥ Ìï®Ïàò ---
        function switchMode(m) {
            currentMediaType = m;
            const ytDiv = document.getElementById('youtube-player');
            const localVid = document.getElementById('local-video');
            const scrubber = document.getElementById('videoScrubber');

            if (ytDiv) ytDiv.style.display = (m === 'youtube' ? 'block' : 'none');
            if (localVid) localVid.style.display = (m === 'local' ? 'block' : 'none');
            if (scrubber) scrubber.style.display = (m !== 'none' && m !== 'image' ? 'flex' : 'none');

            if (m !== 'local' && localVid) localVid.pause();
            if (m !== 'youtube' && isYtReady && ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
            
            setTimeout(resizeCanvas, 200);
        }

        function loadYoutubePrompt() {
            let url = prompt("YouTube URL:", "");
            if(url) {
                const ytIdMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/i);
                if(ytIdMatch && ytIdMatch[1]) {
                    switchMode('youtube');
                    if(isYtReady && ytPlayer && ytPlayer.loadVideoById) {
                        ytPlayer.loadVideoById(ytIdMatch[1]);
                    } else {
                        showStatus("ÌîåÎ†àÏù¥Ïñ¥ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë...");
                        let checkCount = 0;
                        const check = setInterval(() => {
                            checkCount++;
                            if (isYtReady && ytPlayer) {
                                clearInterval(check);
                                ytPlayer.loadVideoById(ytIdMatch[1]);
                            }
                            if (checkCount > 20) clearInterval(check);
                        }, 500);
                    }
                }
            }
        }

        function toggleVideoInteraction() {
            isVideoInteractive = !isVideoInteractive;
            const yt = document.getElementById('youtube-player');
            const cw = document.getElementById('canvasWrapper');
            const btn = document.getElementById('btn-video-touch');

            if (isVideoInteractive) {
                if(yt) yt.style.pointerEvents = 'auto';
                if(cw) cw.style.pointerEvents = 'none';
                if(btn) btn.classList.add('active');
                showStatus("ÏòÅÏÉÅ Ï°∞Ïûë Î™®Îìú (Ï∂îÏ≤úÏòÅÏÉÅ ÎÅÑÍ∏∞ Í∞ÄÎä•)");
            } else {
                if(yt) yt.style.pointerEvents = 'none';
                if(cw) cw.style.pointerEvents = 'auto';
                if(btn) btn.classList.remove('active');
                showStatus("ÎìúÎ°úÏûâ Î™®Îìú");
            }
        }

        function videoControl(act) {
            const localVid = document.getElementById('local-video');
            if(currentMediaType === 'local' && localVid) {
                if(act === 'toggle') localVid.paused ? localVid.play() : localVid.pause();
                else if(act==='rewind') localVid.currentTime -= 5;
                else if(act==='forward') localVid.currentTime += 5;
            } else if(currentMediaType === 'youtube' && isYtReady && ytPlayer) {
                if(act === 'toggle') {
                    const state = ytPlayer.getPlayerState();
                    state === 1 ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
                }
                else if(act==='rewind') ytPlayer.seekTo(ytPlayer.getCurrentTime() - 5, true);
                else if(act==='forward') ytPlayer.seekTo(ytPlayer.getCurrentTime() + 5, true);
            }
        }

        // --- üîó GitHub & Match Center Logic ---
        function openMatchCenter() { 
            const modal = document.getElementById('matchCenterModal');
            if(modal) modal.style.display = 'flex'; 
            loadAdminConfig(); 
            loadGitHubManifest(); 
        }

        function closeMatchCenter() { 
            const modal = document.getElementById('matchCenterModal');
            if(modal) modal.style.display = 'none'; 
        }

        async function loadGitHubManifest() {
            const urlInput = document.getElementById('manifest-url');
            if(!urlInput) return;
            const url = urlInput.value.trim();
            const container = document.getElementById('match-list-container');
            const loading = document.getElementById('match-loading');
            if(loading) loading.style.display = 'block';
            if(container) container.innerHTML = '';

            try {
                let finalUrl = getDirectLink(url);
                const response = await fetch(finalUrl + "?t=" + Date.now());
                if (!response.ok) throw new Error();
                const data = await response.json();
                githubMatchesData = data.matches;
                renderCompList();
                if(loading) loading.style.display = 'none';
            } catch (e) { if(loading) loading.innerText = "Î™©Î°ù Î°úÎìú Ïã§Ìå®"; }
        }

        function getDirectLink(url) {
            if (!url) return "";
            let l = url.trim();
            if (l.startsWith('./') || !l.startsWith('http')) return l;
            if (l.includes("github.com") && !l.includes("raw.githubusercontent.com")) {
                l = l.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
            }
            return l;
        }
    </script>

    <div class="sidebar">
        <button class="tool-btn" id="btn-github-center" style="background:#333; color:white; border:none;" onclick="openMatchCenter()" title="Match Center"><i class="fa-brands fa-github"></i></button>
        <div class="divider"></div>
        <label for="imgInput" class="tool-btn" style="background:#2ecc71; color:white; border:none;" title="ÏÇ¨ÏßÑ Ïó¥Í∏∞"><i class="fa-solid fa-image"></i></label>
        <input type="file" id="imgInput" style="display:none;" accept="image/*">
        <label for="videoInput" class="tool-btn" style="background:#3498db; color:white; border:none;" title="ÌååÏùº ÏòÅÏÉÅ Ïó¥Í∏∞"><i class="fa-solid fa-file-video"></i></label>
        <input type="file" id="videoInput" style="display:none;" accept="video/*">
        <label for="dataInput" class="tool-btn" style="background:#9b59b6; color:white; border:none;" title="Îç∞Ïù¥ÌÑ∞ Ïó¥Í∏∞"><i class="fa-solid fa-file-lines"></i></label>
        <input type="file" id="dataInput" style="display:none;" accept=".xml,.csv">
        <button class="tool-btn" style="background:#e63946; color:white; border:none;" onclick="loadYoutubePrompt()" title="Ïú†ÌäúÎ∏å Ï£ºÏÜå"><i class="fa-brands fa-youtube"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" id="btn-video-touch" onclick="toggleVideoInteraction()" title="ÏòÅÏÉÅ Ï°∞Ïûë Î™®Îìú"><i class="fa-solid fa-hand-pointer"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" id="btn-rewind" onclick="videoControl('rewind')" title="-5Ï¥à (‚Üê)"><i class="fa-solid fa-backward-step"></i></button>
        <button class="tool-btn" id="btn-play" onclick="videoControl('toggle')" title="Ïû¨ÏÉù/Ï†ïÏßÄ (Space)"><i class="fa-solid fa-play"></i></button>
        <button class="tool-btn" id="btn-forward" onclick="videoControl('forward')" title="+5Ï¥à (‚Üí)"><i class="fa-solid fa-forward-step"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" onclick="togglePalm()" id="btn-palm" title="ÌÑ∞Ïπò Î∞©ÏßÄ"><i class="fa-solid fa-hand-pointer"></i></button>
        <div class="divider"></div>
        <button class="tool-btn active" id="btn-select" onclick="setMode('select')" title="ÏÑ†ÌÉù"><i class="fa-solid fa-arrow-pointer"></i></button>
        <button class="tool-btn" id="btn-drawPlayerTag" onclick="setMode('drawPlayerTag')" title="ÏÑ†Ïàò ÌÉúÍ∑∏"><i class="fa-solid fa-tag"></i></button>
        <button class="tool-btn" id="btn-drawPen" onclick="setMode('drawPen')" title="Ìéú"><i class="fa-solid fa-pen"></i></button>
        <button class="tool-btn" onclick="addText()" title="ÌÖçÏä§Ìä∏"><i class="fa-solid fa-font"></i></button>
        <button class="tool-btn" id="btn-drawSpot" onclick="setMode('drawSpot')" title="Ïä§Ìåü"><i class="fa-regular fa-circle"></i></button>
        <button class="tool-btn" id="btn-drawPolyline" onclick="setMode('drawPolyline')" title="Îã§Ï§ë ÏÑ†"><i class="fa-solid fa-share-nodes"></i></button>
        <button class="tool-btn" id="btn-drawArrow" onclick="setMode('drawArrow')" title="ÌôîÏÇ¥Ìëú"><i class="fa-solid fa-arrow-right-long"></i></button>
        <button class="tool-btn" id="btn-drawCurve" onclick="setMode('drawCurve')" title="Í≥°ÏÑ†"><i class="fa-solid fa-arrow-turn-up"></i></button>
        <button class="tool-btn" id="btn-drawPolygon" onclick="setMode('drawPolygon')" title="Îã§Í∞ÅÌòï"><i class="fa-solid fa-draw-polygon"></i></button>
        <button class="tool-btn finish-btn" id="btn-finish" onclick="completeDrawing()"><i class="fa-solid fa-check"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" style="color:#f1c40f;" onclick="saveScene()" title="Ïû•Î©¥ Ï†ÄÏû•"><i class="fa-solid fa-floppy-disk"></i></button>
        <button class="tool-btn" id="btn-record" style="color:#e67e22;" onclick="startCleanRecording()" title="Ï∂îÏ∂ú"><i class="fa-solid fa-clapperboard"></i></button>
        <div class="divider"></div>
        <button class="tool-btn" id="btn-delete" style="color:#e74c3c;" onclick="deleteObject()" title="ÏÇ≠Ï†ú"><i class="fa-solid fa-trash"></i></button>
        <button class="tool-btn" style="color:#ff6b6b;" onclick="clearAll()"><i class="fa-solid fa-eraser"></i></button>
    </div>

    <div class="workspace">
        <div class="sidebar-toggle-area">
            <div class="scene-toggle-btn" onclick="toggleSceneSidebar()"><i class="fa-solid fa-chevron-right" id="sceneToggleIcon"></i></div>
        </div>
        <div class="top-menu">
            <button class="top-btn" onclick="toggleLang()">KR | EN</button>
            <button class="top-btn" onclick="toggleHelp()"><i class="fa-solid fa-gear"></i> ÏÑ§Ï†ï</button>
        </div>
        <div id="status-msg">ÎØ∏ÎîîÏñ¥Î•º Î∂àÎü¨Ïò§ÏÑ∏Ïöî.</div>
        <div id="guide-msg">ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏó¨ ÎèÑÌòï ÏôÑÏÑ±</div>
        <div class="media-container" id="mediaContainer">
            <div id="youtube-player"></div>
            <video id="local-video" playsinline crossOrigin="anonymous"></video>
            <div class="canvas-wrapper" id="canvasWrapper"><canvas id="c"></canvas></div>
        </div>
        <div class="scrubber-area" id="videoScrubber">
            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            <input type="range" class="scrubber-input" id="timeSlider" min="0" max="100" value="0" step="0.1">
        </div>
        <div class="bottom-panel">
            <div class="control-bar">
                <div style="display:flex; gap:8px;">
                    <div class="color-dot c-white selected" onclick="setColor('#ffffff', this)"></div>
                    <div class="color-dot c-red" onclick="setColor('#e63946', this)"></div>
                    <div class="color-dot c-yellow" onclick="setColor('#ffbe0b', this)"></div>
                    <div class="color-dot c-blue" onclick="setColor('#3a86ff', this)"></div>
                    <div class="color-dot c-green" onclick="setColor('#2ecc71', this)"></div>
                    <div class="color-dot c-black" onclick="setColor('#000000', this)"></div>
                </div>
                <div style="width:1px; height:30px; background:#555;"></div>
                <div class="slider-group" title="ÏÑ† ÎëêÍªò"><i class="fa-solid fa-lines-leaning"></i><input type="range" id="sizeSlider" min="10" max="100" value="40"></div>
                <div class="slider-group" title="Ìà¨Î™ÖÎèÑ"><i class="fa-solid fa-circle-half-stroke"></i><input type="range" id="opacitySlider" min="10" max="100" value="20"></div>
                <div style="width:1px; height:30px; background:#555;"></div>
                <div class="slider-group" title="Ïû¨ÏÉù ÏÜçÎèÑ"><i class="fa-solid fa-gauge-high"></i><input type="range" id="speedSlider" min="0.25" max="2" step="0.25" value="1"><span id="speedVal" style="font-size:0.8rem; width:35px;">1.0x</span></div>
            </div>
        </div>
    </div>

    <div class="scene-sidebar" id="sceneSidebar">
        <div class="sidebar-tabs">
            <button class="tab-btn active" id="tab-btn-scenes" onclick="openTab('tab-scenes')">Ïû•Î©¥</button>
            <button class="tab-btn" id="tab-btn-data" onclick="openTab('tab-data')">Îç∞Ïù¥ÌÑ∞</button>
        </div>
        <div id="tab-scenes" class="tab-content active"><div class="scene-list" id="sceneList"></div></div>
        <div id="tab-data" class="tab-content">
            <div class="control-box">
                <select id="timeUnit" class="unit-select" onchange="renderDataList()">
                    <option value="sec" selected>Îã®ÏúÑ: 1Ï¥à</option>
                    <option value="ms">Î∞ÄÎ¶¨Ï¥à</option>
                    <option value="cs">1/100Ï¥à</option>
                </select>
                <div class="sync-control">
                    <button class="sync-btn" onclick="adjustSync(-0.1)">-0.1s</button>
                    <span class="sync-display" id="syncDisplay">Sync: 0.0s</span>
                    <button class="sync-btn" onclick="adjustSync(0.1)">+0.1s</button>
                </div>
            </div>
            <div id="dataList"></div>
        </div>
    </div>

    <div class="modal-overlay" id="matchCenterModal">
        <div class="modal-box" style="max-width: 600px;">
            <button class="close-btn" onclick="closeMatchCenter()">&times;</button>
            <div class="modal-header">GitHub Match Center</div>
            <div class="modal-tabs">
                <div class="m-tab active" id="m-tab-list" onclick="switchMatchTab('list')">ÎåÄÌöå Î™©Î°ù</div>
                <div class="m-tab" id="m-tab-admin" onclick="switchMatchTab('admin')">Îß§Ïπò Îì±Î°ù (Admin)</div>
            </div>
            <div id="match-view-list" class="m-content active">
                <div id="list-nav" style="margin-bottom:15px; display:none;">
                    <button onclick="renderCompList()" style="background:#444; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;"><i class="fa-solid fa-chevron-left"></i> ÎåÄÌöå Î™©Î°ùÏúºÎ°ú</button>
                </div>
                <div id="match-loading" style="text-align:center; padding:20px; color:#aaa;">Î°úÎî© Ï§ë...</div>
                <div class="match-list" id="match-list-container"></div>
                <div style="margin-top:20px; border-top:1px solid #444; padding-top:15px;">
                    <input type="text" id="manifest-url" style="width:100%; background:#111; color:#fff; border:1px solid #555; padding:10px; border-radius:8px;" value="https://raw.githubusercontent.com/Urekas/analysis/main/matches.json">
                    <button onclick="loadGitHubManifest()" style="margin-top:10px; width:100%; padding:10px; background:var(--accent); color:white; border:none; cursor:pointer; font-weight:bold; border-radius:8px;">Î™©Î°ù ÎèôÍ∏∞Ìôî</button>
                </div>
            </div>
            <div id="match-view-admin" class="m-content">
                <div class="admin-form">
                    <div class="form-group"><label>GitHub PAT</label><input type="password" id="gh-token" class="form-input" value="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"></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="form-group"><label>ID</label><input type="text" id="gh-owner" class="form-input" value="Urekas"></div>
                        <div class="form-group"><label>Repo</label><input type="text" id="gh-repo" class="form-input" value="analysis"></div>
                    </div>
                    <div class="form-group"><label>ÎåÄÌöå Ïù¥Î¶Ñ</label><input type="text" id="match-competition" class="form-input" placeholder="2024 ÏïÑÏãúÏïÑÏªµ"></div>
                    <div class="form-group"><label>Í≤ΩÍ∏∞ Ï†úÎ™©</label><input type="text" id="match-title" class="form-input" placeholder="Ïù∏ÎèÑ vs ÏùºÎ≥∏"></div>
                    <div class="form-group"><label>Ïú†ÌäúÎ∏å URL</label><input type="text" id="match-video" class="form-input" placeholder="URL ÏûÖÎ†•"></div>
                    <div class="form-group"><label>XML Îç∞Ïù¥ÌÑ∞ ÌååÏùº</label><input type="file" id="match-xml-file" accept=".xml" class="form-input"></div>
                    <button onclick="uploadMatchToGitHub()" id="btn-gh-upload" class="btn-submit">GitHubÏóê Î∞îÎ°ú Îì±Î°ùÌïòÍ∏∞</button>
                    <div id="upload-status" style="font-size:0.85rem; text-align:center; min-height:20px; margin-top:10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="helpModal">
        <div class="modal-box">
            <button class="close-btn" onclick="toggleHelp()">&times;</button>
            <div class="modal-header">ÏãúÏä§ÌÖú ÏÑ§Ï†ï</div>
            <div class="modal-tabs">
                <div class="m-tab active" id="tab-btn-guide" onclick="switchModalTab('guide')">Í∞ÄÏù¥Îìú</div>
                <div class="m-tab" id="tab-btn-shortcuts" onclick="switchModalTab('shortcuts')">Îã®Ï∂ïÌÇ§</div>
            </div>
            <div id="m-guide" class="m-content active">
                <p>1. <b>Îß§Ïπò ÏÑºÌÑ∞</b>: ÍπÉÌóàÎ∏å ÏïÑÏù¥ÏΩòÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                <p>2. <b>Ïû¨ÏÉù Ïª®Ìä∏Î°§</b>: Space(Ïû¨ÏÉù/Ï†ïÏßÄ), ‚Üê/‚Üí(5Ï¥à Ïù¥Îèô)</p>
                <p>3. <b>ÏòÅÏÉÅ Ï°∞Ïûë</b>: ÏùºÏãúÏ†ïÏßÄ ÌõÑ 'ÏÜêÍ∞ÄÎùΩ ÏïÑÏù¥ÏΩò'ÏùÑ ÎàÑÎ•¥Î©¥ Ïú†ÌäúÎ∏å X Î≤ÑÌäºÏùÑ ÏßÅÏ†ë ÎÅå Ïàò ÏûàÏäµÎãàÎã§.</p>
            </div>
            <div id="m-shortcuts" class="m-content"><div id="shortcut-list"></div><button onclick="saveShortcuts()" style="margin-top:15px; padding:10px; background:var(--accent); color:white; border:none; width:100%; border-radius:5px;">Ï†ÄÏû•</button></div>
        </div>
    </div>

    <script>
        // --- üöÄ Ï¥àÍ∏∞Ìôî Î∞è ÏãúÏä§ÌÖú ÌÜµÌï© ---
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof fabric !== 'undefined') {
                broadcastShadow = new fabric.Shadow({ color: 'rgba(0,0,0,0.8)', blur: 8, offsetX: 2, offsetY: 2 });
                canvas = new fabric.Canvas('c', { preserveObjectStacking: true });
                fabric.Object.prototype.set({ 
                    transparentCorners: false, 
                    cornerColor: '#fff', 
                    cornerStrokeColor: '#000', 
                    cornerStyle: 'circle', 
                    shadow: broadcastShadow 
                });

                canvas.on('mouse:move', o => { if(isDrawing && activeObj) { const p = canvas.getPointer(o.e); activeObj.set({ x2: p.x, y2: p.y }); canvas.renderAll(); }});
                canvas.on('mouse:up', o => {
                    if(isDrawing) {
                        isDrawing = false; const p = canvas.getPointer(o.e); canvas.remove(activeObj);
                        if(currentMode === 'drawArrow') {
                            const h = currentSize, a = Math.atan2(p.y-startPoint.y, p.x-startPoint.x)*180/Math.PI;
                            const l = Math.sqrt(Math.pow(p.x-startPoint.x,2)+Math.pow(p.y-startPoint.y,2));
                            const line = new fabric.Path(`M ${-l/2} 0 L ${l/2-h+5} 0`, { stroke:currentColor, strokeWidth:4, fill:'', originX:'center', originY:'center' });
                            const head = new fabric.Triangle({ width:h, height:h, fill:currentColor, angle:90, left:l/2, top:0, originX:'center', originY:'center' });
                            canvas.add(new fabric.Group([line, head], { left: (startPoint.x+p.x)/2, top: (startPoint.y+p.y)/2, angle: a, originX: 'center', originY: 'center', shadow: broadcastShadow }));
                        } else createCurvedArrow(startPoint, p);
                        setMode('select');
                    }
                });

                fabric.CurvedArrow = fabric.util.createClass(fabric.Object, {
                    type: 'curvedArrow', initialize: function(p0, p1, p2, options) { this.p0 = p0; this.p1 = p1; this.p2 = p2; this.callSuper('initialize', options); this.width = Math.abs(p2.x - p0.x) || 1; this.height = Math.abs(p2.y - p0.y) || 1; },
                    _render: function(ctx) { ctx.beginPath(); ctx.moveTo(this.p0.x-this.left-this.width/2, this.p0.y-this.top-this.height/2); ctx.quadraticCurveTo(this.p1.x-this.left-this.width/2, this.p1.y-this.top-this.height/2, this.p2.x-this.left-this.width/2, this.p2.y-this.top-this.height/2); ctx.strokeStyle = this.stroke; ctx.lineWidth = this.strokeWidth; ctx.stroke(); }
                });
            }

            // Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
            const vIn = document.getElementById('videoInput'); if(vIn) vIn.onchange = (e) => { const file = e.target.files[0]; if(!file) return; switchMode('local'); const v = document.getElementById('local-video'); v.src = URL.createObjectURL(file); v.load(); };
            const dIn = document.getElementById('dataInput'); if(dIn) dIn.onchange = (e) => { const file = e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload = (d) => { parseSportsCodeXML(d.target.result); openTab('tab-data'); }; r.readAsText(file); };
            
            setTimeout(resizeCanvas, 500);
            initShortcuts();
            updateTimelineUI();
        });

        function updateTimelineUI() {
            if (!isDraggingSlider) {
                let cur = 0, dur = 0;
                const localVid = document.getElementById('local-video');
                if (currentMediaType === 'local' && localVid && localVid.duration) { cur = localVid.currentTime; dur = localVid.duration; }
                else if (currentMediaType === 'youtube' && isYtReady && ytPlayer && ytPlayer.getDuration) { cur = ytPlayer.getCurrentTime(); dur = ytPlayer.getDuration(); }
                if (dur > 0) { timeSlider.value = (cur / dur) * 100; timeDisplay.innerText = `${formatTime(cur)} / ${formatTime(dur)}`; }
            }
            requestAnimationFrame(updateTimelineUI);
        }

        function onYouTubeIframeAPIReady() { 
            ytPlayer = new YT.Player('youtube-player', { 
                height:'100%', width:'100%', 
                playerVars:{'rel':0, 'controls':0, 'disablekb':1, 'iv_load_policy':3}, 
                events: { 'onReady': () => { isYtReady = true; } } 
            }); 
        }

        function setMode(mode){
            if (isVideoInteractive) toggleVideoInteraction();
            currentMode = mode;
            document.querySelectorAll('.sidebar .tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+mode)?.classList.add('active');
            if(canvas) {
                canvas.isDrawingMode = (mode === 'drawPen');
                if(canvas.isDrawingMode) {
                    canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                    canvas.freeDrawingBrush.color = currentColor; canvas.freeDrawingBrush.width = currentSize/4;
                }
            }
            document.getElementById('guide-msg').style.display = (mode === 'drawPolyline' || mode === 'drawPolygon') ? 'block' : 'none';
            resetDrawing();
        }

        function renderCompList() {
            const container = document.getElementById('match-list-container');
            if(!container) return;
            container.innerHTML = ''; 
            const nav = document.getElementById('list-nav'); if(nav) nav.style.display = 'none';
            const comps = [...new Set(githubMatchesData.map(m => m.competition || "Í∏∞ÌÉÄ"))];
            comps.forEach(comp => {
                const card = document.createElement('div'); card.className = 'comp-card';
                card.innerHTML = `<i class="fa-solid fa-folder-open" style="color:var(--accent);"></i> <span>${comp}</span>`;
                card.onclick = () => renderMatchList(comp); container.appendChild(card);
            });
        }

        function renderMatchList(comp) {
            const container = document.getElementById('match-list-container');
            if(!container) return;
            container.innerHTML = ''; 
            const nav = document.getElementById('list-nav'); if(nav) nav.style.display = 'block';
            githubMatchesData.filter(m => (m.competition || "Í∏∞ÌÉÄ") === comp).forEach(match => {
                const card = document.createElement('div'); card.className = 'match-card';
                card.innerHTML = `<span>${match.title}</span> <i class="fa-solid fa-play" style="color:var(--accent);"></i>`;
                card.onclick = () => selectMatch(match); container.appendChild(card);
            });
        }

        async function uploadMatchToGitHub() {
            saveAdminConfig();
            const token = document.getElementById('gh-token').value;
            const owner = document.getElementById('gh-owner').value;
            const repo = document.getElementById('gh-repo').value;
            const comp = document.getElementById('match-competition').value.trim();
            const title = document.getElementById('match-title').value.trim();
            const video = document.getElementById('match-video').value.trim();
            const xmlFile = document.getElementById('match-xml-file').files[0];
            const status = document.getElementById('upload-status');
            if (!token || !owner || !repo || !comp || !title || !video || !xmlFile) { alert("Ìï≠Î™©ÏùÑ Î™®Îëê Ï±ÑÏõåÏ£ºÏÑ∏Ïöî."); return; }
            status.innerHTML = `ÏóÖÎ°úÎìú Ï§ë...`;
            try {
                const xmlBase64 = await new Promise(res => { const r = new FileReader(); r.onload = () => res(btoa(unescape(encodeURIComponent(r.result)))); r.readAsText(xmlFile); });
                const xmlPath = `data/${comp}/${title}.xml`;
                const upRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${xmlPath}`, {
                    method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Add data: ${title}`, content: xmlBase64 })
                });
                if (!upRes.ok) throw new Error("XML ÏóÖÎ°úÎìú Ïã§Ìå®");
                const manifestRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/matches.json`, { headers: { 'Authorization': `token ${token}` } });
                const jsonData = await manifestRes.json();
                const contentClean = jsonData.content.replace(/\s/g, "");
                const manifestText = decodeURIComponent(escape(window.atob(contentClean)));
                const manifestObj = JSON.parse(manifestText);
                manifestObj.matches.push({ title, competition: comp, video, data: `./${xmlPath}`, date: new Date().toISOString().split('T')[0] });
                const updatedJson = btoa(unescape(encodeURIComponent(JSON.stringify(manifestObj, null, 2))));
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/matches.json`, {
                    method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Update manifest`, content: updatedJson, sha: jsonData.sha })
                });
                status.innerHTML = `<span style="color:#2ecc71;">ÏÑ±Í≥µ!</span>`;
                setTimeout(() => { switchMatchTab('list'); loadGitHubManifest(); }, 1000);
            } catch (e) { status.innerHTML = `<span style="color:#e74c3c;">Ïò§Î•ò: ${e.message}</span>`; }
        }

        async function fetchExternalData(url) {
            const token = document.getElementById('gh-token').value;
            const finalUrl = getDirectLink(url);
            const headers = {}; if (token && finalUrl.includes("raw.githubusercontent.com")) headers['Authorization'] = `token ${token}`;
            try {
                const response = await fetch(finalUrl, { headers });
                if (response.ok) { const text = await response.text(); if (!text.includes("<html") && !text.trim().startsWith("<!doctype")) return text; }
                const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(finalUrl);
                const proxyRes = await fetch(proxyUrl); return await proxyRes.text();
            } catch (e) { throw new Error("Î°úÎìú Ïã§Ìå®"); }
        }

        function parseSportsCodeXML(text) {
            const parser = new DOMParser(); const xmlDoc = parser.parseFromString(text, "text/xml");
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) return;
            const instances = xmlDoc.getElementsByTagName("instance"); eventList = [];
            for (let i = 0; i < instances.length; i++) {
                const inst = instances[i];
                const start = parseFloat(inst.getElementsByTagName("start")[0]?.textContent || 0);
                const code = inst.getElementsByTagName("code")[0]?.textContent || "Event";
                const labels = inst.getElementsByTagName("label");
                let labelText = labels.length > 0 ? labels[0].getElementsByTagName("text")[0]?.textContent || "" : "";
                eventList.push({ start, code, label: labelText });
            }
            renderDataList();
        }

        function renderDataList() {
            const unit = document.getElementById('timeUnit').value;
            const listEl = document.getElementById('dataList'); if(!listEl) return; listEl.innerHTML = '';
            if (!eventList.length) return;
            const grouped = {};
            eventList.forEach(ev => { if (!grouped[ev.code]) grouped[ev.code] = []; grouped[ev.code].push(ev); });
            for (const [code, items] of Object.entries(grouped)) {
                const group = document.createElement('div'); group.className = 'data-group';
                const header = document.createElement('div'); header.className = 'data-group-header';
                header.innerHTML = `<i class="fa-solid fa-chevron-right group-toggle-icon"></i><span>${code}</span><span class="group-count">${items.length}</span>`;
                const content = document.createElement('div'); content.className = 'data-group-content';
                header.onclick = () => {
                    const isHidden = content.style.display === 'none' || content.style.display === '';
                    content.style.display = isHidden ? 'flex' : 'none';
                    header.querySelector('.group-toggle-icon').className = isHidden ? 'fa-solid fa-chevron-down group-toggle-icon' : 'fa-solid fa-chevron-right group-toggle-icon';
                };
                items.forEach(it => {
                    const item = document.createElement('div'); item.className = 'data-item';
                    let t = it.start; if(unit === 'ms') t /= 1000;
                    item.innerHTML = `<span>${it.label || '-'}</span><span class="scene-time">${formatTime(t)}</span>`;
                    item.onclick = () => jumpToTime(t); content.appendChild(item);
                });
                group.appendChild(header); group.appendChild(content); listEl.appendChild(group);
            }
        }

        function switchMatchTab(t) {
            const listTab = document.getElementById('m-tab-list'); if(listTab) listTab.className = 'm-tab' + (t==='list'?' active':'');
            const adminTab = document.getElementById('m-tab-admin'); if(adminTab) adminTab.className = 'm-tab' + (t==='admin'?' active':'');
            const listView = document.getElementById('match-view-list'); if(listView) listView.className = 'm-content' + (t==='list'?' active':'');
            const adminView = document.getElementById('match-view-admin'); if(adminView) adminView.className = 'm-content' + (t==='admin'?' active':'');
        }

        function startCleanRecording() { alert("Ï∂îÏ∂ú Í∏∞Îä•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä Ï∫°Ï≤ò Í∂åÌïúÏùÑ ÌóàÏö©ÌïòÏÑ∏Ïöî."); }
        function saveShortcuts() { alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."); toggleHelp(); }
        function deleteObject() { if(!canvas) return; const active = canvas.getActiveObjects(); if(active.length) { canvas.discardActiveObject(); active.forEach(o => canvas.remove(o)); } }
        function clearAll() { if(!canvas) return; if(confirm("Î™®Îëê ÏÇ≠Ï†úÌï†ÍπåÏöî?")) canvas.clear(); }
        function resetDrawing() { pointArray=[]; activePoints=[]; activeLines=[]; componentArray=[]; isDrawing=false; document.getElementById('btn-finish').classList.remove('show'); }
        function saveScene() {
            if(!canvas) return;
            const art = JSON.stringify(canvas.toJSON());
            let t = 0; if(currentMediaType==='local') t=document.getElementById('local-video').currentTime; else if(isYtReady) t=ytPlayer.getCurrentTime();
            const item = document.createElement('div'); item.className='scene-item';
            item.innerHTML=`<div class="scene-info"><span>Scene ${document.getElementById('sceneList').children.length+1}</span><span class="scene-time">${formatTime(t)}</span></div><button class="scene-del-btn" onclick="this.parentElement.remove()">√ó</button>`;
            item.onclick=(e)=>{ if(e.target.tagName!=='BUTTON') canvas.loadFromJSON(art, canvas.renderAll.bind(canvas)); };
            document.getElementById('sceneList').appendChild(item);
        }
        function createCurvedArrow(s, e) { const mid = { x: (s.x+e.x)/2, y: (s.y+e.y)/2-50 }; canvas.add(new fabric.CurvedArrow(s, mid, e, { stroke: currentColor, strokeWidth: 4, headSize: currentSize })); }
        function loadAdminConfig() { const saved = localStorage.getItem('gh_admin_config'); if (saved) { const cfg = JSON.parse(saved); if(cfg.token) document.getElementById('gh-token').value = cfg.token; if(cfg.owner) document.getElementById('gh-owner').value = cfg.owner; if(cfg.repo) document.getElementById('gh-repo').value = cfg.repo; } }
        function saveAdminConfig() { const cfg = { token: document.getElementById('gh-token').value, owner: document.getElementById('gh-owner').value, repo: document.getElementById('gh-repo').value }; localStorage.setItem('gh_admin_config', JSON.stringify(cfg)); }
        function setColor(hex, el) { currentColor = hex; document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('selected')); el.classList.add('selected'); if(canvas && canvas.isDrawingMode) canvas.freeDrawingBrush.color = hex; }
        function toggleLang() { }
        function openTab(id) { document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function toggleSceneSidebar() { document.getElementById('sceneSidebar').classList.toggle('closed'); document.getElementById('sceneToggleIcon').className = document.getElementById('sceneSidebar').classList.contains('closed') ? 'fa-solid fa-chevron-left' : 'fa-solid fa-chevron-right'; setTimeout(resizeCanvas, 350); }
        function initShortcuts() {
            const list = document.getElementById('shortcut-list'); if(!list) return; list.innerHTML = '';
            for (const [id, cfg] of Object.entries(shortcutConfig)) {
                const row = document.createElement('div'); row.className = 'shortcut-row';
                row.innerHTML = `<span>${cfg.label}</span><input type="text" class="shortcut-input" value="${cfg.key===' '?'Space':cfg.key}" readonly onclick="this.value='...'">`;
                const input = row.querySelector('input');
                input.onkeydown = (e) => { e.preventDefault(); cfg.key = e.key; input.value = e.key===' '?'Space':e.key; };
                list.appendChild(row);
            }
        }
        let shortcutConfig = { 'select': { label: 'ÏÑ†ÌÉù', key: 's' }, 'drawPen': { label: 'Ìéú', key: 'p' }, 'drawArrow': { label: 'ÌôîÏÇ¥Ìëú', key: 'a' }, 'drawSpot': { label: 'Ïä§Ìåü', key: 'h' }, 'deleteObj': { label: 'ÏÇ≠Ï†ú', key: 'Delete' }, 'videoToggle': { label: 'Ïû¨ÏÉù', key: ' ' } };
        window.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.isContentEditable) return;
            const key = e.key;
            if (key === shortcutConfig.select.key) setMode('select');
            else if (key === shortcutConfig.drawPen.key) setMode('drawPen');
            else if (key === shortcutConfig.drawArrow.key) setMode('drawArrow');
            else if (key === shortcutConfig.drawSpot.key) setMode('drawSpot');
            else if (key === shortcutConfig.deleteObj.key) deleteObject();
            else if (key === ' ' || key === shortcutConfig.videoToggle.key) { e.preventDefault(); videoControl('toggle'); }
            else if (key === 'ArrowLeft') { e.preventDefault(); videoControl('rewind'); }
            else if (key === 'ArrowRight') { e.preventDefault(); videoControl('forward'); }
        });
        function addText() { if(!canvas) return; const t = new fabric.IText('ÌÖçÏä§Ìä∏', { left: canvas.width/2, top: canvas.height/2, fill: currentColor, fontFamily: 'S-CoreDream-6Bold', fontSize: 30 }); canvas.add(t); canvas.setActiveObject(t); }
    </script>
</body>
</html>
